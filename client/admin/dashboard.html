<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - KemDataplus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        /* Hide main content initially to prevent flash */
        .main-content { opacity: 0; transition: opacity 0.15s; }
        .main-content.ready { opacity: 1; }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: #1a1f36;
            z-index: 1000;
        }
        .sidebar-logo {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-box {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1f36;
            font-size: 0.9rem;
        }
        .logo-text {
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }
        .menu-label {
            padding: 20px 20px 10px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .nav-menu {
            list-style: none;
        }
        .nav-item {
            margin: 4px 12px;
        }
        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .nav-link.active {
            background: #3b82f6;
            color: white;
        }
        .nav-link i {
            width: 20px;
            text-align: center;
        }
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .logout-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 240px;
            min-height: 100vh;
        }

        /* ===== TOP HEADER ===== */
        .top-header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .greeting h1 {
            font-size: 1.25rem;
            color: #1a1f36;
            font-weight: 600;
        }
        .greeting p {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 2px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }
        .header-stat {
            text-align: right;
        }
        .header-stat .label {
            font-size: 0.75rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: flex-end;
        }
        .header-stat .value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a1f36;
        }
        .header-stat .value.profit {
            color: #10b981;
        }
        .admin-avatar {
            width: 40px;
            height: 40px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* ===== PAGE CONTENT ===== */
        .page-content {
            padding: 25px 30px;
        }
        .page-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .page-title i {
            color: #3b82f6;
            font-size: 1.2rem;
        }
        .page-title h2 {
            font-size: 1.3rem;
            color: #1a1f36;
        }

        /* ===== MAIN STATS CARDS ===== */
        .main-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .stat-card .info h4 {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .stat-card .info .value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #1a1f36;
        }
        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .stat-card.wallet .icon { background: #dbeafe; color: #3b82f6; }
        .stat-card.orders .icon { background: #fef3c7; color: #f59e0b; }
        .stat-card.amount .icon { background: #d1fae5; color: #10b981; }
        .stat-card.bundle .icon { background: #fee2e2; color: #ef4444; }

        /* ===== ORDER STATUS CARDS ===== */
        .status-cards {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .status-card {
            background: white;
            padding: 18px;
            border-radius: 10px;
            border-left: 4px solid;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .status-card.pending { border-color: #f59e0b; }
        .status-card.processing { border-color: #3b82f6; }
        .status-card.completed { border-color: #10b981; }
        .status-card.cancelled { border-color: #ef4444; }
        .status-card.all { border-color: #8b5cf6; }
        
        .status-card h4 {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .status-card.pending h4 { color: #f59e0b; }
        .status-card.processing h4 { color: #3b82f6; }
        .status-card.completed h4 { color: #10b981; }
        .status-card.cancelled h4 { color: #ef4444; }
        .status-card.all h4 { color: #8b5cf6; }
        
        .status-card .count {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .status-card .details {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .status-card .details span {
            display: block;
            margin-bottom: 3px;
        }
        .status-card .details strong {
            color: #374151;
        }

        /* ===== NETWORK TABS ===== */
        .network-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .network-tab {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .network-tab:hover {
            border-color: #3b82f6;
        }
        .network-tab.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        .network-tab.mtn { color: #f59e0b; border-color: #f59e0b; }
        .network-tab.telecel { color: #ef4444; border-color: #ef4444; }
        .network-tab.at { color: #3b82f6; border-color: #3b82f6; }
        .network-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .network-tab .pending-count {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            margin-left: 6px;
        }
        .network-tab .pending-count:empty {
            display: none;
        }

        /* ===== FILTER OPTIONS PANEL ===== */
        .filter-options-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .filter-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        .filter-header h4 {
            font-size: 0.95rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .filter-header h4 i {
            color: #6b7280;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            transition: border-color 0.2s;
        }
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .filter-group input::placeholder {
            color: #9ca3af;
        }
        
        /* Network Filter Buttons */
        .network-filter-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .network-filter-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: 2px solid;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .network-filter-btn i {
            font-size: 0.6rem;
        }
        .network-filter-btn .pending-badge {
            background: rgba(0,0,0,0.1);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .network-filter-btn.mtn {
            color: #f59e0b;
            border-color: #fcd34d;
        }
        .network-filter-btn.mtn i { color: #f59e0b; }
        .network-filter-btn.mtn:hover,
        .network-filter-btn.mtn.active {
            background: #fef3c7;
        }
        .network-filter-btn.telecel {
            color: #ef4444;
            border-color: #fca5a5;
        }
        .network-filter-btn.telecel i { color: #ef4444; }
        .network-filter-btn.telecel:hover,
        .network-filter-btn.telecel.active {
            background: #fee2e2;
        }
        .network-filter-btn.airteltigo {
            color: #3b82f6;
            border-color: #93c5fd;
        }
        .network-filter-btn.airteltigo i { color: #3b82f6; }
        .network-filter-btn.airteltigo:hover,
        .network-filter-btn.airteltigo.active {
            background: #dbeafe;
        }
        
        /* Filter Actions */
        .filter-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .btn-action {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-complete {
            background: #10b981;
            color: white;
        }
        .btn-complete:hover {
            background: #059669;
        }
        .btn-cancel {
            background: #ef4444;
            color: white;
        }
        .btn-cancel:hover {
            background: #dc2626;
        }

        /* ===== DATA TABLE ===== */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background: #f8fafc;
            padding: 14px 12px;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .data-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
            color: #334155;
        }
        .data-table tr:hover {
            background: #f8fafc;
        }
        .data-table .agent-name {
            color: #3b82f6;
            font-weight: 500;
        }
        .data-table .order-id {
            font-weight: 600;
            color: #1a1f36;
        }
        
        /* Badges */
        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .badge-completed { background: #d1fae5; color: #065f46; }
        .badge-processing { background: #dbeafe; color: #1e40af; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-cancelled { background: #fee2e2; color: #991b1b; }
        
        /* Action Icons */
        .action-icons {
            display: flex;
            gap: 6px;
        }
        .action-icon {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .action-icon:hover {
            transform: scale(1.1);
        }
        .action-icon.cancel { background: #fee2e2; color: #ef4444; }
        .action-icon.complete { background: #d1fae5; color: #10b981; }
        .action-icon.view { background: #dbeafe; color: #3b82f6; }
        
        /* Checkbox */
        .data-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #d1d5db;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1400px) {
            .status-cards { grid-template-columns: repeat(3, 1fr); }
            .filter-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 1200px) {
            .main-stats { grid-template-columns: repeat(2, 1fr); }
            .status-cards { grid-template-columns: repeat(2, 1fr); }
            .filter-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .logo-text, .menu-label, .nav-link span { display: none; }
            .main-content { margin-left: 70px; }
            .nav-link { justify-content: center; }
            .main-stats { grid-template-columns: 1fr; }
            .status-cards { grid-template-columns: 1fr; }
            .filter-grid { grid-template-columns: 1fr 1fr; }
            .header-stat { display: none; }
            .network-tabs { gap: 8px; }
            .network-tab { padding: 8px 12px; font-size: 0.8rem; }
            .action-bar { flex-wrap: wrap; }
            .btn-action { padding: 10px 16px; font-size: 0.85rem; }
            .table-container { overflow-x: auto; }
            .data-table { min-width: 900px; }
        }

        /* ===== WALLET MANAGEMENT ===== */
        .wallet-section {
            display: none;
        }
        .wallet-section.active {
            display: block;
        }
        .wallet-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .wallet-stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .wallet-stat-card h4 {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .wallet-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        .wallet-stat-card.total-balance .value { color: #10b981; }
        .wallet-stat-card.pending-topups .value { color: #f59e0b; }
        .wallet-stat-card.today-credits .value { color: #3b82f6; }
        .wallet-stat-card.today-debits .value { color: #ef4444; }
        
        /* Wallet Tabs */
        .wallet-main-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 25px;
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 0 10px;
        }
        .wallet-main-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .wallet-main-tab:hover {
            color: #024959;
        }
        .wallet-main-tab.active {
            color: #024959;
        }
        .wallet-main-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #024959, #F2C12E);
            border-radius: 2px 2px 0 0;
        }
        .wallet-main-tab .badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
        }
        .wallet-tab-content {
            display: none;
        }
        .wallet-tab-content.active {
            display: block;
        }
        
        /* All Transactions Table */
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .transactions-table th,
        .transactions-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        .transactions-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #6b7280;
            font-size: 0.85rem;
        }
        .transactions-table tr:hover {
            background: #f9fafb;
        }
        .txn-type-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .txn-type-badge.credit {
            background: #d1fae5;
            color: #10b981;
        }
        .txn-type-badge.debit {
            background: #fee2e2;
            color: #ef4444;
        }
        .txn-amount {
            font-weight: 700;
        }
        .txn-amount.credit { color: #10b981; }
        .txn-amount.debit { color: #ef4444; }
        
        /* Claims Section */
        .claims-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px;
        }
        .claim-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .claim-card:hover {
            border-color: #f59e0b;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
        }
        .claim-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .claim-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .claim-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #024959, #F2C12E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        .claim-user-name {
            font-weight: 600;
            color: #1f2937;
        }
        .claim-user-phone {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .claim-amount-large {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f59e0b;
        }
        .claim-details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .claim-detail-item {
            font-size: 0.85rem;
        }
        .claim-detail-item .label {
            color: #6b7280;
            margin-bottom: 3px;
        }
        .claim-detail-item .value {
            font-weight: 600;
            color: #1f2937;
            word-break: break-all;
        }
        .claim-actions {
            display: flex;
            gap: 10px;
        }
        .claim-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .claim-btn.approve {
            background: #10b981;
            color: white;
        }
        .claim-btn.approve:hover {
            background: #059669;
        }
        .claim-btn.reject {
            background: #ef4444;
            color: white;
        }
        .claim-btn.reject:hover {
            background: #dc2626;
        }
        .no-claims {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        .no-claims i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #d1d5db;
        }
        
        .wallet-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 25px;
        }
        .wallet-users-section, .wallet-topup-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        .section-header h3 {
            font-size: 1.1rem;
            color: #1f2937;
        }
        .search-box {
            display: flex;
            gap: 10px;
        }
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 200px;
        }
        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* User Wallet Table */
        .user-wallet-table {
            width: 100%;
            border-collapse: collapse;
        }
        .user-wallet-table th,
        .user-wallet-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        .user-wallet-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #6b7280;
            font-size: 0.85rem;
        }
        .user-wallet-table tr:hover {
            background: #f9fafb;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #024959, #F2C12E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .user-name {
            font-weight: 600;
            color: #1f2937;
        }
        .user-phone {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .balance-amount {
            font-weight: 700;
            color: #10b981;
        }
        .balance-amount.low {
            color: #ef4444;
        }
        .wallet-actions {
            display: flex;
            gap: 6px;
        }
        .wallet-action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .wallet-action-btn.fund {
            background: #d1fae5;
            color: #10b981;
        }
        .wallet-action-btn.debit {
            background: #fee2e2;
            color: #ef4444;
        }
        .wallet-action-btn:hover {
            transform: scale(1.05);
        }
        
        /* Top-up Form */
        .topup-form {
            margin-top: 15px;
        }
        .topup-form .form-group {
            margin-bottom: 15px;
        }
        .topup-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        .topup-form input,
        .topup-form select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        .topup-form input:focus,
        .topup-form select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .topup-form .btn-fund {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .topup-form .btn-fund:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        /* Pending Top-ups */
        .pending-topups-list {
            margin-top: 20px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }
        .pending-topups-list h4 {
            font-size: 0.95rem;
            color: #1f2937;
            margin-bottom: 15px;
        }
        .pending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #fffbeb;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #f59e0b;
        }
        .pending-item .info {
            flex: 1;
        }
        .pending-item .name {
            font-weight: 600;
            color: #1f2937;
        }
        .pending-item .details {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .pending-item .amount {
            font-weight: 700;
            color: #f59e0b;
            margin-right: 15px;
        }
        .pending-item .actions {
            display: flex;
            gap: 8px;
        }
        .pending-item .btn-approve {
            padding: 6px 12px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .pending-item .btn-reject {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Transaction History Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h3 {
            font-size: 1.1rem;
            color: #1f2937;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        .transaction-icon.credit {
            background: #d1fae5;
            color: #10b981;
        }
        .transaction-icon.debit {
            background: #fee2e2;
            color: #ef4444;
        }
        .transaction-info {
            flex: 1;
        }
        .transaction-desc {
            font-weight: 600;
            color: #1f2937;
        }
        .transaction-date {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .transaction-amount {
            font-weight: 700;
        }
        .transaction-amount.credit {
            color: #10b981;
        }
        .transaction-amount.debit {
            color: #ef4444;
        }

        @media (max-width: 1200px) {
            .wallet-stats { grid-template-columns: repeat(2, 1fr); }
            .wallet-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .wallet-stats { grid-template-columns: 1fr; }
        }

        /* ========== INCOMING PAYMENTS (MBS STYLE) ========== */
        .incoming-payments-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
        }
        
        /* Search Filters Row */
        .payments-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .payments-filters input,
        .payments-filters select {
            padding: 9px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
        }
        .payments-filters input {
            width: 180px;
        }
        .payments-filters input:focus,
        .payments-filters select:focus {
            outline: none;
            border-color: #024959;
        }
        .btn-add-payment {
            background: #024959;
            color: white;
            border: none;
            padding: 9px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            transition: all 0.2s;
        }
        .btn-add-payment:hover {
            background: #036b7f;
        }
        
        /* Yellow Stats Cards */
        .payments-stats-yellow {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .yellow-stat-card {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .yellow-stat-card .stat-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }
        .yellow-stat-card .stat-content h4 {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            margin-bottom: 5px;
        }
        .yellow-stat-card .stat-content .value {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }
        
        /* Dark Count Cards */
        .payments-stats-dark {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .dark-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .dark-stat-card .stat-icon {
            width: 50px;
            height: 50px;
            background: #1f2937;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }
        .dark-stat-card .stat-content h4 {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .dark-stat-card .stat-content .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        /* Payments Table */
        .payments-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .payments-table {
            width: 100%;
            border-collapse: collapse;
        }
        .payments-table thead {
            background: #1f2937;
        }
        .payments-table th {
            padding: 14px 12px;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .payments-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
            color: #374151;
        }
        .payments-table tr:hover {
            background: #f9fafb;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }
        .status-badge.claimed {
            background: #d1fae5;
            color: #059669;
        }
        .status-badge.unclaimed {
            background: #e5e7eb;
            color: #6b7280;
        }
        .raw-payload {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .payments-table-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #e5e7eb;
        }
        .payments-table-footer label {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .payments-table-footer select {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .claim-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .claim-action-btn.credit {
            background: #10b981;
            color: white;
        }
        .claim-action-btn.credit:hover {
            background: #059669;
        }
        .claim-action-btn.reject {
            background: #ef4444;
            color: white;
        }
        .claim-action-btn.reject:hover {
            background: #dc2626;
        }
        
        /* Add Payment Modal */
        .add-payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .add-payment-modal.active {
            display: flex;
        }
        .add-payment-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .add-payment-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .add-payment-header h3 {
            font-size: 1.1rem;
            color: #1f2937;
        }
        .add-payment-body {
            padding: 20px;
        }
        .add-payment-body .form-group {
            margin-bottom: 15px;
        }
        .add-payment-body .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        .add-payment-body .form-group input,
        .add-payment-body .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .add-payment-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        @media (max-width: 1200px) {
            .payments-filters { grid-template-columns: repeat(2, 1fr); }
            .payments-stats-yellow { grid-template-columns: repeat(2, 1fr); }
            .payments-stats-dark { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .payments-filters { grid-template-columns: 1fr; }
            .payments-filters-row2 { grid-template-columns: 1fr; }
            .payments-stats-yellow { grid-template-columns: 1fr; }
            .payments-stats-dark { grid-template-columns: 1fr; }
            .payments-table { font-size: 0.8rem; }
            .payments-table th, .payments-table td { padding: 10px 8px; }
        }

        /* ========== USERS MANAGEMENT SECTION ========== */
        .users-section {
            display: none;
            padding: 25px;
        }
        .users-section.active {
            display: block;
        }
        
        /* Users Stats Row */
        .users-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .users-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .users-stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .users-stat-card.total .icon { background: #dbeafe; color: #3b82f6; }
        .users-stat-card.active .icon { background: #d1fae5; color: #10b981; }
        .users-stat-card.new .icon { background: #fef3c7; color: #f59e0b; }
        .users-stat-card.balance .icon { background: #e0e7ff; color: #6366f1; }
        .users-stat-card h4 {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .users-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        /* Users Table Container */
        .users-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .users-table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .users-table-header h3 {
            font-size: 1.1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .users-search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .users-search-filters input,
        .users-search-filters select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .users-search-filters input { width: 220px; }
        .btn-add-user {
            background: #024959;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-add-user:hover {
            background: #036b7f;
        }
        
        /* Users Table */
        .users-table {
            width: 100%;
            border-collapse: collapse;
        }
        .users-table th {
            background: #f9fafb;
            padding: 14px 15px;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .users-table td {
            padding: 14px 15px;
            border-bottom: 1px solid #f3f4f6;
        }
        .users-table tr:hover {
            background: #f9fafb;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-profile .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #024959, #F2C12E);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .user-profile .info .name {
            font-weight: 600;
            color: #1f2937;
        }
        .user-profile .info .email {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .user-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .user-status.active {
            background: #d1fae5;
            color: #059669;
        }
        .user-status.inactive {
            background: #fee2e2;
            color: #dc2626;
        }
        .user-status.pending {
            background: #fef3c7;
            color: #d97706;
        }
        .user-status.suspended {
            background: #fecaca;
            color: #b91c1c;
        }
        /* User Role Badges */
        .user-role {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .user-role.agent {
            background: #e0e7ff;
            color: #4338ca;
        }
        .user-role.super-agent {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .user-role.dealer {
            background: #fef3c7;
            color: #b45309;
        }
        .user-role.super-dealer {
            background: #fce7f3;
            color: #be185d;
        }
        .user-actions {
            display: flex;
            gap: 8px;
        }
        .user-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .user-action-btn.view { background: #dbeafe; color: #3b82f6; }
        .user-action-btn.edit { background: #fef3c7; color: #f59e0b; }
        .user-action-btn.role { background: #e0e7ff; color: #6366f1; }
        .user-action-btn.fund { background: #d1fae5; color: #10b981; }
        .user-action-btn.delete { background: #fee2e2; color: #ef4444; }
        .user-action-btn:hover { transform: scale(1.1); }
        
        /* User Modal */
        .user-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .user-modal.active {
            display: flex;
        }
        .user-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .user-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-modal-header h3 {
            font-size: 1.1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-modal-body {
            padding: 20px;
        }
        .user-modal-body .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .user-modal-body .form-group {
            margin-bottom: 15px;
        }
        .user-modal-body .form-group.full {
            grid-column: 1 / -1;
        }
        .user-modal-body label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }
        .user-modal-body input,
        .user-modal-body select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        .user-modal-body input:focus,
        .user-modal-body select:focus {
            outline: none;
            border-color: #024959;
        }
        .user-modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-modal.cancel {
            background: #e5e7eb;
            color: #4b5563;
        }
        .btn-modal.save {
            background: #024959;
            color: white;
        }
        .btn-modal:hover {
            opacity: 0.9;
        }
        
        /* User Detail View */
        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .user-detail-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
        }
        .user-detail-card h4 {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .user-detail-card .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }
        .user-detail-card.full {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 1200px) {
            .users-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .users-stats { grid-template-columns: 1fr; }
            .users-table-header { flex-direction: column; align-items: flex-start; }
            .users-search-filters { width: 100%; }
            .users-search-filters input { width: 100%; }
            .user-modal-body .form-row { grid-template-columns: 1fr; }
        }

        /* Users Controls */
        .users-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .users-controls .search-box {
            display: flex;
            align-items: center;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0 12px;
        }
        .users-controls .search-box i {
            color: #9ca3af;
        }
        .users-controls .search-box input {
            border: none;
            background: transparent;
            padding: 10px;
            width: 200px;
            outline: none;
        }
        .users-controls select {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        
        /* User Modal Form Styles */
        .modal-content .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .modal-content .form-group {
            margin-bottom: 15px;
        }
        .modal-content .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        .modal-content .form-group input,
        .modal-content .form-group select,
        .modal-content .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        .modal-content .form-group input:focus,
        .modal-content .form-group select:focus,
        .modal-content .form-group textarea:focus {
            outline: none;
            border-color: #024959;
        }
        .modal-content .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        .modal-content .btn-cancel {
            padding: 10px 20px;
            background: #e5e7eb;
            color: #4b5563;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-content .btn-save {
            padding: 10px 20px;
            background: #024959;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-content .btn-cancel:hover,
        .modal-content .btn-save:hover {
            opacity: 0.9;
        }
        
        /* Users stat card icon fix */
        .users-stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .users-stat-card .stat-icon.total { background: #dbeafe; color: #3b82f6; }
        .users-stat-card .stat-icon.active { background: #d1fae5; color: #10b981; }
        .users-stat-card .stat-icon.new { background: #fef3c7; color: #f59e0b; }
        .users-stat-card .stat-icon.balance { background: #e0e7ff; color: #6366f1; }
        
        .users-stat-card .stat-info h4 {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .users-stat-card .stat-info .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        /* ========== HISTORY SECTION ========== */
        .history-section {
            display: none;
            padding: 25px;
        }
        .history-section.active {
            display: block;
        }
        /* History Section Header */
        .history-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding: 15px 20px;
            background: #024959;
            border-radius: 10px;
            color: white;
        }
        .history-section-header .header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .history-section-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }
        /* History Stats Cards */
        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .history-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-stat-card .stat-info h4 {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 5px;
        }
        .history-stat-card .stat-info .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }
        .history-stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .history-stat-card .stat-icon.orders { background: #dbeafe; color: #3b82f6; }
        .history-stat-card .stat-icon.amount { background: #fef3c7; color: #f59e0b; }
        .history-stat-card .stat-icon.bundle { background: #fee2e2; color: #ef4444; }
        /* Filter Options Collapsible */
        .history-filter-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 25px;
            overflow: hidden;
        }
        .history-filter-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: #f9fafb;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            user-select: none;
        }
        .history-filter-header:hover {
            background: #f3f4f6;
        }
        .history-filter-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-filter-header .toggle-icon {
            margin-left: auto;
            color: #6b7280;
            transition: transform 0.2s;
        }
        .history-filter-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .history-filter-content {
            padding: 20px;
            display: block;
        }
        .history-filter-content.collapsed {
            display: none;
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-row:last-child {
            margin-bottom: 0;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
        }
        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 150px;
            background: white;
        }
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .filter-group input[type="date"] {
            min-width: 140px;
        }
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f3f4f6;
        }
        .btn-export-history {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-export-history:hover {
            background: #2563eb;
        }
        .btn-clear-filters {
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-clear-filters:hover {
            background: #f3f4f6;
        }
        /* History Table */
        .history-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        .history-table th {
            background: #024959;
            color: white;
            padding: 14px 15px;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        .history-table td {
            padding: 14px 15px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            font-size: 0.85rem;
        }
        .history-table tr:hover {
            background: #f9fafb;
        }
        .history-table tr:nth-child(even) {
            background: #fafbfc;
        }
        .history-table tr:nth-child(even):hover {
            background: #f3f4f6;
        }
        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-badge.completed { background: #dcfce7; color: #166534; }
        .status-badge.processing { background: #dbeafe; color: #1d4ed8; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.failed { background: #fee2e2; color: #b91c1c; }
        /* Action Buttons */
        .action-btns {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .action-btn.refund { background: #fee2e2; color: #dc2626; }
        .action-btn.refund:hover { background: #fecaca; }
        .action-btn.approve { background: #dcfce7; color: #16a34a; }
        .action-btn.approve:hover { background: #bbf7d0; }
        .action-btn.status-dot {
            width: 12px;
            height: 12px;
            background: #22c55e;
            cursor: default;
        }
        .history-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .history-empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            color: #d1d5db;
        }
        .history-empty-state h4 {
            font-size: 1.1rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        .history-empty-state p {
            font-size: 0.9rem;
        }
        /* Pagination */
        .history-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #f3f4f6;
            background: #f9fafb;
        }
        .history-pagination .per-page {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }
        .history-pagination .per-page select {
            padding: 6px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: white;
        }
        .network-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .network-badge.mtn { background: #fef3c7; color: #f59e0b; }
        .network-badge.vodafone { background: #fee2e2; color: #ef4444; }
        .network-badge.airteltigo { background: #dbeafe; color: #3b82f6; }
        @media (max-width: 1200px) {
            .history-stats { grid-template-columns: repeat(3, 1fr); }
            .filter-row { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group input,
            .filter-group select { width: 100%; }
        }
        @media (max-width: 768px) {
            .history-stats { grid-template-columns: 1fr; }
            .history-table { font-size: 0.8rem; }
            .history-table th, .history-table td { padding: 10px; }
        }

        /* ========== NETWORKS SECTION ========== */
        .networks-section {
            display: none;
            padding: 25px;
        }
        .networks-section.active {
            display: block;
        }
        
        /* Top Action Buttons */
        .networks-top-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }
        .btn-new-network, .btn-new-bundle {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-new-network:hover, .btn-new-bundle:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        /* Registered Networks Title */
        .networks-section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        /* Network Cards Grid */
        .networks-cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 35px;
        }
        .network-card-new {
            position: relative;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, #374151, #1f2937);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .network-card-new.mtn {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }
        .network-card-new.telecel {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }
        .network-card-new.airteltigo {
            background: linear-gradient(135deg, #4a5568, #2d3748);
        }
        .network-card-actions {
            position: absolute;
            top: 12px;
            left: 12px;
            display: flex;
            gap: 8px;
        }
        .network-card-actions button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .network-card-actions .edit-network {
            background: white;
            color: #10b981;
        }
        .network-card-actions .delete-network {
            background: white;
            color: #ef4444;
        }
        .network-card-actions button:hover {
            transform: scale(1.1);
        }
        .network-card-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        .network-toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
        }
        .network-toggle-switch .toggle-track {
            width: 40px;
            height: 22px;
            background: #6b7280;
            border-radius: 11px;
            position: relative;
            transition: all 0.3s;
        }
        .network-toggle-switch .toggle-track.active {
            background: #10b981;
        }
        .network-toggle-switch .toggle-thumb {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .network-toggle-switch .toggle-track.active .toggle-thumb {
            left: 20px;
        }
        .network-toggle-switch .toggle-label {
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .network-card-name {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Bundle Tariffs Section */
        .bundle-tariffs-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .bundle-tariffs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .bundle-tariffs-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }
        .bundle-tariffs-filter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bundle-tariffs-filter label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .bundle-tariffs-filter select {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            min-width: 180px;
        }
        
        /* Bundle Tariffs Table */
        .bundle-tariffs-table {
            width: 100%;
            border-collapse: collapse;
        }
        .bundle-tariffs-table th {
            background: #1f2937;
            color: white;
            padding: 14px 12px;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .bundle-tariffs-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
            color: #374151;
        }
        .bundle-tariffs-table tr:hover {
            background: #f9fafb;
        }
        .bundle-tariffs-table .network-name {
            font-weight: 600;
            color: #1f2937;
        }
        .bundle-status-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bundle-status-toggle .mini-toggle {
            width: 36px;
            height: 20px;
            background: #d1d5db;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .bundle-status-toggle .mini-toggle.active {
            background: #10b981;
        }
        .bundle-status-toggle .mini-toggle-thumb {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        .bundle-status-toggle .mini-toggle.active .mini-toggle-thumb {
            left: 18px;
        }
        .bundle-status-toggle .mini-toggle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .bundle-status-toggle .status-text {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .bundle-status-toggle .status-text.text-muted {
            opacity: 0.5;
        }
        .network-inactive-row {
            background: rgba(239, 68, 68, 0.05) !important;
        }
        .network-inactive-row:hover {
            background: rgba(239, 68, 68, 0.08) !important;
        }
        .network-badge-inactive {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #fef2f2;
            color: #ef4444;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }
        .out-of-stock-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .bundle-tariffs-table .action-btns {
            display: flex;
            gap: 8px;
        }
        .bundle-tariffs-table .action-btns button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .bundle-tariffs-table .btn-edit {
            background: #ecfdf5;
            color: #10b981;
        }
        .bundle-tariffs-table .btn-delete {
            background: #fef2f2;
            color: #ef4444;
        }
        .bundle-tariffs-table .action-btns button:hover {
            transform: scale(1.1);
        }
        
        @media (max-width: 1400px) {
            .networks-cards-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .networks-cards-grid { grid-template-columns: 1fr; }
            .bundle-tariffs-table { min-width: 900px; }
            .bundle-tariffs-section { overflow-x: auto; }
        }

        /* ========== REPORTS SECTION ========== */
        .reports-section {
            display: none;
            padding: 25px;
        }
        .reports-section.active {
            display: block;
        }
        /* Sales Report Header */
        .sales-report-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: #3b82f6;
            border-radius: 10px 10px 0 0;
            color: white;
        }
        .sales-report-header .header-icon {
            width: 35px;
            height: 35px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .sales-report-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }
        /* Sales Report Table */
        .sales-report-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 25px;
        }
        .sales-report-table {
            width: 100%;
            border-collapse: collapse;
        }
        .sales-report-table th {
            background: #1e3a5f;
            color: white;
            padding: 14px 15px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .sales-report-table th:nth-child(4),
        .sales-report-table th:nth-child(5),
        .sales-report-table th:nth-child(6) {
            background: #1a4971;
        }
        .sales-report-table td {
            padding: 14px 15px;
            font-size: 0.9rem;
        }
        .sales-report-table tr:nth-child(odd) td {
            background: #f0f7ff;
        }
        .sales-report-table tr:nth-child(even) td {
            background: white;
        }
        .sales-report-table tr:nth-child(odd) td:nth-child(4),
        .sales-report-table tr:nth-child(odd) td:nth-child(5),
        .sales-report-table tr:nth-child(odd) td:nth-child(6) {
            background: #1e3a5f;
            color: white;
        }
        .sales-report-table tr:nth-child(even) td:nth-child(4),
        .sales-report-table tr:nth-child(even) td:nth-child(5),
        .sales-report-table tr:nth-child(even) td:nth-child(6) {
            background: #2a4a6b;
            color: white;
        }
        .sales-report-table .profit-positive {
            color: #4ade80;
        }
        .sales-report-table .profit-negative {
            color: #f87171;
        }
        /* Report Summary Cards */
        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        .report-summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid;
        }
        .report-summary-card.orders { border-color: #3b82f6; }
        .report-summary-card.data { border-color: #10b981; }
        .report-summary-card.revenue { border-color: #f59e0b; }
        .report-summary-card.profit { border-color: #8b5cf6; }
        .report-summary-card h4 {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .report-summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
        }
        /* Report Tabs */
        .report-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            background: #f3f4f6;
            border-radius: 10px;
            padding: 5px;
            width: fit-content;
        }
        .report-tab {
            padding: 12px 30px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: #6b7280;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .report-tab:hover {
            color: #1f2937;
        }
        .report-tab.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .report-tab i {
            font-size: 1rem;
        }
        /* Report Views */
        .report-view {
            display: none;
        }
        .report-view.active {
            display: block;
        }
        /* Period Filter Buttons */
        .report-period-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .report-period-filter button {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .report-period-filter button:hover {
            background: #f3f4f6;
        }
        .report-period-filter button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        /* Empty State */
        .sales-report-empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .sales-report-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #d1d5db;
        }
        /* User Report Styles */
        .user-report-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 25px;
        }
        .user-report-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: #3b82f6;
            border-radius: 10px 10px 0 0;
            color: white;
        }
        .user-report-header .header-icon {
            width: 35px;
            height: 35px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .user-report-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }
        .user-report-date {
            padding: 12px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
            color: #6b7280;
        }
        .user-report-date span {
            color: #1f2937;
            font-weight: 500;
        }
        .user-report-table {
            width: 100%;
            border-collapse: collapse;
        }
        .user-report-table th {
            background: #1e3a5f;
            color: white;
            padding: 14px 15px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .user-report-table th:last-child {
            background: #111827;
        }
        .user-report-table td {
            padding: 14px 15px;
            font-size: 0.9rem;
        }
        .user-report-table tr:nth-child(odd) td {
            background: #f0f7ff;
        }
        .user-report-table tr:nth-child(even) td {
            background: white;
        }
        .user-report-table td:last-child {
            background: #111827 !important;
            color: white;
            font-weight: 500;
        }
        .user-report-table .user-name {
            color: #3b82f6;
            font-weight: 500;
        }
        .user-report-table .wallet-negative {
            color: #ef4444;
        }
        .user-report-table .wallet-positive {
            color: #10b981;
        }
        .user-report-empty {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        @media (max-width: 1200px) {
            .report-summary-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .report-summary-cards { grid-template-columns: 1fr; }
            .report-period-filter { flex-wrap: wrap; }
        }

        /* ========== SETTINGS SECTION ========== */
        .settings-section {
            display: none;
            padding: 0;
        }
        .settings-section.active {
            display: block;
        }
        /* Settings Header */
        .settings-header {
            background: #1e3a5f;
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .settings-header .header-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .settings-header h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }
        .settings-body {
            padding: 25px;
            background: #f5f7fa;
            min-height: calc(100vh - 80px);
        }
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .settings-section-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }
        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .settings-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        .settings-grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        .setting-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .setting-card-info h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        .setting-card-info p {
            font-size: 0.8rem;
            color: #6b7280;
        }
        /* Master Toggle */
        .master-toggle-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .master-toggle-label {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
        }
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #d1d5db;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch.active {
            background: #22c55e;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        /* Settings Container */
        .settings-container {
            max-width: 1200px;
        }
        /* MoMo Numbers */
        .momo-numbers-list {
            margin-top: 10px;
        }
        .momo-number-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .momo-number-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }
        .momo-number-item .remove-btn {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-add-momo {
            background: #f3f4f6;
            border: 2px dashed #d5d5d5;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
        }
        .btn-save-settings {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-save-settings:hover {
            background: #2563eb;
        }
        @media (max-width: 1200px) {
            .settings-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .settings-grid, .settings-grid-3, .settings-grid-2 { grid-template-columns: 1fr; }
            .master-toggle-row { justify-content: space-between; }
        }

        @media (max-width: 1200px) {
            .reports-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .history-stats { grid-template-columns: 1fr; }
            .history-table-header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .history-search { width: 100%; flex-wrap: wrap; }
            .history-search input { flex: 1; min-width: 150px; }
            .networks-grid { grid-template-columns: 1fr; }
            .report-period-selector { flex-wrap: wrap; }
        }

        /* ========== UI/UX ENHANCEMENTS ========== */
        
        /* Global Smooth Transitions */
        *, *::before, *::after {
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease, opacity 0.2s ease;
        }

        /* ===== 1. SKELETON LOADERS ===== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }
        
        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .skeleton-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .skeleton-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .skeleton-cell {
            height: 16px;
            border-radius: 4px;
        }
        
        .skeleton-badge {
            width: 80px;
            height: 24px;
            border-radius: 20px;
        }

        /* ===== 2. BETTER EMPTY STATES ===== */
        .empty-state-enhanced {
            text-align: center;
            padding: 60px 30px;
            background: linear-gradient(180deg, #f8fafc 0%, #fff 100%);
            border-radius: 12px;
        }
        
        .empty-state-enhanced .empty-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .empty-state-enhanced .empty-icon i {
            font-size: 3rem;
            color: #6366f1;
        }
        
        .empty-state-enhanced h3 {
            font-size: 1.25rem;
            color: #1f2937;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .empty-state-enhanced p {
            color: #6b7280;
            font-size: 0.95rem;
            max-width: 400px;
            margin: 0 auto 20px;
            line-height: 1.6;
        }
        
        .empty-state-enhanced .empty-action {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .empty-state-enhanced .empty-action:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* ===== 3. BUTTON LOADING STATES ===== */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }
        
        .btn-loading .btn-text {
            visibility: hidden;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            top: 50%;
            left: 50%;
            margin-left: -9px;
            margin-top: -9px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .btn-action:active {
            transform: scale(0.97);
        }
        
        /* Button hover lift effect */
        .btn-action, .claim-btn, .btn-save-settings, .fund-btn, .empty-action {
            position: relative;
            overflow: hidden;
        }
        
        .btn-action::before, .claim-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-action:hover::before, .claim-btn:hover::before {
            left: 100%;
        }

        /* ===== 4. ENHANCED TOAST NOTIFICATIONS ===== */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast-notification {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            animation: slideInRight 0.4s ease;
            min-width: 320px;
            max-width: 450px;
        }
        
        .toast-notification.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }
        
        .toast-notification .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        
        .toast-notification.success .toast-icon {
            background: #d1fae5;
            color: #10b981;
        }
        
        .toast-notification.error .toast-icon {
            background: #fee2e2;
            color: #ef4444;
        }
        
        .toast-notification.warning .toast-icon {
            background: #fef3c7;
            color: #f59e0b;
        }
        
        .toast-notification.info .toast-icon {
            background: #dbeafe;
            color: #3b82f6;
        }
        
        .toast-notification .toast-content {
            flex: 1;
        }
        
        .toast-notification .toast-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        
        .toast-notification .toast-message {
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        .toast-notification .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        
        .toast-notification .toast-close:hover {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .toast-notification .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: currentColor;
            border-radius: 0 0 12px 12px;
            animation: progress 3s linear forwards;
        }
        
        @keyframes progress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ===== 5. KEYBOARD SHORTCUT HINTS ===== */
        .keyboard-hint {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            opacity: 0.6;
            font-size: 0.75rem;
        }
        
        .keyboard-hint kbd {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.7rem;
        }
        
        /* Command palette */
        .command-palette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            animation: fadeIn 0.2s ease;
        }
        
        .command-palette-overlay.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .command-palette {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            overflow: hidden;
            animation: scaleIn 0.2s ease;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .command-palette-input {
            width: 100%;
            padding: 20px 24px;
            border: none;
            font-size: 1.1rem;
            outline: none;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .command-palette-input::placeholder {
            color: #9ca3af;
        }
        
        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .command-palette-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 24px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .command-palette-item:hover, .command-palette-item.selected {
            background: #f3f4f6;
        }
        
        .command-palette-item i {
            width: 36px;
            height: 36px;
            background: #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }
        
        .command-palette-item .item-text {
            flex: 1;
        }
        
        .command-palette-item .item-title {
            font-weight: 500;
            color: #1f2937;
        }
        
        .command-palette-item .item-subtitle {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        
        .command-palette-item .item-shortcut {
            display: flex;
            gap: 4px;
        }
        
        .command-palette-item .item-shortcut kbd {
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: monospace;
            color: #6b7280;
        }

        /* ===== MICRO-INTERACTIONS ===== */
        
        /* Table row hover effect */
        .data-table tr {
            transition: all 0.2s ease;
        }
        
        .data-table tbody tr:hover {
            background: #f8fafc;
            transform: scale(1.002);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        /* Card hover lift */
        .stat-card, .status-card, .wallet-stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover, .status-card:hover, .wallet-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        /* Button press effect */
        button:active, .btn-action:active, .claim-btn:active {
            transform: scale(0.97);
        }
        
        /* Checkbox animation */
        .data-table input[type="checkbox"] {
            transition: all 0.2s ease;
        }
        
        .data-table input[type="checkbox"]:checked {
            animation: checkPop 0.3s ease;
        }
        
        @keyframes checkPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Badge pulse for pending items */
        .badge-pending {
            animation: pulseBadge 2s ease-in-out infinite;
        }
        
        @keyframes pulseBadge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Success checkmark animation */
        @keyframes successPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-checkmark {
            animation: successPop 0.4s ease forwards;
        }
        
        /* Ripple effect on buttons */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255,255,255,0.4);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1) translate(-50%, -50%);
            transform-origin: center;
        }
        
        .ripple:active::after {
            animation: ripple 0.4s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0) translate(-50%, -50%);
                opacity: 1;
            }
            100% {
                transform: scale(40) translate(-50%, -50%);
                opacity: 0;
            }
        }
        
        /* ===== PROFESSIONAL CONFIRMATION MODAL ===== */
        .confirm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }
        .confirm-modal-overlay.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .confirm-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .confirm-modal-header {
            padding: 24px 24px 0;
            text-align: center;
        }
        .confirm-modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 1.75rem;
        }
        .confirm-modal-icon.warning {
            background: #fef3c7;
            color: #f59e0b;
        }
        .confirm-modal-icon.danger {
            background: #fee2e2;
            color: #ef4444;
        }
        .confirm-modal-icon.success {
            background: #d1fae5;
            color: #10b981;
        }
        .confirm-modal-icon.info {
            background: #dbeafe;
            color: #3b82f6;
        }
        .confirm-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .confirm-modal-message {
            color: #6b7280;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 0 24px;
            text-align: center;
        }
        .confirm-modal-input {
            padding: 16px 24px;
        }
        .confirm-modal-input input,
        .confirm-modal-input textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .confirm-modal-input input:focus,
        .confirm-modal-input textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .confirm-modal-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        .confirm-modal-footer {
            display: flex;
            gap: 12px;
            padding: 20px 24px 24px;
        }
        .confirm-modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .confirm-modal-btn:hover {
            transform: translateY(-1px);
        }
        .confirm-modal-btn.cancel {
            background: #f3f4f6;
            color: #4b5563;
        }
        .confirm-modal-btn.cancel:hover {
            background: #e5e7eb;
        }
        .confirm-modal-btn.confirm {
            background: #3b82f6;
            color: white;
        }
        .confirm-modal-btn.confirm:hover {
            background: #2563eb;
        }
        .confirm-modal-btn.confirm.danger {
            background: #ef4444;
        }
        .confirm-modal-btn.confirm.danger:hover {
            background: #dc2626;
        }
        .confirm-modal-btn.confirm.success {
            background: #10b981;
        }
        .confirm-modal-btn.confirm.success:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <!-- PROFESSIONAL CONFIRMATION MODAL -->
    <div class="confirm-modal-overlay" id="confirmModal">
        <div class="confirm-modal">
            <div class="confirm-modal-header">
                <div class="confirm-modal-icon warning" id="confirmModalIcon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="confirm-modal-title" id="confirmModalTitle">Confirm Action</h3>
            </div>
            <p class="confirm-modal-message" id="confirmModalMessage">Are you sure you want to proceed?</p>
            <div class="confirm-modal-input" id="confirmModalInputSection" style="display:none;">
                <label id="confirmModalInputLabel">Enter value:</label>
                <input type="text" id="confirmModalInput" placeholder="">
            </div>
            <div class="confirm-modal-footer">
                <button class="confirm-modal-btn cancel" id="confirmModalCancel">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="confirm-modal-btn confirm" id="confirmModalConfirm">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <div class="logo-box">KDP</div>
            <span class="logo-text">KemDataplus</span>
        </div>
        
        <div class="menu-label">Menu</div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a href="#" class="nav-link active" id="navDashboard" data-section="dashboard">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navWallet" data-section="wallet">
                    <i class="fas fa-wallet"></i>
                    <span>Wallet</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navUsers" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navHistory" data-section="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navNetworks" data-section="networks">
                    <i class="fas fa-network-wired"></i>
                    <span>Networks</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navStorefronts" data-section="storefronts">
                    <i class="fas fa-store"></i>
                    <span>Storefronts</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navReports" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="navSettings" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
        
        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="greeting">
                <h1 id="greetingText">Good morning, Admin </h1>
                <p>You can still drop your orders! Delivery will be in the morning</p>
            </div>
            <div class="header-right">
                <div class="keyboard-hint" onclick="toggleCommandPalette()" title="Open Command Palette">
                    <span><kbd>Ctrl</kbd>+<kbd>K</kbd></span>
                </div>
                <div class="header-stat">
                    <div class="label"><i class="fas fa-shopping-bag"></i> Total Sold:</div>
                    <div class="value" id="totalSold">GH 0.00</div>
                </div>
                <div class="header-stat">
                    <div class="label"><i class="fas fa-chart-line"></i> Profit Made:</div>
                    <div class="value profit" id="totalProfit">GH 0.00</div>
                </div>
                <div class="admin-avatar">A</div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <div class="page-title">
                <i class="fas fa-th-large"></i>
                <h2>Dashboard</h2>
            </div>

            <!-- Main Stats -->
            <div class="main-stats">
                <div class="stat-card wallet">
                    <div class="info">
                        <h4>Wallet Balance</h4>
                        <div class="value" id="walletBalance">GH 0.00</div>
                    </div>
                    <div class="icon"><i class="fas fa-wallet"></i></div>
                </div>
                <div class="stat-card orders">
                    <div class="info">
                        <h4>Orders Today</h4>
                        <div class="value" id="ordersToday">0</div>
                    </div>
                    <div class="icon"><i class="fas fa-shopping-cart"></i></div>
                </div>
                <div class="stat-card amount">
                    <div class="info">
                        <h4>Amount Today</h4>
                        <div class="value" id="amountToday">GH 0.00</div>
                    </div>
                    <div class="icon"><i class="fas fa-coins"></i></div>
                </div>
                <div class="stat-card bundle">
                    <div class="info">
                        <h4>Bundle Today</h4>
                        <div class="value" id="bundleToday">0</div>
                    </div>
                    <div class="icon"><i class="fas fa-database"></i></div>
                </div>
            </div>

            <!-- Order Status Cards -->
            <div class="status-cards">
                <div class="status-card pending">
                    <h4>Pending Orders</h4>
                    <div class="count" id="pendingCount">0</div>
                    <div class="details">
                        <span>Amount: <strong id="pendingAmount">GH 0.00</strong></span>
                        <span>Capacity: <strong id="pendingCapacity">0</strong></span>
                    </div>
                </div>
                <div class="status-card processing">
                    <h4>Processing Orders</h4>
                    <div class="count" id="processingCount">0</div>
                    <div class="details">
                        <span>Amount: <strong id="processingAmount">GH 0.00</strong></span>
                        <span>Capacity: <strong id="processingCapacity">0</strong></span>
                    </div>
                </div>
                <div class="status-card completed">
                    <h4>Completed Orders</h4>
                    <div class="count" id="completedCount">0</div>
                    <div class="details">
                        <span>Amount: <strong id="completedAmount">GH 0.00</strong></span>
                        <span>Capacity: <strong id="completedCapacity">0</strong></span>
                    </div>
                </div>
                <div class="status-card cancelled">
                    <h4>Cancelled Orders</h4>
                    <div class="count" id="cancelledCount">0</div>
                    <div class="details">
                        <span>Amount: <strong id="cancelledAmount">GH 0.00</strong></span>
                        <span>Capacity: <strong id="cancelledCapacity">0</strong></span>
                    </div>
                </div>
                <div class="status-card all">
                    <h4>All Orders</h4>
                    <div class="count" id="allCount">0</div>
                    <div class="details">
                        <span>Amount: <strong id="allAmount">GH 0.00</strong></span>
                        <span>Capacity: <strong id="allCapacity">0</strong></span>
                    </div>
                </div>
            </div>

            <!-- Filter Options Panel -->
            <div class="filter-options-panel">
                <div class="filter-header">
                    <h4><i class="fas fa-filter"></i> Filter Options</h4>
                </div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Filter by Date:</label>
                        <input type="date" id="filterDate" placeholder="mm/dd/yyyy">
                    </div>
                    <div class="filter-group">
                        <label>Filter by Order No:</label>
                        <input type="text" id="filterOrderNoMain" placeholder="E.g. ####">
                    </div>
                    <div class="filter-group">
                        <label>Filter by Agent Code:</label>
                        <input type="text" id="filterAgentCode" placeholder="E.g. ####">
                    </div>
                    <div class="filter-group">
                        <label>Filter by Phone:</label>
                        <input type="text" id="filterPhoneMain" placeholder="Enter phone number" autocomplete="off" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                    <div class="filter-group">
                        <label>Filter By Network:</label>
                        <select id="filterNetwork">
                            <option value="">-- Select Network --</option>
                            <option value="MTN">MTN</option>
                            <option value="Telecel">Telecel</option>
                            <option value="AirtelTigo">AirtelTigo</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filter By Status:</label>
                        <select id="filterStatus">
                            <option value="">-- Select Status --</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Filter By Payment:</label>
                        <select id="filterPayment">
                            <option value="">-- Select Status --</option>
                            <option value="completed">Paid</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                </div>
                
                <!-- Network Quick Filter Buttons -->
                <div class="network-filter-buttons">
                    <button class="network-filter-btn mtn" data-network="MTN" id="filterBtnMTN">
                        <i class="fas fa-circle"></i> MTN
                        <span class="pending-badge" id="mtnFilterPending">0 Pending</span>
                    </button>
                    <button class="network-filter-btn telecel" data-network="TELECEL" id="filterBtnTelecel">
                        <i class="fas fa-circle"></i> TELECEL
                        <span class="pending-badge" id="telecelFilterPending">0 Pending</span>
                    </button>
                    <button class="network-filter-btn airteltigo" data-network="AIRTELTIGO" id="filterBtnAirtelTigo">
                        <i class="fas fa-circle"></i> AIRTELTIGO
                        <span class="pending-badge" id="airteltigoFilterPending">0 Pending</span>
                    </button>
                </div>
                
                <!-- Action Buttons Row -->
                <div class="filter-actions">
                    <button class="btn-action" id="clearFiltersBtn" style="background: #6b7280;">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                    <button class="btn-action btn-complete" id="bulkCompleteBtn">
                        <i class="fas fa-check"></i> Complete Processing
                    </button>
                    <button class="btn-action btn-cancel" id="bulkCancelBtn">
                        <i class="fas fa-times"></i> Cancel & Refund
                    </button>
                </div>
            </div>

            <!-- Orders Table -->
            <div class="table-container">
                <div class="table-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
                    <div class="per-page-control" style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-size: 0.9rem; color: #6b7280;">Show:</label>
                        <select id="ordersPerPage" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                            <option value="25">25</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        <span style="font-size: 0.9rem; color: #6b7280;">orders per page</span>
                    </div>
                    <div id="ordersPageInfo" style="font-size: 0.9rem; color: #6b7280;"></div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Order Date</th>
                            <th>Agent</th>
                            <th>Order #</th>
                            <th>Recipient</th>
                            <th>Network</th>
                            <th>Data</th>
                            <th>Total (GHS)</th>
                            <th>Payment</th>
                            <th>Order Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="11" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>Loading orders...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== WALLET MANAGEMENT SECTION ===== -->
        <div class="wallet-section" id="walletSection">
            <!-- Wallet Stats -->
            <div class="wallet-stats">
                <div class="wallet-stat-card total-balance">
                    <h4>Total User Balances</h4>
                    <div class="value" id="totalUserBalances">GH 0.00</div>
                </div>
                <div class="wallet-stat-card pending-topups">
                    <h4>Pending Claims</h4>
                    <div class="value" id="pendingTopupsCount">0</div>
                </div>
                <div class="wallet-stat-card today-credits">
                    <h4>Today's Credits</h4>
                    <div class="value" id="todayCredits">GH 0.00</div>
                </div>
                <div class="wallet-stat-card today-debits">
                    <h4>Today's Debits</h4>
                    <div class="value" id="todayDebits">GH 0.00</div>
                </div>
            </div>

            <!-- Wallet Main Tabs -->
            <div class="wallet-main-tabs">
                <button class="wallet-main-tab active" data-wallet-tab="users">
                    <i class="fas fa-users"></i> User Wallets
                </button>
                <button class="wallet-main-tab" data-wallet-tab="claims">
                    <i class="fas fa-receipt"></i> MoMo Claims
                    <span class="badge" id="claimsBadge" style="display: none;">0</span>
                </button>
                <button class="wallet-main-tab" data-wallet-tab="transactions">
                    <i class="fas fa-history"></i> All Transactions
                </button>
            </div>

            <!-- TAB 1: User Wallets -->
            <div class="wallet-tab-content active" id="usersTabContent">
                <div class="wallet-grid">
                    <!-- Users Wallet List -->
                    <div class="wallet-users-section">
                        <div class="section-header">
                            <h3><i class="fas fa-users"></i> User Wallets</h3>
                            <div class="search-box">
                                <input type="text" id="userSearch" placeholder="Search by name or phone...">
                            </div>
                        </div>
                        <table class="user-wallet-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Balance</th>
                                    <th>Total Spent</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userWalletsBody">
                                <tr>
                                    <td colspan="4" class="empty-state">
                                        <p>Loading users...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Fund/Top-up Panel -->
                    <div class="wallet-topup-section">
                        <div class="section-header">
                            <h3><i class="fas fa-plus-circle"></i> Fund Wallet</h3>
                        </div>
                        <form class="topup-form" id="fundWalletForm">
                            <div class="form-group">
                                <label>Select User</label>
                                <select id="fundUserSelect" required>
                                    <option value="">-- Select User --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Amount (GH)</label>
                                <input type="number" id="fundAmount" step="0.01" min="1" placeholder="Enter amount" required>
                            </div>
                            <div class="form-group">
                                <label>Transaction Type</label>
                                <select id="fundType" required>
                                    <option value="credit">Credit (Add Funds)</option>
                                    <option value="debit">Debit (Remove Funds)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Note/Reference</label>
                                <input type="text" id="fundNote" placeholder="E.g., MoMo Top-up, Refund, etc.">
                            </div>
                            <button type="submit" class="btn-fund">
                                <i class="fas fa-paper-plane"></i> Process Transaction
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- TAB 2: MoMo Claims / Incoming Payments -->
            <div class="wallet-tab-content" id="claimsTabContent">
                <div class="incoming-payments-container">
                    <!-- Search Filters -->
                    <div class="payments-filters">
                        <input type="text" id="searchTxnId" placeholder="Transaction ID...">
                        <input type="text" id="searchPhone" placeholder="Phone Number...">
                        <select id="filterClaimStatus">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="completed">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <select id="filterClaimNetwork">
                            <option value="">All Networks</option>
                            <option value="MTN">MTN</option>
                            <option value="Telecel">Telecel</option>
                            <option value="AirtelTigo">AirtelTigo</option>
                        </select>
                        <select id="filterClaimDate">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                        <button class="btn-add-payment" id="addPaymentBtn">
                            <i class="fas fa-plus"></i> Add Payment
                        </button>
                    </div>

                    <!-- Yellow Stats Cards -->
                    <div class="payments-stats-yellow">
                        <div class="yellow-stat-card">
                            <div class="stat-icon"><i class="fas fa-wallet"></i></div>
                            <div class="stat-content">
                                <h4>Total Amount Received</h4>
                                <div class="value" id="statTotalReceived"> 0.00</div>
                            </div>
                        </div>
                        <div class="yellow-stat-card">
                            <div class="stat-icon"><i class="fas fa-check-double"></i></div>
                            <div class="stat-content">
                                <h4>Total Claimed</h4>
                                <div class="value" id="statTotalClaimed"> 0.00</div>
                            </div>
                        </div>
                        <div class="yellow-stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-content">
                                <h4>Total Unclaimed</h4>
                                <div class="value" id="statTotalUnclaimed"> 0.00</div>
                            </div>
                        </div>
                        <div class="yellow-stat-card">
                            <div class="stat-icon"><i class="fas fa-question-circle"></i></div>
                            <div class="stat-content">
                                <h4>Pending Amount</h4>
                                <div class="value" id="statPendingAmount"> 0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Dark Count Cards -->
                    <div class="payments-stats-dark">
                        <div class="dark-stat-card">
                            <div class="stat-icon"><i class="fas fa-list"></i></div>
                            <div class="stat-content">
                                <h4>Total Records</h4>
                                <div class="value" id="statTotalRecords">0</div>
                            </div>
                        </div>
                        <div class="dark-stat-card">
                            <div class="stat-icon"><i class="fas fa-check-square"></i></div>
                            <div class="stat-content">
                                <h4>Claimed Count</h4>
                                <div class="value" id="statClaimedCount">0</div>
                            </div>
                        </div>
                        <div class="dark-stat-card">
                            <div class="stat-icon"><i class="fas fa-clock"></i></div>
                            <div class="stat-content">
                                <h4>Unclaimed Count</h4>
                                <div class="value" id="statUnclaimedCount">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Payments Table -->
                    <div class="payments-table-container">
                        <table class="payments-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Transaction ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="incomingPaymentsBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
                                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                        No claims yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="payments-table-footer">
                            <label>Per Page</label>
                            <select id="tablePerPage">
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: All Transactions -->
            <div class="wallet-tab-content" id="transactionsTabContent">
                <div class="section-header" style="background: white; padding: 15px 20px; border-radius: 12px 12px 0 0; margin-bottom: 0;">
                    <h3><i class="fas fa-history"></i> All Transactions</h3>
                    <div class="search-box">
                        <input type="text" id="txnSearch" placeholder="Search by user or reference...">
                        <select id="txnTypeFilter" style="padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <option value="">All Types</option>
                            <option value="credit">Credits Only</option>
                            <option value="debit">Debits Only</option>
                        </select>
                    </div>
                </div>
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Processed By</th>
                        </tr>
                    </thead>
                    <tbody id="allTransactionsBody">
                        <tr>
                            <td colspan="6" class="empty-state">
                                <p>Loading transactions...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== USERS MANAGEMENT SECTION ========== -->
        <div class="users-section" id="usersSection">
            <!-- Users Stats -->
            <div class="users-stats">
                <div class="users-stat-card">
                    <div class="stat-icon total"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <h4>Total Users</h4>
                        <div class="stat-value" id="statTotalUsers">0</div>
                    </div>
                </div>
                <div class="users-stat-card">
                    <div class="stat-icon active"><i class="fas fa-user-check"></i></div>
                    <div class="stat-info">
                        <h4>Active Users</h4>
                        <div class="stat-value" id="statActiveUsers">0</div>
                    </div>
                </div>
                <div class="users-stat-card">
                    <div class="stat-icon new"><i class="fas fa-user-plus"></i></div>
                    <div class="stat-info">
                        <h4>New This Month</h4>
                        <div class="stat-value" id="statNewUsers">0</div>
                    </div>
                </div>
                <div class="users-stat-card">
                    <div class="stat-icon balance"><i class="fas fa-wallet"></i></div>
                    <div class="stat-info">
                        <h4>Total Balance</h4>
                        <div class="stat-value" id="statTotalBalance">GH 0.00</div>
                    </div>
                </div>
            </div>

            <!-- Users Table Section -->
            <div class="users-table-container">
                <div class="users-table-header">
                    <h3><i class="fas fa-users"></i> User Management</h3>
                    <div class="users-controls">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="usersSearchInput" placeholder="Search users...">
                        </div>
                        <select id="usersRoleFilter">
                            <option value="">All Roles</option>
                            <option value="ADMIN">Admin</option>
                            <option value="PARTNER">Partner</option>
                            <option value="SUPER_DEALER">Super Dealer</option>
                            <option value="DEALER">Dealer</option>
                            <option value="SUPER_AGENT">Super Agent</option>
                            <option value="AGENT">Agent</option>
                        </select>
                        <select id="usersStatusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <button class="btn-add-user" id="addUserBtn">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Balance</th>
                            <th>Total Spent</th>
                            <th>Orders</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">
                                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                Loading users...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- User Modal -->
        <div class="modal-overlay" id="userModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="userModalTitle">Add New User</h3>
                    <button class="modal-close" id="closeUserModalBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="userFormEdit" onsubmit="event.preventDefault(); saveUser();">
                    <input type="hidden" id="editUserIdEdit">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="userFullNameEdit" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" id="userPhoneEdit" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="userEmailEdit">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select id="userRoleEdit">
                                <option value="AGENT">Agent</option>
                                <option value="SUPER_AGENT">Super Agent</option>
                                <option value="DEALER">Dealer</option>
                                <option value="SUPER_DEALER">Super Dealer</option>
                                <option value="PARTNER">Partner</option>
                                <option value="ADMIN">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="userStatusEdit">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Balance (GH)</label>
                            <input type="number" id="userBalanceEdit" step="0.01" value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Preferred Network</label>
                            <select id="userNetworkEdit">
                                <option value="">Select Network</option>
                                <option value="MTN">MTN</option>
                                <option value="Vodafone">Vodafone</option>
                                <option value="AirtelTigo">AirtelTigo</option>
                            </select>
                        </div>
                        <div class="form-group"></div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="userNotesEdit" rows="2" placeholder="Any notes about this user..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" id="cancelUserModalBtn">Cancel</button>
                        <button type="submit" class="btn-save">Save User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View User Modal -->
        <div class="modal-overlay" id="viewUserModal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>User Details</h3>
                    <button class="modal-close" id="closeViewUserModalBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="user-detail-content" id="userDetailContent">
                    <!-- User details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Change Role Modal -->
        <div class="modal-overlay" id="changeRoleModal">
            <div class="modal-content" style="max-width: 400px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header" style="background: #6366f1;">
                    <h3><i class="fas fa-user-tag"></i> Change User Role</h3>
                    <button class="modal-close" id="closeChangeRoleModalBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="padding: 25px; padding-bottom: 20px;">
                    <input type="hidden" id="changeRoleUserId">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div id="changeRoleUserName" style="font-size: 1.1rem; font-weight: 600; color: #1f2937;"></div>
                        <div id="changeRoleCurrentRole" style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">Select New Role</label>
                        <div style="display: grid; gap: 10px;">
                            <label class="role-option" style="display: flex; align-items: center; padding: 12px 15px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                                <input type="radio" name="newRole" value="AGENT" style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #4338ca;">Agent</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">Basic user with standard pricing</div>
                                </div>
                            </label>
                            <label class="role-option" style="display: flex; align-items: center; padding: 12px 15px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                                <input type="radio" name="newRole" value="SUPER_AGENT" style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #1d4ed8;">Super Agent</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">Better pricing than Agent</div>
                                </div>
                            </label>
                            <label class="role-option" style="display: flex; align-items: center; padding: 12px 15px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                                <input type="radio" name="newRole" value="DEALER" style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #b45309;">Dealer</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">Wholesale pricing tier</div>
                                </div>
                            </label>
                            <label class="role-option" style="display: flex; align-items: center; padding: 12px 15px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                                <input type="radio" name="newRole" value="SUPER_DEALER" style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #be185d;">Super Dealer</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">Best pricing tier available</div>
                                </div>
                            </label>
                            <label class="role-option" style="display: flex; align-items: center; padding: 12px 15px; background: #f9fafb; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                                <input type="radio" name="newRole" value="PARTNER" style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #059669;">Partner</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">Partner level pricing</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="form-actions" style="margin-top: 20px;">
                        <button type="button" class="btn-cancel" id="cancelChangeRoleModalBtn">Cancel</button>
                        <button type="button" class="btn-save" style="background: #6366f1;" id="saveUserRoleBtn">
                            <i class="fas fa-check"></i> Update Role
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== HISTORY SECTION ========== -->
        <div class="history-section" id="historySection">
            <!-- History Section Header -->
            <div class="history-section-header">
                <div class="header-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h2>History</h2>
            </div>

            <!-- History Stats Cards -->
            <div class="history-stats">
                <div class="history-stat-card">
                    <div class="stat-info">
                        <h4>Orders</h4>
                        <div class="stat-value" id="historyStatOrders">0</div>
                    </div>
                    <div class="stat-icon orders">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
                <div class="history-stat-card">
                    <div class="stat-info">
                        <h4>Total Amount</h4>
                        <div class="stat-value" id="historyStatAmount">GH 0.00</div>
                    </div>
                    <div class="stat-icon amount">
                        <i class="fas fa-coins"></i>
                    </div>
                </div>
                <div class="history-stat-card">
                    <div class="stat-info">
                        <h4>Data Bundle</h4>
                        <div class="stat-value" id="historyStatBundle">0 GB</div>
                    </div>
                    <div class="stat-icon bundle">
                        <i class="fas fa-sim-card"></i>
                    </div>
                </div>
            </div>

            <!-- Filter Options -->
            <div class="history-filter-section">
                <div class="history-filter-header" id="historyFilterHeader">
                    <h4><i class="fas fa-filter"></i> Filter Options</h4>
                    <i class="fas fa-chevron-down toggle-icon" id="filterToggleIcon"></i>
                </div>
                <div class="history-filter-content" id="historyFilterContent">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Orders From:</label>
                            <input type="date" id="filterDateFrom">
                        </div>
                        <div class="filter-group">
                            <label>Orders To:</label>
                            <input type="date" id="filterDateTo">
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Filter by Order No.:</label>
                            <input type="text" id="filterOrderNoModal" placeholder="Eg. ####">
                        </div>
                        <div class="filter-group">
                            <label>Filter by Phone:</label>
                            <input type="text" id="filterPhoneModal" placeholder="Eg. 233247689098" autocomplete="off" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                        </div>
                        <div class="filter-group">
                            <label>Filter By Status:</label>
                            <select id="filterStatusHistory">
                                <option value="">-- Select Status --</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter By Payment:</label>
                            <select id="filterPaymentHistory">
                                <option value="">-- Select Status --</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter By Agent:</label>
                            <select id="filterAgentHistory">
                                <option value="">-- Select Agent --</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Filter By Network:</label>
                            <select id="filterNetworkHistory">
                                <option value="">-- Select Network --</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn-clear-filters" id="clearHistoryFiltersBtn">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button class="btn-export-history" id="exportHistoryBtn">
                            Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Order Date</th>
                            <th>Agent</th>
                            <th>Order #</th>
                            <th>Recipient</th>
                            <th>Network</th>
                            <th>Data (GB)</th>
                            <th>Total (GHS)</th>
                            <th>Payment</th>
                            <th>Order Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="10">
                                <div class="history-empty-state">
                                    <i class="fas fa-database"></i>
                                    <h4>No Orders</h4>
                                    <p>Sorry, no orders to display</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="history-pagination">
                    <div class="per-page">
                        <span>Per Page</span>
                        <select id="historyPerPage">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                    <div class="page-info" id="historyPageInfo"></div>
                </div>
            </div>
        </div>

        <!-- ========== NETWORKS SECTION ========== -->
        <div class="networks-section" id="networksSection">
            <!-- Top Action Buttons -->
            <div class="networks-top-actions">
                <button class="btn-new-network" id="addNetworkBtn">
                    <i class="fas fa-plus"></i> New Network
                </button>
                <button class="btn-new-bundle" id="addBundleBtn">
                    <i class="fas fa-plus"></i> New Bundle
                </button>
                <button class="btn-sync-frontend" id="syncBundlesToFrontendBtn" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-sync-alt"></i> Sync to Frontend
                </button>
            </div>
            
            <!-- Registered Networks -->
            <h3 class="networks-section-title">Registered Networks</h3>
            <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 15px;">
                <i class="fas fa-info-circle"></i> Networks and bundles configured here will appear on the client dashboard. Toggle a network OFF to mark all its bundles as "Out of Stock".
            </p>
            <div class="networks-cards-grid" id="networksCardsGrid">
                <!-- Network cards will be rendered dynamically -->
            </div>
            
            <!-- Bundle Tariffs -->
            <div class="bundle-tariffs-section">
                <div class="bundle-tariffs-header">
                    <h3>Bundle Tariffs</h3>
                    <div class="bundle-tariffs-filter">
                        <label>Sort Network:</label>
                        <select id="bundleNetworkFilter">
                            <option value="">-- Select Network --</option>
                        </select>
                    </div>
                </div>
                <table class="bundle-tariffs-table">
                    <thead>
                        <tr>
                            <th>Network</th>
                            <th>Capacity (GB)</th>
                            <th>Cost (GHS)</th>
                            <th>Super-Dealer (GHS)</th>
                            <th>Dealer (GHS)</th>
                            <th>Super-Agent (GHS)</th>
                            <th>Agent (GHS)</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bundleTariffsBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #9ca3af;">
                                <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                No bundles configured yet
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Edit Network Modal -->
        <div class="modal-overlay" id="networkModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="networkModalTitle">Add New Network</h3>
                    <button class="modal-close" id="closeNetworkModalBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="networkForm">
                    <input type="hidden" id="editNetworkId">
                    <div class="form-group" style="padding: 20px;">
                        <label>Network Name *</label>
                        <input type="text" id="networkName" required placeholder="e.g. MTN NON-EXPIRY BUNDLES">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" id="cancelNetworkModalBtn">Cancel</button>
                        <button type="submit" class="btn-save">Save Network</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add/Edit Bundle Modal -->
        <div class="modal-overlay" id="bundleModal">
            <div class="modal-content" style="max-width: 650px;">
                <div class="modal-header">
                    <h3 id="bundleModalTitle">Add New Bundle</h3>
                    <button class="modal-close" id="closeBundleModalBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="bundleForm" style="padding: 20px;">
                    <input type="hidden" id="editBundleIdEdit">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Network *</label>
                            <select id="bundleNetworkEdit" required>
                                <option value="">-- Select Network --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Capacity (GB) *</label>
                            <input type="text" id="bundleCapacityEdit" required placeholder="e.g. 1 GB">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cost Price (GHS) *</label>
                            <input type="number" id="bundleCostEdit" step="0.01" required placeholder="Admin cost">
                        </div>
                        <div class="form-group">
                            <label>Partner Price (GHS)</label>
                            <input type="number" id="bundlePartnerEdit" step="0.01" placeholder="Partner price">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Super-Dealer Price (GHS)</label>
                            <input type="number" id="bundleSuperDealerEdit" step="0.01" placeholder="Super-Dealer price">
                        </div>
                        <div class="form-group">
                            <label>Dealer Price (GHS)</label>
                            <input type="number" id="bundleDealerEdit" step="0.01" placeholder="Dealer price">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Super-Agent Price (GHS)</label>
                            <input type="number" id="bundleSuperAgentEdit" step="0.01" placeholder="Super-Agent price">
                        </div>
                        <div class="form-group">
                            <label>Agent Price (GHS) *</label>
                            <input type="number" id="bundleAgentEdit" step="0.01" required placeholder="Agent price">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select id="bundleStatusEdit">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> Only roles with prices set can purchase this bundle.
                    </p>
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" id="cancelBundleModalEditBtn">Cancel</button>
                        <button type="submit" class="btn-save" id="saveBundleModalEditBtn">Save Bundle</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ========== REPORTS SECTION ========== -->
        <div class="reports-section" id="reportsSection">
            <!-- Report Tabs -->
            <div class="report-tabs">
                <button class="report-tab active" data-report-tab="sales">
                    <i class="fas fa-chart-bar"></i> Sales Report
                </button>
                <button class="report-tab" data-report-tab="users">
                    <i class="fas fa-users"></i> User Report
                </button>
            </div>

            <!-- Sales Report View -->
            <div class="report-view active" id="salesReportView">
                <!-- Period Filter -->
                <div class="report-period-filter">
                    <button class="active" data-report-period="today">Today</button>
                    <button data-report-period="week">This Week</button>
                    <button data-report-period="month">This Month</button>
                    <button data-report-period="year">This Year</button>
                    <button data-report-period="all">All Time</button>
                </div>

                <!-- Summary Cards -->
                <div class="report-summary-cards">
                    <div class="report-summary-card orders">
                        <h4><i class="fas fa-shopping-cart"></i> Total Orders</h4>
                        <div class="value" id="reportTotalOrders">0</div>
                    </div>
                    <div class="report-summary-card data">
                        <h4><i class="fas fa-database"></i> Total Data (GB)</h4>
                        <div class="value" id="reportTotalData">0</div>
                    </div>
                    <div class="report-summary-card revenue">
                        <h4><i class="fas fa-money-bill-wave"></i> Total Revenue</h4>
                        <div class="value" id="reportTotalRevenue">GH 0</div>
                    </div>
                    <div class="report-summary-card profit">
                        <h4><i class="fas fa-chart-line"></i> Total Profit</h4>
                        <div class="value" id="reportTotalProfit">GH 0</div>
                    </div>
                </div>

                <!-- Sales Report Table -->
                <div class="sales-report-container">
                    <div class="sales-report-header">
                        <div class="header-icon"><i class="fas fa-chart-bar"></i></div>
                        <h2>Sales Report</h2>
                    </div>
                    <table class="sales-report-table">
                        <thead>
                            <tr>
                                <th>Order Date</th>
                                <th>No. of Orders</th>
                                <th>Data (GB)</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Profit (GHS)</th>
                            </tr>
                        </thead>
                        <tbody id="salesReportBody">
                            <!-- Sales report rows will be generated dynamically -->
                        </tbody>
                    </table>
                    <div class="sales-report-empty" id="salesReportEmpty" style="display: none;">
                        <i class="fas fa-chart-bar"></i>
                        <p>No sales data available for this period</p>
                    </div>
                </div>
            </div>

            <!-- User Report View -->
            <div class="report-view" id="userReportView">
                <div class="user-report-container">
                    <div class="user-report-header">
                        <div class="header-icon"><i class="fas fa-users"></i></div>
                        <h2>User Report</h2>
                    </div>
                    <div class="user-report-date">
                        Report Date: <span id="userReportDate">01/02/2026</span>
                        <button id="exportUserReportBtn" style="float: right; background: none; border: none; cursor: pointer; color: #6b7280;" title="Export Report">
                            <i class="fas fa-table"></i>
                        </button>
                    </div>
                    <h3 style="padding: 15px 20px; margin: 0; font-size: 1.1rem; color: #1f2937;">User Reports</h3>
                    <table class="user-report-table">
                        <thead>
                            <tr>
                                <th>Agent #</th>
                                <th>Wallet Loads</th>
                                <th>Total Orders (GHS)</th>
                                <th>Data Capacity</th>
                                <th>Profit (GHS)</th>
                            </tr>
                        </thead>
                        <tbody id="userReportBody">
                            <!-- User report rows will be generated dynamically -->
                        </tbody>
                    </table>
                    <div class="user-report-empty" id="userReportEmpty" style="display: none;">
                        <i class="fas fa-users"></i>
                        <p>No user data available</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== SETTINGS SECTION ========== -->
        <div class="settings-section" id="settingsSection">
            <div class="settings-header">
                <div class="header-icon"><i class="fas fa-cog"></i></div>
                <h2>Settings</h2>
            </div>
            
            <div class="settings-body">
                <div class="settings-container">
                    <!-- Site Settings Card -->
                    <div class="settings-card">
                        <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 25px;">Site Settings</h3>
                        
                        <!-- Wallet & Order Settings -->
                        <div class="settings-section-title">Wallet & Order Settings</div>
                        <div class="master-toggle-row">
                            <span class="master-toggle-label">Place Orders</span>
                            <div class="toggle-switch active" id="togglePlaceOrders" data-site-setting="placeOrders"></div>
                        </div>
                        <div class="settings-grid">
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>Load Wallet</h4>
                                    <p id="loadWalletStatus">Agents CANNOT load wallet</p>
                                </div>
                                <div class="toggle-switch" id="toggleLoadWallet" data-site-setting="loadWallet"></div>
                            </div>
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>Claim Wallet</h4>
                                    <p id="claimWalletStatus">Agents can claim wallet top-up</p>
                                </div>
                                <div class="toggle-switch active" id="toggleClaimWallet" data-site-setting="claimWallet"></div>
                            </div>
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>Allow Bulk Orders</h4>
                                    <p id="bulkOrderStatus">Agents can use text input to Order</p>
                                </div>
                                <div class="toggle-switch active" id="toggleBulkOrders" data-site-setting="bulkOrders"></div>
                            </div>
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>Allow Excel Import</h4>
                                    <p id="excelImportStatus">Agents CANNOT use Excel Import</p>
                                </div>
                                <div class="toggle-switch" id="toggleExcelImport" data-site-setting="excelImport"></div>
                            </div>
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>Allow Cart Order</h4>
                                    <p id="cartOrderStatus">Agents can use Cart</p>
                                </div>
                                <div class="toggle-switch active" id="toggleCartOrder" data-site-setting="cartOrder"></div>
                            </div>
                        </div>

                        <!-- Other Settings -->
                        <div class="settings-section-title" style="margin-top: 30px;">Other Settings</div>
                        <div class="settings-grid settings-grid-2">
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>New Registration</h4>
                                    <p id="newRegStatus">Portal is accepting new Agents</p>
                                </div>
                                <div class="toggle-switch active" id="toggleNewRegistration" data-site-setting="newRegistration"></div>
                            </div>
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4>Website Update</h4>
                                    <p id="websiteUpdateStatus">Portal is available for use</p>
                                </div>
                                <div class="toggle-switch" id="toggleWebsiteUpdate" data-site-setting="websiteUpdate"></div>
                            </div>
                        </div>
                    </div>

                    <!-- EasyDataGH API Integration Card -->
                    <div class="settings-card" style="border: 2px solid #10b981;">
                        <div class="settings-section-title" style="color: #10b981;">
                            <i class="fas fa-bolt"></i> EasyDataGH API (Primary)
                        </div>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                            When Master API is ON, orders automatically go to EasyDataGH.
                        </p>
                        
                        <!-- Master Toggle -->
                        <div class="master-toggle-row" style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <span class="master-toggle-label" style="font-weight: 600;"><i class="fas fa-power-off"></i> Master API (ON/OFF)</span>
                            <div class="toggle-switch" id="toggleMasterAPI" data-site-setting="masterAPI"></div>
                        </div>

                        <!-- Network Toggles for EasyDataGH -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #374151;"><i class="fas fa-network-wired"></i> Network-Specific Controls</div>
                            <div class="settings-grid">
                                <div class="setting-card" style="border-left: 3px solid #f59e0b;">
                                    <div class="setting-card-info">
                                        <h4 style="color: #f59e0b;">MTN Orders</h4>
                                        <p id="easydataMtnApiStatus">Push MTN orders to EasyDataGH</p>
                                    </div>
                                    <div class="toggle-switch active" id="toggleEasydataMtnAPI" data-site-setting="easydata_mtnAPI"></div>
                                </div>
                                <div class="setting-card" style="border-left: 3px solid #ef4444;">
                                    <div class="setting-card-info">
                                        <h4 style="color: #ef4444;">Telecel Orders</h4>
                                        <p id="easydataTelecelApiStatus">Push Telecel orders to EasyDataGH</p>
                                    </div>
                                    <div class="toggle-switch active" id="toggleEasydataTelecelAPI" data-site-setting="easydata_telecelAPI"></div>
                                </div>
                                <div class="setting-card" style="border-left: 3px solid #3b82f6;">
                                    <div class="setting-card-info">
                                        <h4 style="color: #3b82f6;">AirtelTigo Orders</h4>
                                        <p id="easydataAirteltigoApiStatus">Push AirtelTigo orders to EasyDataGH</p>
                                    </div>
                                    <div class="toggle-switch active" id="toggleEasydataAirtelTigoAPI" data-site-setting="easydata_airteltigoAPI"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-Sync Toggle -->
                        <div class="settings-grid settings-grid-2" style="margin-bottom: 15px;">
                            <div class="setting-card" style="border: 1px solid #10b981;">
                                <div class="setting-card-info">
                                    <h4 style="color: #10b981;"><i class="fas fa-sync"></i> Auto-Sync Status</h4>
                                    <p id="easyDataAutoSyncStatus">Auto-check order status every 30s</p>
                                </div>
                                <div class="toggle-switch" id="toggleEasyDataAutoSync" data-site-setting="easyDataAutoSync"></div>
                            </div>
                        </div>

                        <!-- API Credentials -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="fas fa-link"></i> API URL</label>
                                <input type="text" id="easyDataApiUrl" value="https://easydatagh.pro/wp-json/custom/v1" readonly style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: #e5e7eb;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="fas fa-user"></i> Username</label>
                                <input type="text" id="easyDataUsername" placeholder="API Username" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: #fff;">
                            </div>
                            <div>
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="fas fa-key"></i> Password</label>
                                <input type="password" id="easyDataPassword" placeholder="API Password" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            </div>
                        </div>

                        <!-- API Actions -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn-fund" onclick="testEasyDataConnection()" style="background: #10b981;">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button type="button" class="btn-fund" onclick="checkEasyDataBalance()" style="background: #059669;">
                                <i class="fas fa-wallet"></i> Check Balance
                            </button>
                        </div>

                        <!-- API Balance Display -->
                        <div id="easyDataBalanceDisplay" style="display: none; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">EasyDataGH API Balance</div>
                            <div style="font-size: 1.8rem; font-weight: 700;" id="easyDataBalanceAmount">GHS 0.00</div>
                        </div>
                    </div>

                    <!-- Mcbis API Integration Card -->
                    <div class="settings-card" style="border: 2px solid #024959;">
                        <div class="settings-section-title" style="color: #024959;">
                            <i class="fas fa-plug"></i> Mcbis Data API (Secondary)
                        </div>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                            When MCBIS API is ON (and Master OFF), orders go to McbisSolution DataHub.
                        </p>
                        
                        <!-- API Master Toggle -->
                        <div class="master-toggle-row" style="background: #f0f9ff; border: 1px solid #024959; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <span class="master-toggle-label" style="font-weight: 600;"><i class="fas fa-power-off"></i> MCBIS API (ON/OFF)</span>
                            <div class="toggle-switch" id="toggleMcbisApi" data-site-setting="mcbisAPI"></div>
                        </div>

                        <!-- Network Toggles for MCBIS -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #374151;"><i class="fas fa-network-wired"></i> Network-Specific Controls</div>
                            <div class="settings-grid">
                                <div class="setting-card" style="border-left: 3px solid #f59e0b;">
                                    <div class="setting-card-info">
                                        <h4 style="color: #f59e0b;">MTN Orders</h4>
                                        <p id="mcbisMtnApiStatus">Push MTN orders to MCBIS</p>
                                    </div>
                                    <div class="toggle-switch active" id="toggleMcbisMtnAPI" data-site-setting="mcbis_mtnAPI"></div>
                                </div>
                                <div class="setting-card" style="border-left: 3px solid #ef4444;">
                                    <div class="setting-card-info">
                                        <h4 style="color: #ef4444;">Telecel Orders</h4>
                                        <p id="mcbisTelecelApiStatus">Push Telecel orders to MCBIS</p>
                                    </div>
                                    <div class="toggle-switch active" id="toggleMcbisTelecelAPI" data-site-setting="mcbis_telecelAPI"></div>
                                </div>
                                <div class="setting-card" style="border-left: 3px solid #3b82f6;">
                                    <div class="setting-card-info">
                                        <h4 style="color: #3b82f6;">AirtelTigo Orders</h4>
                                        <p id="mcbisAirteltigoApiStatus">Push AirtelTigo orders to MCBIS</p>
                                    </div>
                                    <div class="toggle-switch active" id="toggleMcbisAirtelTigoAPI" data-site-setting="mcbis_airteltigoAPI"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-Sync Toggle -->
                        <div class="settings-grid settings-grid-2" style="margin-bottom: 15px;">
                            <div class="setting-card">
                                <div class="setting-card-info">
                                    <h4><i class="fas fa-sync"></i> Auto-Sync Status</h4>
                                    <p>Automatically check and update order status</p>
                                </div>
                                <div class="toggle-switch" id="toggleMcbisAutoSync" data-site-setting="mcbisAutoSync"></div>
                            </div>
                        </div>

                        <!-- API Credentials -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="fas fa-link"></i> API URL</label>
                                <input type="text" id="mcbisApiUrl" value="https://datahub.mcbissolution.com/api/v1" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; background: #fff;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;"><i class="fas fa-key"></i> API Token</label>
                                <input type="password" id="mcbisApiToken" placeholder="Enter your Mcbis API token" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            </div>
                        </div>

                        <!-- API Status & Actions -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" class="btn-fund" onclick="testMcbisConnection()" style="background: #024959;">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button type="button" class="btn-fund" onclick="checkMcbisBalance()" style="background: #10b981;">
                                <i class="fas fa-wallet"></i> Check Balance
                            </button>
                            <button type="button" class="btn-fund" onclick="syncAllMcbisOrders()" style="background: #f59e0b;">
                                <i class="fas fa-sync"></i> Sync All Orders
                            </button>
                        </div>

                        <!-- API Balance Display -->
                        <div id="mcbisBalanceDisplay" style="display: none; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #024959, #036c7f); border-radius: 8px; color: white;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Mcbis API Balance</div>
                            <div style="font-size: 1.8rem; font-weight: 700;" id="mcbisBalanceAmount">GHS 0.00</div>
                        </div>
                    </div>
                </div>

                    <!-- MoMo Numbers Card -->
                    <div class="settings-card">
                        <div class="settings-section-title">Payment MoMo Numbers</div>
                        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem;">
                            Add MoMo numbers where customers will send payments. These will be shown to users.
                        </p>
                        <div class="momo-numbers-list" id="momoNumbersList">
                            <!-- MoMo numbers will be loaded here -->
                        </div>
                        <button class="btn-add-momo" id="addMomoNumberBtn">
                            <i class="fas fa-plus"></i> Add MoMo Number
                        </button>
                    </div>

                    <!-- API Configuration Card -->
                    <div class="settings-card">
                        <div class="settings-section-title">API Configuration</div>
                        <div class="settings-grid settings-grid-2">
                            <div style="padding: 10px 0;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;">API Base URL</label>
                                <input type="text" id="settingApiUrl" value="" placeholder="Auto-detected" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            </div>
                            <div style="padding: 10px 0;">
                                <label style="font-weight: 600; display: block; margin-bottom: 8px;">API Key</label>
                                <input type="password" id="settingApiKey" placeholder="Enter API Key" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: right; margin-top: 20px;">
                        <button class="btn-save-settings" id="saveAllSettingsBtn">
                            <i class="fas fa-save"></i> Save All Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== STOREFRONTS SECTION ========== -->
        <div class="settings-section" id="storefrontsSection">
            <div class="settings-header">
                <div class="header-icon"><i class="fas fa-store"></i></div>
                <h2>Storefront Management</h2>
            </div>
            
            <div class="settings-body">
                <!-- Profit Dashboard -->
                <div class="storefront-profit-dashboard" style="margin-bottom: 30px;">
                    <div class="profit-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="profit-stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Today's Agent Profits</div>
                            <div id="todayAgentProfits" style="font-size: 1.8rem; font-weight: 700;">GH 0.00</div>
                        </div>
                        <div class="profit-stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Today's Platform Profits</div>
                            <div id="todayPlatformProfits" style="font-size: 1.8rem; font-weight: 700;">GH 0.00</div>
                        </div>
                        <div class="profit-stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">Uncredited Profits</div>
                            <div id="uncreditedProfits" style="font-size: 1.8rem; font-weight: 700;">GH 0.00</div>
                            <div id="uncreditedCount" style="font-size: 0.75rem; opacity: 0.8;">0 orders pending</div>
                        </div>
                        <div class="profit-stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 20px; border-radius: 12px;">
                            <div style="font-size: 0.85rem; opacity: 0.9;">All-Time Agent Profits</div>
                            <div id="totalAgentProfits" style="font-size: 1.8rem; font-weight: 700;">GH 0.00</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="retryUncreditedBtn" class="btn-action" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-redo"></i> Retry Uncredited Profits
                        </button>
                        <button id="refreshProfitsBtn" class="btn-action" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="storefront-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                    <button class="storefront-tab active" data-tab="stores" style="padding: 10px 20px; border: none; background: #024959; color: white; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-store"></i> All Stores
                    </button>
                    <button class="storefront-tab" data-tab="orders" style="padding: 10px 20px; border: none; background: #e5e7eb; color: #374151; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-shopping-cart"></i> All Orders
                    </button>
                    <button class="storefront-tab" data-tab="uncredited" style="padding: 10px 20px; border: none; background: #e5e7eb; color: #374151; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> Uncredited <span id="uncreditedBadge" style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;">0</span>
                    </button>
                </div>

                <!-- Stores Tab Content -->
                <div id="storesTabContent" class="tab-content">
                    <div class="storefront-filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="storeSearchInput" placeholder="Search stores..." style="padding: 10px 15px; border: 1px solid #e5e7eb; border-radius: 8px; min-width: 200px;">
                        <select id="storeStatusFilter" style="padding: 10px 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <option value="">All Status</option>
                            <option value="ACTIVE">Active</option>
                            <option value="SUSPENDED">Suspended</option>
                            <option value="INACTIVE">Inactive</option>
                        </select>
                    </div>
                    <div class="storefront-table-container" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Store</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151;">Owner</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Orders</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Revenue</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Paystack</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Status</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="storefrontsTableBody">
                                <tr><td colspan="7" style="padding: 40px; text-align: center; color: #6b7280;">Loading stores...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Tab Content -->
                <div id="ordersTabContent" class="tab-content" style="display: none;">
                    <div class="order-filters" style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                        <input type="text" id="orderSearchInput" placeholder="Search by phone, name, order ID..." style="padding: 10px 15px; border: 1px solid #e5e7eb; border-radius: 8px; min-width: 250px;">
                        <select id="orderPaymentMethodFilter" style="padding: 10px 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <option value="">All Payment Methods</option>
                            <option value="MOMO">MoMo</option>
                            <option value="PAYSTACK">Paystack</option>
                        </select>
                        <select id="orderProfitStatusFilter" style="padding: 10px 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                            <option value="">All Profit Status</option>
                            <option value="credited">Credited</option>
                            <option value="pending">Pending</option>
                        </select>
                        <div style="display: flex; align-items: center; gap: 8px; background: #f9fafb; padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <label style="font-size: 0.85rem; color: #6b7280; white-space: nowrap;">From:</label>
                            <input type="date" id="orderDateFrom" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.85rem;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; background: #f9fafb; padding: 8px 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <label style="font-size: 0.85rem; color: #6b7280; white-space: nowrap;">To:</label>
                            <input type="date" id="orderDateTo" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.85rem;">
                        </div>
                        <button onclick="clearOrderDateFilters()" style="padding: 10px 15px; background: #e5e7eb; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem;" title="Clear date filters">
                            <i class="fas fa-times"></i> Clear Dates
                        </button>
                    </div>
                    <div class="orders-table-container" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 0.85rem;">Order ID</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 0.85rem;">Store</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 0.85rem;">Customer</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 0.85rem;">Bundle</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; font-size: 0.85rem;">Amount</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; font-size: 0.85rem;">Method</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; font-size: 0.85rem;">Status</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; font-size: 0.85rem;">Profit</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; font-size: 0.85rem;">Date</th>
                                </tr>
                            </thead>
                            <tbody id="storefrontOrdersTableBody">
                                <tr><td colspan="9" style="padding: 40px; text-align: center; color: #6b7280;">Loading orders...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="ordersPagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
                </div>

                <!-- Uncredited Tab Content -->
                <div id="uncreditedTabContent" class="tab-content" style="display: none;">
                    <div class="uncredited-notice" style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-circle" style="color: #f59e0b; font-size: 1.2rem;"></i>
                        <div>
                            <strong>Uncredited Profits</strong>
                            <p style="margin: 0; font-size: 0.9rem; color: #92400e;">These orders are COMPLETED but agent profits haven't been credited yet. Click "Retry" to process them.</p>
                        </div>
                    </div>
                    <div class="uncredited-table-container" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #fef3c7; border-bottom: 2px solid #f59e0b;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #92400e;">Store</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #92400e;">Agent</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #92400e;">Bundle</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #92400e;">Customer Paid</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #92400e;">Agent Profit</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #92400e;">Platform Profit</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #92400e;">Completed</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #92400e;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="uncreditedTableBody">
                                <tr><td colspan="8" style="padding: 40px; text-align: center; color: #6b7280;">Loading uncredited orders...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Bundle Modal (Alternative) -->
    <div class="user-modal" id="bundleModalAdd">
        <div class="user-modal-content" style="max-width: 500px;">
            <div class="user-modal-header" style="background: #024959;">
                <h3><i class="fas fa-plus-circle"></i> <span id="bundleModalTitleAdd">Add New Bundle</span></h3>
                <button class="modal-close" id="closeBundleModalAddBtn">&times;</button>
            </div>
            <div class="user-modal-body">
                <form id="bundleFormAdd">
                    <input type="hidden" id="bundleIdAdd">
                    <input type="hidden" id="bundleNetworkAdd">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bundle Name *</label>
                            <input type="text" id="bundleNameAdd" placeholder="e.g., Daily 1GB" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Capacity (MB/GB) *</label>
                            <input type="text" id="bundleCapacityAdd" placeholder="e.g., 1GB or 500MB" required>
                        </div>
                        <div class="form-group">
                            <label>Validity *</label>
                            <input type="text" id="bundleValidityAdd" placeholder="e.g., 1 Day, 7 Days" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cost Price (GH) *</label>
                            <input type="number" id="bundleCostPriceAdd" step="0.01" min="0" placeholder="Admin cost" required>
                        </div>
                        <div class="form-group">
                            <label>Partner Price (GH)</label>
                            <input type="number" id="bundlePartnerPriceAdd" step="0.01" min="0" placeholder="Partner price">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Super-Dealer Price (GH)</label>
                            <input type="number" id="bundleSuperDealerPriceAdd" step="0.01" min="0" placeholder="Super-Dealer price">
                        </div>
                        <div class="form-group">
                            <label>Dealer Price (GH)</label>
                            <input type="number" id="bundleDealerPriceAdd" step="0.01" min="0" placeholder="Dealer price">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Super-Agent Price (GH)</label>
                            <input type="number" id="bundleSuperAgentPriceAdd" step="0.01" min="0" placeholder="Super-Agent price">
                        </div>
                        <div class="form-group">
                            <label>Agent Price (GH) *</label>
                            <input type="number" id="bundleAgentPriceAdd" step="0.01" min="0" placeholder="Agent price" required>
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> Only roles with prices set can purchase this bundle.
                    </p>
                </form>
            </div>
            <div class="user-modal-footer">
                        <button type="button" class="btn-cancel" id="cancelBundleModalBtn">Cancel</button>
                <button type="button" class="btn-save" id="saveBundleModalBtn">
                    <i class="fas fa-save"></i> Save Bundle
                </button>
            </div>
        </div>
    </div>

    <!-- Transaction History Modal -->
    <div class="modal-overlay" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Transaction History - <span id="modalUserName"></span></h3>
                <button class="modal-close" id="closeTransactionModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="transactionList">
                <p>Loading transactions...</p>
            </div>
        </div>
    </div>

    <!-- Add Incoming Payment Modal -->
    <div class="add-payment-modal" id="addPaymentModal">
        <div class="add-payment-content">
            <div class="add-payment-header">
                <h3><i class="fas fa-plus-circle"></i> Add Incoming Payment</h3>
                <button class="modal-close" id="closeAddPaymentModalBtn">&times;</button>
            </div>
            <div class="add-payment-body">
                <form id="addPaymentForm">
                    <div class="form-group">
                        <label>Transaction ID *</label>
                        <input type="text" id="newPaymentTxnId" placeholder="e.g., 72242984707" required>
                    </div>
                    <div class="form-group">
                        <label>Amount (GHS) *</label>
                        <input type="number" id="newPaymentAmount" step="0.01" min="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label>Sender Name</label>
                        <input type="text" id="newPaymentSenderName" placeholder="e.g., James Cobbinah">
                    </div>
                    <div class="form-group">
                        <label>Sender Phone</label>
                        <input type="text" id="newPaymentPhone" placeholder="e.g., 0241234567">
                    </div>
                    <div class="form-group">
                        <label>Network</label>
                        <select id="newPaymentNetwork">
                            <option value="MTN">MTN</option>
                            <option value="Vodafone">Vodafone</option>
                            <option value="AirtelTigo">AirtelTigo</option>
                            <option value="UNKNOWN">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Reference</label>
                        <input type="text" id="newPaymentRef" placeholder="Reference (optional)">
                    </div>
                </form>
            </div>
            <div class="add-payment-footer">
                <button type="button" class="btn-fund" style="background: #6b7280;" id="cancelAddPaymentModalBtn">Cancel</button>
                <button type="button" class="btn-fund" id="addIncomingPaymentBtn">
                    <i class="fas fa-plus"></i> Add Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Verify Claim Modal -->
    <div class="add-payment-modal" id="verifyClaimModal">
        <div class="add-payment-content" style="max-width: 450px;">
            <div class="add-payment-header" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                <h3><i class="fas fa-shield-alt"></i> Verify Claim</h3>
                <button class="modal-close" onclick="closeVerifyClaimModal()">&times;</button>
            </div>
            <div class="add-payment-body">
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #86efac;">
                    <h4 style="color: #166534; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Claim Information</h4>
                    <div style="display: grid; gap: 8px; color: #374151;">
                        <div><strong>User:</strong> <span id="verifyClaimUser">-</span></div>
                        <div><strong>Submitted:</strong> <span id="verifyClaimDate">-</span></div>
                    </div>
                </div>
                
                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fcd34d;">
                    <p style="color: #92400e; margin: 0; font-size: 0.9rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Enter the <strong>Transaction ID</strong> and <strong>Amount</strong> exactly as shown in your MoMo message to verify this claim.
                    </p>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600;">Transaction ID *</label>
                    <input type="text" id="verifyTransactionId" placeholder="Enter transaction ID from MoMo message" required style="font-family: monospace;">
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">Amount (GHS) *</label>
                    <input type="number" id="verifyAmount" step="0.01" min="0.01" placeholder="Enter exact amount" required>
                </div>
            </div>
            <div class="add-payment-footer" style="display: flex; gap: 10px;">
                <button type="button" class="btn-fund" style="background: #6b7280; flex: 1;" onclick="closeVerifyClaimModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn-fund" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); flex: 1;" onclick="submitClaimVerification()">
                    <i class="fas fa-check-circle"></i> Verify & Approve
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal (Alternative) -->
    <div class="user-modal" id="userModalAlt">
        <div class="user-modal-content">
            <div class="user-modal-header">
                <h3><i class="fas fa-user-plus"></i> <span id="userModalTitleAlt">Add New User</span></h3>
                <button class="modal-close" id="closeUserModalAltBtn">&times;</button>
            </div>
            <div class="user-modal-body">
                <form id="userFormAdd">
                    <input type="hidden" id="editUserIdAdd">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" id="userFullNameAdd" placeholder="e.g., Kwame Asante" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="text" id="userPhoneAdd" placeholder="e.g., 0241234567" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="userEmailAdd" placeholder="e.g., user@example.com">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="userStatusAdd">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Initial Balance (GH)</label>
                            <input type="number" id="userBalanceAdd" step="0.01" min="0" value="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label>Network Preference</label>
                            <select id="userNetworkAdd">
                                <option value="">No Preference</option>
                                <option value="MTN">MTN</option>
                                <option value="Vodafone">Vodafone</option>
                                <option value="AirtelTigo">AirtelTigo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Notes</label>
                        <input type="text" id="userNotesAdd" placeholder="Optional notes about this user">
                    </div>
                </form>
            </div>
            <div class="user-modal-footer">
                <button class="btn-modal cancel" id="cancelUserModalAltBtn">Cancel</button>
                <button class="btn-modal save" id="saveUserAltBtn">
                    <i class="fas fa-save"></i> Save User
                </button>
            </div>
        </div>
    </div>

    <!-- View User Detail Modal (Alternative) -->
    <div class="user-modal" id="viewUserModalAlt">
        <div class="user-modal-content">
            <div class="user-modal-header">
                <h3><i class="fas fa-user"></i> User Details</h3>
                <button class="modal-close" id="closeViewUserModalAltBtn">&times;</button>
            </div>
            <div class="user-modal-body" id="viewUserContentAlt">
                <!-- Dynamic content -->
            </div>
            <div class="user-modal-footer">
                <button class="btn-modal cancel" id="closeViewUserModalAltBtn2">Close</button>
                <button class="btn-modal save" id="editUserFromViewAltBtn">
                    <i class="fas fa-edit"></i> Edit User
                </button>
            </div>
        </div>
    </div>

    <script src="../public/js/dashboard-nav.js"></script>
    <script>
        // Auth Check - verify user is logged in as admin (uses httpOnly cookies)
        // Auth is handled via httpOnly cookies - verify session on load
        (async function verifySession() {
            try {
                const res = await fetch('/api/auth/me', {
                    credentials: 'include' // Important: send cookies
                });
                if (!res.ok) {
                    console.error('Session invalid, redirecting to login');
                    window.location.href = '../pages/login.html';
                    return;
                }
                const data = await res.json();
                // Verify user is admin
                if (data.role !== 'ADMIN') {
                    console.error('User is not admin, redirecting');
                    window.location.href = '../pages/login.html';
                }
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = '../pages/login.html';
            }
        })();

        // ========== ADMIN API HELPER ==========
        // Helper function for authenticated API calls using httpOnly cookies
        async function adminFetch(url, options = {}) {
            // Add cache-busting for GET requests to prevent stale data
            let finalUrl = url;
            if (!options.method || options.method === 'GET') {
                const separator = url.includes('?') ? '&' : '?';
                finalUrl = `${url}${separator}_t=${Date.now()}`;
            }
            
            const defaultOptions = {
                credentials: 'include', // Important: send httpOnly cookies
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache',
                    ...options.headers
                }
            };
            return fetch(finalUrl, { ...defaultOptions, ...options, headers: { ...defaultOptions.headers, ...options.headers } });
        }

        // ========== PROFESSIONAL MODAL SYSTEM ==========
        // Replaces window.confirm and window.prompt with professional modals
        
        let confirmModalResolve = null;
        
        /**
         * Show a professional confirmation modal
         * @param {Object} options - Modal configuration
         * @param {string} options.title - Modal title
         * @param {string} options.message - Modal message  
         * @param {string} options.type - 'warning' | 'danger' | 'success' | 'info'
         * @param {string} options.confirmText - Text for confirm button
         * @param {string} options.cancelText - Text for cancel button
         * @param {boolean} options.showInput - Whether to show input field
         * @param {string} options.inputLabel - Label for input field
         * @param {string} options.inputPlaceholder - Placeholder for input
         * @param {string} options.inputType - Input type (text, number, etc)
         * @returns {Promise} - Resolves with true/input value or false
         */
        function showConfirmModal(options = {}) {
            return new Promise((resolve) => {
                confirmModalResolve = resolve;
                
                const modal = document.getElementById('confirmModal');
                const icon = document.getElementById('confirmModalIcon');
                const title = document.getElementById('confirmModalTitle');
                const message = document.getElementById('confirmModalMessage');
                const inputSection = document.getElementById('confirmModalInputSection');
                const inputLabel = document.getElementById('confirmModalInputLabel');
                const input = document.getElementById('confirmModalInput');
                const confirmBtn = document.getElementById('confirmModalConfirm');
                const cancelBtn = document.getElementById('confirmModalCancel');
                
                // Set content
                title.textContent = options.title || 'Confirm Action';
                message.textContent = options.message || 'Are you sure you want to proceed?';
                
                // Set icon type
                const iconTypes = {
                    warning: { class: 'warning', icon: 'fa-exclamation-triangle' },
                    danger: { class: 'danger', icon: 'fa-trash-alt' },
                    success: { class: 'success', icon: 'fa-check-circle' },
                    info: { class: 'info', icon: 'fa-info-circle' }
                };
                const iconConfig = iconTypes[options.type] || iconTypes.warning;
                icon.className = `confirm-modal-icon ${iconConfig.class}`;
                icon.innerHTML = `<i class="fas ${iconConfig.icon}"></i>`;
                
                // Set button styles
                confirmBtn.className = `confirm-modal-btn confirm ${options.type === 'danger' ? 'danger' : options.type === 'success' ? 'success' : ''}`;
                confirmBtn.innerHTML = `<i class="fas fa-check"></i> ${options.confirmText || 'Confirm'}`;
                cancelBtn.innerHTML = `<i class="fas fa-times"></i> ${options.cancelText || 'Cancel'}`;
                
                // Handle input field
                if (options.showInput) {
                    inputSection.style.display = 'block';
                    inputLabel.textContent = options.inputLabel || 'Enter value:';
                    input.placeholder = options.inputPlaceholder || '';
                    input.type = options.inputType || 'text';
                    input.value = options.inputDefault || '';
                    setTimeout(() => input.focus(), 100);
                } else {
                    inputSection.style.display = 'none';
                    input.value = '';
                }
                
                // Show modal
                modal.classList.add('active');
            });
        }
        
        function closeConfirmModal(result) {
            const modal = document.getElementById('confirmModal');
            const input = document.getElementById('confirmModalInput');
            modal.classList.remove('active');
            
            if (confirmModalResolve) {
                if (result === true && document.getElementById('confirmModalInputSection').style.display !== 'none') {
                    confirmModalResolve(input.value);
                } else {
                    confirmModalResolve(result);
                }
                confirmModalResolve = null;
            }
        }
        
        // Modal event listeners
        document.getElementById('confirmModalCancel')?.addEventListener('click', () => closeConfirmModal(false));
        document.getElementById('confirmModalConfirm')?.addEventListener('click', () => closeConfirmModal(true));
        document.getElementById('confirmModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') closeConfirmModal(false);
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('confirmModal')?.classList.contains('active')) {
                closeConfirmModal(false);
            }
            if (e.key === 'Enter' && document.getElementById('confirmModal')?.classList.contains('active')) {
                closeConfirmModal(true);
            }
        });

        // ========== UTC TIME HELPERS ==========
        // All times use UTC/GMT - day resets at midnight UTC
        
        // Get today's date in UTC (YYYY-MM-DD)
        function getTodayUTC() {
            return new Date().toISOString().split('T')[0];
        }
        
        // Get current UTC timestamp
        function getCurrentTimestampUTC() {
            return new Date().toISOString();
        }
        
        // Check if a date string is from today (UTC)
        function isTodayUTC(dateStr) {
            if (!dateStr) return false;
            try {
                const date = new Date(dateStr);
                return date.toISOString().split('T')[0] === getTodayUTC();
            } catch (e) {
                return false;
            }
        }
        
        // Get UTC date X days ago
        function getDateDaysAgoUTC(days) {
            const date = new Date();
            date.setUTCDate(date.getUTCDate() - days);
            return date.toISOString().split('T')[0];
        }
        
        // Format date for display (UTC with GMT indicator)
        function formatDateTimeUTC(dateStr) {
            if (!dateStr) return 'N/A';
            const d = new Date(dateStr);
            const day = d.getUTCDate();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[d.getUTCMonth()];
            const year = d.getUTCFullYear();
            const hours = String(d.getUTCHours()).padStart(2, '0');
            const minutes = String(d.getUTCMinutes()).padStart(2, '0');
            const suffix = (day > 3 && day < 21) ? 'th' : ['th', 'st', 'nd', 'rd', 'th'][Math.min(day % 10, 4)];
            return `${day}${suffix} ${month} ${year} at ${hours}:${minutes} GMT`;
        }
        
        // Get current UTC time display
        function getCurrentTimeUTC() {
            const now = new Date();
            return now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
        }

        // Greeting based on UTC time
        function updateGreeting() {
            const hour = new Date().getUTCHours();
            let greeting, emoji;
            if (hour < 12) { greeting = 'Good morning'; emoji = ''; }
            else if (hour < 17) { greeting = 'Good afternoon'; emoji = ''; }
            else if (hour < 21) { greeting = 'Good evening'; emoji = ''; }
            else { greeting = 'Good night'; emoji = ''; }
            document.getElementById('greetingText').textContent = `${greeting}, Admin ${emoji}`;
        }

        // Show loading skeleton on stat cards
        function showStatsSkeleton() {
            const statIds = ['walletBalance', 'ordersToday', 'amountToday', 'bundleToday', 
                            'pendingCount', 'processingCount', 'completedCount', 'cancelledCount',
                            'totalSold', 'totalProfit'];
            statIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.innerHTML = '<div class="skeleton skeleton-text short" style="width: 80px; height: 24px; margin: 0 auto;"></div>';
                }
            });
            // Show table skeleton
            showTableSkeleton('ordersTableBody', 11);
        }

        // Load Stats (using UTC dates)
        async function loadStats() {
            // Show loading skeletons
            showStatsSkeleton();
            
            try {
                // Fetch orders from OrderGroup API (returns flat list for compatibility)
                const res = await adminFetch('/api/order-groups/admin/all?limit=200&compact=true');
                if (!res.ok) throw new Error('Failed to fetch orders');
                const data = await res.json();
                const orders = data.orders || [];
                ordersCache = orders; // Store for filtering
                const todayUTC = getTodayUTC();
                
                // Fetch total wallet balance from all users
                try {
                    const usersRes = await adminFetch('/api/users');
                    if (usersRes.ok) {
                        const usersData = await usersRes.json();
                        const users = usersData.users || [];
                        let totalWalletBalance = 0;
                        
                        // Fetch wallet balance for each user
                        await Promise.all(users.map(async u => {
                            try {
                                const walletRes = await adminFetch(`/api/wallet?userId=${u.id}`);
                                if (walletRes.ok) {
                                    const wallet = await walletRes.json();
                                    totalWalletBalance += parseFloat(wallet.balance) || 0;
                                }
                            } catch {}
                        }));
                        
                        document.getElementById('walletBalance').textContent = 'GH ' + totalWalletBalance.toFixed(2);
                    }
                } catch (walletErr) {
                    console.error('Failed to fetch wallet balances:', walletErr);
                }

                // Today's orders (based on UTC date)
                const todayOrders = orders.filter(o => {
                    if (!o.createdAt) return false;
                    try {
                        return new Date(o.createdAt).toISOString().split('T')[0] === todayUTC;
                    } catch (e) {
                        return false;
                    }
                });

                let todayAmount = 0;
                let todayBundle = 0;
                let totalSold = 0;
                let totalCost = 0;

                // Create bundle lookup for cost calculation
                const bundles = bundleTariffsData || [];
                const bundleLookup = {};
                bundles.forEach(b => {
                    const key = `${b.network}-${b.name}`;
                    bundleLookup[key] = {
                        agent: parseFloat(b.agent || b.agentPrice || 0),
                        price: parseFloat(b.price || 0)
                    };
                });

                // Bundle Today = total data size purchased today (from bundle.dataAmount like "5GB")
                // Amount Today = amount from completed orders today only
                todayOrders.forEach(o => {
                    // Parse data amount from bundle (e.g., "5GB" -> 5)
                    const dataAmount = o.bundle?.dataAmount || o.dataAmount || '';
                    const dataSize = parseInt(dataAmount.replace(/\D/g, '')) || 0;
                    todayBundle += dataSize * (parseInt(o.quantity) || 1);
                    
                    // Only count completed orders for amount today
                    const status = (o.status || '').toLowerCase();
                    if (status === 'completed') {
                        todayAmount += parseFloat(o.totalPrice || o.total) || 0;
                    }
                });

                // Calculate total sold and total cost for profit (today's completed orders only)
                todayOrders.filter(o => o.status === 'COMPLETED' || o.status === 'completed').forEach(o => {
                    const orderPrice = parseFloat(o.totalPrice || o.total) || 0;
                    totalSold += orderPrice;
                    
                    // Get cost from bundle lookup
                    const bundleNetwork = o.bundle?.network || o.network || 'MTN';
                    const bundleName = o.bundle?.name || '';
                    const bundleKey = `${bundleNetwork}-${bundleName}`;
                    const bundleInfo = bundleLookup[bundleKey];
                    
                    if (bundleInfo && bundleInfo.agent) {
                        totalCost += bundleInfo.agent * (parseInt(o.quantity) || 1);
                    } else {
                        // Estimate cost as 95% of price if no bundle info
                        totalCost += orderPrice * 0.95;
                    }
                });

                // Calculate actual profit
                const totalProfit = totalSold - totalCost;

                // Update main stats
                document.getElementById('ordersToday').textContent = todayOrders.length.toLocaleString();
                document.getElementById('amountToday').textContent = 'GH ' + todayAmount.toFixed(2);
                document.getElementById('bundleToday').textContent = todayBundle + ' GB';
                document.getElementById('totalSold').textContent = 'GH ' + totalSold.toFixed(2);
                document.getElementById('totalProfit').textContent = 'GH ' + totalProfit.toFixed(2);

                // Calculate order status stats (today's orders only - fresh day fresh start)
                const stats = {
                    pending: { count: 0, amount: 0, capacity: 0 },
                    processing: { count: 0, amount: 0, capacity: 0 },
                    completed: { count: 0, amount: 0, capacity: 0 },
                    cancelled: { count: 0, amount: 0, capacity: 0 }
                };

                todayOrders.forEach(o => {
                    const status = (o.status || 'pending').toLowerCase();
                    const amount = parseFloat(o.totalPrice || o.total) || 0;
                    const bundle = parseInt(o.quantity || o.bundle) || 0;
                    if (stats[status]) {
                        stats[status].count++;
                        stats[status].amount += amount;
                        stats[status].capacity += bundle;
                    }
                });

                // Update status cards
                ['pending', 'processing', 'completed', 'cancelled'].forEach(status => {
                    document.getElementById(status + 'Count').textContent = stats[status].count;
                    document.getElementById(status + 'Amount').textContent = 'GH ' + stats[status].amount.toFixed(2);
                    document.getElementById(status + 'Capacity').textContent = stats[status].capacity;
                });

                // All orders total (today's orders only - fresh day fresh start)
                const allAmount = todayOrders.reduce((sum, o) => sum + (parseFloat(o.totalPrice || o.total) || 0), 0);
                const allCapacity = todayOrders.reduce((sum, o) => sum + (parseInt(o.quantity || o.bundle) || 0), 0);
                document.getElementById('allCount').textContent = todayOrders.length;
                document.getElementById('allAmount').textContent = 'GH ' + allAmount.toFixed(2);
                document.getElementById('allCapacity').textContent = allCapacity;

                // Update network pending counts (only today's pending orders - fresh day fresh start)
                const pendingOrders = todayOrders.filter(o => (o.status || '').toLowerCase() === 'pending');
                const networkPending = { MTN: 0, Telecel: 0, AirtelTigo: 0 };
                pendingOrders.forEach(o => {
                    const net = (o.bundle?.network || o.network || '').toUpperCase();
                    if (net.includes('MTN')) networkPending.MTN++;
                    else if (net.includes('TELECEL')) networkPending.Telecel++;
                    else if (net.includes('AIRTELTIGO') || net.includes('AIRTEL')) networkPending.AirtelTigo++;
                });

                // Update network filter buttons pending counts
                const mtnEl = document.getElementById('mtnFilterPending');
                const telecelEl = document.getElementById('telecelFilterPending');
                const airteltigoEl = document.getElementById('airteltigoFilterPending');
                if (mtnEl) mtnEl.textContent = networkPending.MTN > 0 ? networkPending.MTN + ' Pending' : '0 Pending';
                if (telecelEl) telecelEl.textContent = networkPending.Telecel > 0 ? networkPending.Telecel + ' Pending' : '0 Pending';
                if (airteltigoEl) airteltigoEl.textContent = networkPending.AirtelTigo > 0 ? networkPending.AirtelTigo + ' Pending' : '0 Pending';

                // Load orders table - show only today's orders by default (fresh day fresh orders)
                loadOrdersTable(todayOrders);
            } catch (err) {
                showToast('Failed to load orders: ' + err.message, 'error');
            }
        }
        
        // Generate agent code from user ID
        function generateAgentCode(userId) {
            if (!userId) return 'KDP-0000';
            // Create a 4-digit code from the last characters of the user ID
            const hash = userId.toString().replace(/-/g, '').slice(-4);
            const numericCode = parseInt(hash, 16) % 10000 || parseInt(userId.slice(-4)) || 1000;
            return 'KDP-' + String(numericCode).padStart(4, '0');
        }
        
        // Format order number with leading zeros (0001, 0002, etc.)
        function formatOrderNumber(index, totalOrders) {
            // Order numbers are 1-based, with newest being the highest number
            const orderNum = totalOrders - index;
            return String(orderNum).padStart(4, '0');
        }
        
        // Load orders into table
        function loadOrdersTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            const perPage = parseInt(document.getElementById('ordersPerPage')?.value || 50);
            const pageInfo = document.getElementById('ordersPageInfo');
            
            if (!orders || orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11">
                            ${createEmptyState(
                                'fas fa-inbox',
                                'No Orders Yet',
                                'Orders will appear here when customers make purchases',
                                null,
                                null
                            )}
                        </td>
                    </tr>
                `;
                if (pageInfo) pageInfo.textContent = 'Showing 0 orders';
                return;
            }
            
            // Sort orders by date descending (newest first)
            const sortedOrders = [...orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const totalDisplayed = sortedOrders.length;
            
            // Use total orders from cache for continuous numbering across all days
            const allOrdersSorted = [...ordersCache].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const totalAllOrders = ordersCache.length;
            
            // Update page info
            const showCount = Math.min(totalDisplayed, perPage);
            if (pageInfo) pageInfo.textContent = `Showing ${showCount} of ${totalDisplayed} orders`;
            
            const html = sortedOrders.slice(0, perPage).map((o, idx) => {
                const bundle = o.bundle || {};
                const agentName = o.user?.name || o.customerName || 'Unknown';
                const agentCode = generateAgentCode(o.userId || o.user?.id);
                // Use displayId (group order ID) for tracking - all items in a batch share the same ID
                const orderId = o.displayId || o.orderGroupId || formatOrderNumber(idx, totalAllOrders);
                return `
                <tr data-order-id="${o.id}" data-display-id="${o.displayId || ''}">
                    <td><input type="checkbox" class="order-checkbox" value="${o.id}"></td>
                    <td>${formatDate(o.createdAt)}</td>
                    <td class="agent-name">${agentName} ${agentCode}</td>
                    <td class="order-id" style="font-weight:600;color:#1e3a5f;">${orderId}</td>
                    <td>${o.recipientPhone || o.phone || o.recipient || 'N/A'}</td>
                    <td>${bundle.network || o.network || 'N/A'}</td>
                    <td>${bundle.dataAmount || o.dataAmount || ''}</td>
                    <td>${parseFloat(o.totalPrice || o.total || 0).toFixed(2)}</td>
                    <td><span class="badge badge-${(o.paymentStatus || 'COMPLETED').toLowerCase() === 'completed' ? 'completed' : 'pending'}">${(o.paymentStatus || 'COMPLETED')}</span></td>
                    <td><span class="badge badge-${(o.status || 'PENDING').toLowerCase()}">${o.status || 'PENDING'}</span></td>
                    <td>
                        <div class="action-icons">
                            <button class="action-icon cancel" data-action="cancel-order" data-id="${o.id}" title="Cancel">
                                <i class="fas fa-times"></i>
                            </button>
                            <button class="action-icon complete" data-action="complete-order" data-id="${o.id}" title="Complete">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="action-icon view" data-action="view-order" data-id="${o.id}" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
            tbody.innerHTML = html;
        }
        
        // Format date helper
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-GB', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        // ========== FILTER FUNCTIONALITY ==========
        let currentFilters = {
            date: '',
            orderNo: '',
            agentCode: '',
            phone: '',
            network: '',
            status: '',
            payment: ''
        };
        
        // Apply filters to orders
        // Orders cache for filtering
        let ordersCache = [];
        async function calculateReportStats() {
            try {
                const res = await adminFetch('/api/order-groups/admin/all?limit=200&compact=true');
                if (!res.ok) throw new Error('Failed to fetch orders');
                const data = await res.json();
                const orders = data.orders || [];
                // Filter orders by current report period
                const now = new Date();
                let startDate;
                switch (currentReportPeriod) {
                    case 'today':
                        startDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));
                        break;
                    case 'year':
                        startDate = new Date(Date.UTC(now.getUTCFullYear(), 0, 1, 0, 0, 0));
                        break;
                    default:
                        startDate = null;
                }
                const filtered = startDate ? orders.filter(o => new Date(o.createdAt) >= startDate) : orders;
                // Use bundleTariffsData for bundle info
                const bundles = bundleTariffsData;
                const bundleLookup = {};
                bundles.forEach(b => {
                    const key = `${b.network}-${b.name}`;
                    bundleLookup[key] = {
                        agent: parseFloat(b.agent || b.agentPrice || 0),
                        price: parseFloat(b.price || 0),
                        capacity: parseFloat(b.capacity || 0)
                    };
                });
                let totalOrders = filtered.length;
                let totalData = 0;
                let totalCost = 0;
                let totalRevenue = 0;
                filtered.forEach(o => {
                    // Get bundle info from API response structure
                    const bundleNetwork = o.bundle?.network || o.network || 'MTN';
                    const bundleName = o.bundle?.name || '';
                    const bundleKey = `${bundleNetwork}-${bundleName}`;
                    const bundleInfo = bundleLookup[bundleKey];
                    
                    // Calculate data from bundle.dataAmount
                    let dataGB = 0;
                    const dataAmount = o.bundle?.dataAmount || '';
                    if (dataAmount) {
                        const match = dataAmount.match(/(\d+\.?\d*)\s*(GB|MB)?/i);
                        if (match) {
                            dataGB = match[2]?.toUpperCase() === 'MB' ? parseFloat(match[1]) / 1000 : parseFloat(match[1]);
                        }
                    } else if (bundleInfo && bundleInfo.capacity) {
                        dataGB = bundleInfo.capacity;
                    }
                    totalData += dataGB * (parseInt(o.quantity) || 1);
                    
                    // Revenue from totalPrice
                    const price = parseFloat(o.totalPrice || o.total || o.amount || 0);
                    totalRevenue += price;
                    
                    // Cost calculation
                    if (bundleInfo) {
                        totalCost += bundleInfo.agent * (parseInt(o.quantity) || 1);
                    } else {
                        totalCost += price * 0.95;
                    }
                });
                const totalProfit = totalRevenue - totalCost;
                document.getElementById('reportTotalOrders').textContent = totalOrders;
                document.getElementById('reportTotalData').textContent = totalData.toFixed(0);
                document.getElementById('reportTotalRevenue').textContent = `GH ${totalRevenue.toFixed(2)}`;
                document.getElementById('reportTotalProfit').textContent = `GH ${totalProfit.toFixed(2)}`;
            } catch (err) {
                showToast('Error loading report stats: ' + err.message, 'error');
            }
        }
        
        // Clear all filters
        function clearFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterOrderNoMain').value = '';
            document.getElementById('filterAgentCode').value = '';
            document.getElementById('filterPhoneMain').value = '';
            document.getElementById('filterNetwork').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPayment').value = '';
            
            document.querySelectorAll('.network-filter-btn').forEach(btn => btn.classList.remove('active'));
            
            currentFilters = { date: '', orderNo: '', agentCode: '', phone: '', network: '', status: '', payment: '' };
            loadStats();
        }
        
        // Add filter event listeners
        function initFilterListeners() {
            const filterInputs = ['filterDate', 'filterOrderNoMain', 'filterAgentCode', 'filterPhoneMain', 'filterNetwork', 'filterStatus', 'filterPayment'];
            
            filterInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', applyFilters);
                    if (el.tagName === 'INPUT' && el.type !== 'date') {
                        el.addEventListener('keyup', debounce(applyFilters, 300));
                    }
                }
            });
        }
        
        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Order actions - using OrderGroup item API
        async function completeOrder(orderId) {
            const confirmed = await showConfirmModal({
                title: 'Complete Order',
                message: 'Mark this order as completed? This will update the order status.',
                type: 'success',
                confirmText: 'Complete',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            try {
                const res = await adminFetch(`/api/order-groups/admin/item/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'COMPLETED' })
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to update order');
                }
                showToast('Order marked as completed');
                loadStats();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }

        async function cancelOrder(orderId) {
            const confirmed = await showConfirmModal({
                title: 'Cancel Order',
                message: 'Cancel this order and issue a refund to the customer wallet?',
                type: 'danger',
                confirmText: 'Cancel & Refund',
                cancelText: 'Keep Order'
            });
            if (!confirmed) return;
            try {
                const res = await adminFetch(`/api/order-groups/admin/item/${orderId}/cancel`, {
                    method: 'POST'
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to cancel order');
                }
                const result = await res.json();
                showToast(result.message || 'Order cancelled and refunded');
                loadStats();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        function viewOrder(orderId) {
            const order = ordersCache.find(o => o.id == orderId);
            if (order) {
                const bundle = order.bundle || {};
                const displayId = order.displayId || 'N/A';
                alert(`Order: ${displayId}\nItem ID: ${order.id}\n\nNetwork: ${bundle.network || order.network}\nBundle: ${bundle.name || order.dataAmount || ''}\nRecipient: ${order.recipientPhone || order.phone || 'N/A'}\nTotal: GH ${parseFloat(order.totalPrice || order.total || 0).toFixed(2)}\nOrder Status: ${order.status || 'PENDING'}\nPayment Status: ${order.paymentStatus || 'COMPLETED'}`);
            }
        }
        
        // Select all checkbox
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = checked);
        }
        
        // Get selected orders
        function getSelectedOrders() {
            return Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
        }

        // Network tab click handler - Copy pending orders and mark as processing
        document.querySelectorAll('.network-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const network = this.dataset.network;
                // Copy pending orders and mark as processing (no tab switching)
                copyAndProcessPendingOrders(network);
            });
        });
        
        // Copy pending orders and mark as processing
        async function copyAndProcessPendingOrders(network) {
            // Use ordersCache
            const pendingOrders = ordersCache.filter(o => {
                if ((o.status || '').toLowerCase() !== 'pending') return false;
                const net = (o.bundle?.network || o.network || '').toUpperCase();
                if (network === 'MTN') return net.includes('MTN');
                if (network === 'Telecel') return net.includes('TELECEL');
                if (network === 'AirtelTigo') return net.includes('AIRTELTIGO') || net.includes('AIRTEL');
                return false;
            });
            if (pendingOrders.length === 0) {
                showToast(`No pending ${network} orders`, 'error');
                applyFilters();
                return;
            }
            // Format orders for copying (phone numbers, one per line)
            // Remove "GB" from bundle name
            const copyText = pendingOrders.map(o => {
                const phone = o.recipientPhone || o.recipient || '';
                let bundle = o.bundle?.dataAmount || o.bundle?.name || o.dataAmount || o.bundle || '';
                // Remove GB suffix for cleaner copy
                bundle = String(bundle).replace(/\s*GB$/i, '').replace(/\s*gb$/i, '').trim();
                return `${phone} ${bundle}`;
            }).join('\n');
            
            // Copy to clipboard
            try {
                await navigator.clipboard.writeText(copyText);
                showToast(`${pendingOrders.length} ${network} orders copied. Marking as processing...`);
            } catch (err) {
                showToast('Failed to copy to clipboard', 'error');
                console.error('Clipboard error:', err);
                return;
            }
            
            // Mark all pending orders as PROCESSING
            let successCount = 0;
            for (const order of pendingOrders) {
                try {
                    // Try new OrderItem endpoint first, fallback to legacy
                    let res = await adminFetch(`/api/order-groups/admin/item/${order.id}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'PROCESSING' })
                    });
                    if (!res.ok) {
                        // Try legacy order endpoint
                        res = await adminFetch(`/api/orders/${order.id}/status`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'PROCESSING' })
                        });
                    }
                    if (res.ok) successCount++;
                } catch (err) {
                    console.error(`Failed to update order ${order.id}:`, err);
                }
            }
            
            // Refresh the orders list
            await loadStats();
            showToast(`${successCount}/${pendingOrders.length} orders marked as processing`);
        }
        
        // Apply all filters
        function applyFilters() {
            const todayUTC = getTodayUTC();
            const dateFilter = document.getElementById('filterDate')?.value || '';
            
            // Start with today's orders by default (fresh day, fresh dashboard)
            // Only show all orders if a specific date filter is set
            let orders;
            if (dateFilter) {
                // User selected a specific date - filter all orders by that date
                orders = ordersCache.filter(o => o.createdAt?.startsWith(dateFilter));
            } else {
                // No date selected - show only today's orders
                orders = ordersCache.filter(o => {
                    if (!o.createdAt) return false;
                    try {
                        return new Date(o.createdAt).toISOString().split('T')[0] === todayUTC;
                    } catch (e) {
                        return false;
                    }
                });
            }
            
            // Network filter from dropdown
            const networkDropdown = document.getElementById('filterNetwork')?.value || '';
            if (networkDropdown) {
                orders = orders.filter(o => {
                    const net = (o.bundle?.network || o.network || '').toUpperCase();
                    if (networkDropdown === 'MTN') return net.includes('MTN');
                    if (networkDropdown === 'Telecel') return net.includes('TELECEL');
                    if (networkDropdown === 'AirtelTigo') return net.includes('AIRTELTIGO') || net.includes('AIRTEL');
                    return false;
                });
            }
            
            // Order No filter
            const orderNoFilter = document.getElementById('filterOrderNoMain')?.value || '';
            if (orderNoFilter) {
                orders = orders.filter(o => o.id?.toString().includes(orderNoFilter));
            }
            
            // Agent Code filter
            const agentCodeFilter = document.getElementById('filterAgentCode')?.value || '';
            if (agentCodeFilter) {
                orders = orders.filter(o => {
                    const agent = (o.user?.name || o.agentCode || o.userName || o.userId || '').toLowerCase();
                    return agent.includes(agentCodeFilter.toLowerCase());
                });
            }
            
            // Phone filter - only filter if input contains only digits
            const phoneFilter = document.getElementById('filterPhoneMain')?.value || '';
            if (phoneFilter && /^\d+$/.test(phoneFilter)) {
                // Only apply filter if phone contains only numbers
                orders = orders.filter(o => {
                    const phone = o.recipientPhone || o.recipient || o.phone || '';
                    return phone.includes(phoneFilter);
                });
            }
            
            // Status filter (case-insensitive)
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            if (statusFilter) {
                orders = orders.filter(o => (o.status || '').toLowerCase() === statusFilter.toLowerCase());
            }
            
            // Payment filter - strictly uses paymentStatus from API
            const paymentFilter = document.getElementById('filterPayment')?.value || '';
            if (paymentFilter) {
                orders = orders.filter(o => {
                    const paymentStatus = (o.paymentStatus || 'PENDING').toUpperCase();
                    return paymentStatus === paymentFilter.toUpperCase();
                });
            }
            
            loadOrdersTable(orders);
        }
        
        // Add filter event listeners
        ['filterDate', 'filterOrderNoMain', 'filterAgentCode', 'filterPhoneMain', 'filterNetwork', 'filterStatus', 'filterPayment'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', applyFilters);
                el.addEventListener('keyup', applyFilters);
            }
        });

        // ========== ENHANCED TOAST NOTIFICATION SYSTEM ==========
        // Create toast container if not exists
        if (!document.querySelector('.toast-container')) {
            const container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
        
        function showToast(message, type = 'success', title = null) {
            const container = document.querySelector('.toast-container');
            
            // Determine icon and title based on type
            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation',
                info: 'fas fa-info'
            };
            
            const titles = {
                success: 'Success',
                error: 'Error',
                warning: 'Warning',
                info: 'Info'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icons[type] || icons.success}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title || titles[type] || 'Notification'}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="toast-progress" style="color: ${type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : type === 'info' ? '#3b82f6' : '#10b981'}"></div>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3.5 seconds
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
            
            // Play subtle sound for important notifications (optional)
            if (type === 'success') {
                // Subtle visual feedback
                toast.style.borderLeft = '4px solid #10b981';
            } else if (type === 'error') {
                toast.style.borderLeft = '4px solid #ef4444';
            }
        }

        // ========== SKELETON LOADER HELPERS ==========
        function createSkeletonRows(count = 5, columns = 8) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += '<tr class="skeleton-row">';
                html += '<td><div class="skeleton skeleton-cell" style="width: 20px; height: 20px;"></div></td>';
                for (let j = 0; j < columns - 1; j++) {
                    const width = [60, 80, 100, 120][Math.floor(Math.random() * 4)];
                    html += `<td><div class="skeleton skeleton-cell" style="width: ${width}px;"></div></td>`;
                }
                html += '</tr>';
            }
            return html;
        }
        
        function createSkeletonCards(count = 4) {
            let html = '';
            for (let i = 0; i < count; i++) {
                html += `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-text short"></div>
                        <div class="skeleton skeleton-text" style="width: 100px; height: 28px;"></div>
                    </div>
                `;
            }
            return html;
        }
        
        function showTableSkeleton(tbodyId, columns = 8) {
            const tbody = document.getElementById(tbodyId);
            if (tbody) {
                tbody.innerHTML = createSkeletonRows(5, columns);
            }
        }

        // ========== BUTTON LOADING STATE HELPERS ==========
        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.classList.add('btn-loading');
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = `<span class="btn-text">${button.innerHTML}</span>`;
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                }
                button.disabled = false;
            }
        }

        // ========== BETTER EMPTY STATES ==========
        function createEmptyState(icon, title, message, actionText = null, actionFn = null) {
            let html = `
                <div class="empty-state-enhanced">
                    <div class="empty-icon">
                        <i class="${icon}"></i>
                    </div>
                    <h3>${title}</h3>
                    <p>${message}</p>
            `;
            
            if (actionText && actionFn) {
                html += `<button class="empty-action" onclick="${actionFn}">
                    <i class="fas fa-plus"></i>
                    ${actionText}
                </button>`;
            }
            
            html += '</div>';
            return html;
        }

        // ========== KEYBOARD SHORTCUTS ==========
        const keyboardShortcuts = {
            'ctrl+k': () => toggleCommandPalette(),
            'ctrl+d': () => navigateToSection('dashboard'),
            'ctrl+w': () => navigateToSection('wallet'),
            'ctrl+u': () => navigateToSection('users'),
            'ctrl+h': () => navigateToSection('history'),
            'ctrl+n': () => navigateToSection('networks'),
            'ctrl+r': () => navigateToSection('reports'),
            'ctrl+,': () => navigateToSection('settings'),
            'escape': () => closeAllModals()
        };
        
        document.addEventListener('keydown', function(e) {
            if (!e.key) return; // Guard against undefined key
            const key = [];
            if (e.ctrlKey || e.metaKey) key.push('ctrl');
            if (e.shiftKey) key.push('shift');
            if (e.altKey) key.push('alt');
            key.push(e.key.toLowerCase());
            
            const combo = key.join('+');
            
            if (keyboardShortcuts[combo]) {
                e.preventDefault();
                keyboardShortcuts[combo]();
            }
        });
        
        function closeAllModals() {
            document.querySelectorAll('.modal.active, .modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            const palette = document.querySelector('.command-palette-overlay');
            if (palette) palette.classList.remove('active');
        }

        // ========== COMMAND PALETTE ==========
        function createCommandPalette() {
            if (document.querySelector('.command-palette-overlay')) return;
            
            const overlay = document.createElement('div');
            overlay.className = 'command-palette-overlay';
            overlay.innerHTML = `
                <div class="command-palette">
                    <input type="text" class="command-palette-input" placeholder="Type a command or search..." autofocus>
                    <div class="command-palette-results">
                        <div class="command-palette-item" data-action="dashboard">
                            <i class="fas fa-th-large"></i>
                            <div class="item-text">
                                <div class="item-title">Go to Dashboard</div>
                                <div class="item-subtitle">View orders and statistics</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>D</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="wallet">
                            <i class="fas fa-wallet"></i>
                            <div class="item-text">
                                <div class="item-title">Go to Wallet</div>
                                <div class="item-subtitle">Manage user wallets and claims</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>W</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="users">
                            <i class="fas fa-users"></i>
                            <div class="item-text">
                                <div class="item-title">Go to Users</div>
                                <div class="item-subtitle">Manage user accounts</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>U</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="history">
                            <i class="fas fa-history"></i>
                            <div class="item-text">
                                <div class="item-title">Go to History</div>
                                <div class="item-subtitle">View order history</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>H</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="networks">
                            <i class="fas fa-network-wired"></i>
                            <div class="item-text">
                                <div class="item-title">Go to Networks</div>
                                <div class="item-subtitle">Manage bundles and tariffs</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>N</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="reports">
                            <i class="fas fa-chart-bar"></i>
                            <div class="item-text">
                                <div class="item-title">Go to Reports</div>
                                <div class="item-subtitle">View sales and analytics</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>R</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="settings">
                            <i class="fas fa-cog"></i>
                            <div class="item-text">
                                <div class="item-title">Go to Settings</div>
                                <div class="item-subtitle">Configure system settings</div>
                            </div>
                            <div class="item-shortcut"><kbd>Ctrl</kbd><kbd>,</kbd></div>
                        </div>
                        <div class="command-palette-item" data-action="refresh">
                            <i class="fas fa-sync"></i>
                            <div class="item-text">
                                <div class="item-title">Refresh Data</div>
                                <div class="item-subtitle">Reload current section data</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
            
            // Handle item clicks
            overlay.querySelectorAll('.command-palette-item').forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.dataset.action;
                    if (action === 'refresh') {
                        location.reload();
                    } else {
                        navigateToSection(action);
                    }
                    overlay.classList.remove('active');
                });
            });
            
            // Search functionality
            const input = overlay.querySelector('.command-palette-input');
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                overlay.querySelectorAll('.command-palette-item').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'flex' : 'none';
                });
            });
            
            // Keyboard navigation
            input.addEventListener('keydown', function(e) {
                const items = [...overlay.querySelectorAll('.command-palette-item:not([style*="display: none"])')];
                const selected = overlay.querySelector('.command-palette-item.selected');
                let index = selected ? items.indexOf(selected) : -1;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (selected) selected.classList.remove('selected');
                    index = (index + 1) % items.length;
                    items[index]?.classList.add('selected');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (selected) selected.classList.remove('selected');
                    index = index <= 0 ? items.length - 1 : index - 1;
                    items[index]?.classList.add('selected');
                } else if (e.key === 'Enter' && selected) {
                    selected.click();
                }
            });
        }
        
        function toggleCommandPalette() {
            createCommandPalette();
            const palette = document.querySelector('.command-palette-overlay');
            palette.classList.toggle('active');
            if (palette.classList.contains('active')) {
                const input = palette.querySelector('.command-palette-input');
                input.value = '';
                input.focus();
                palette.querySelectorAll('.command-palette-item').forEach(item => {
                    item.style.display = 'flex';
                    item.classList.remove('selected');
                });
            }
        }

        // Initialize command palette on load
        createCommandPalette();

        // ========== RIPPLE EFFECT FOR BUTTONS ==========
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-fund, .btn-primary, .btn-action, .nav-link, .network-tab');
            if (!btn) return;
            
            btn.classList.add('ripple');
            const rect = btn.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            btn.style.setProperty('--ripple-x', x + 'px');
            btn.style.setProperty('--ripple-y', y + 'px');
            
            setTimeout(() => btn.classList.remove('ripple'), 600);
        });

        // ========== SIDEBAR NAVIGATION ==========
        const navLinks = document.querySelectorAll('.nav-link');
        const walletSection = document.getElementById('walletSection');
        const usersSection = document.getElementById('usersSection');
        const dashboardElements = [
            document.querySelector('.main-stats'),
            document.querySelector('.status-cards'),
            document.querySelector('.filter-options-panel'),
            document.querySelector('.network-tabs'),
            document.querySelector('.action-bar'),
            document.querySelector('.table-container')
        ];
        
        function hideAllSections() {
            dashboardElements.forEach(el => { if (el) el.style.display = 'none'; });
            walletSection.classList.remove('active');
            usersSection.classList.remove('active');
            document.getElementById('historySection')?.classList.remove('active');
            document.getElementById('networksSection')?.classList.remove('active');
            document.getElementById('reportsSection')?.classList.remove('active');
            document.getElementById('settingsSection')?.classList.remove('active');
            document.getElementById('storefrontsSection')?.classList.remove('active');
        }
        
        function showDashboard() {
            hideAllSections();
            dashboardElements.forEach(el => { if (el) el.style.display = ''; });
        }
        
        async function showWallet() {
            hideAllSections();
            walletSection.classList.add('active');
            await loadWalletSection();
        }
        
        function showUsers() {
            hideAllSections();
            usersSection.classList.add('active');
            loadUsersSection();
        }
        
        function showHistory() {
            hideAllSections();
            document.getElementById('historySection').classList.add('active');
            loadHistorySection();
        }
        
        function showNetworks() {
            hideAllSections();
            document.getElementById('networksSection').classList.add('active');
            loadNetworksSection();
        }
        
        function showReports() {
            hideAllSections();
            document.getElementById('reportsSection').classList.add('active');
            loadReportsSection();
        }
        
        function showSettings() {
            hideAllSections();
            document.getElementById('settingsSection').classList.add('active');
            loadSettingsSection();
        }
        
        function showStorefronts() {
            hideAllSections();
            document.getElementById('storefrontsSection').classList.add('active');
            loadStorefrontsSection();
        }
        
        // Navigate to a section and update URL hash
        function navigateToSection(section) {
            // Update URL hash without triggering page reload
            window.location.hash = section;
            
            // Update active nav link
            navLinks.forEach(l => {
                const linkSection = l.getAttribute('data-section');
                if (linkSection === section) {
                    l.classList.add('active');
                } else {
                    l.classList.remove('active');
                }
            });
            
            // Show the appropriate section
            switch (section) {
                case 'wallet':
                    showWallet();
                    break;
                case 'users':
                    showUsers();
                    break;
                case 'history':
                    showHistory();
                    break;
                case 'networks':
                    showNetworks();
                    break;
                case 'storefronts':
                    showStorefronts();
                    break;
                case 'reports':
                    showReports();
                    break;
                case 'settings':
                    showSettings();
                    break;
                case 'dashboard':
                default:
                    showDashboard();
                    break;
            }
        }
        
        // Restore section from URL hash on page load
        function restoreSectionFromHash() {
            const hash = window.location.hash.replace('#', '');
            if (hash && ['dashboard', 'wallet', 'users', 'history', 'networks', 'storefronts', 'reports', 'settings'].includes(hash)) {
                navigateToSection(hash);
            }
        }
        
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.getAttribute('data-section') || 'dashboard';
                navigateToSection(section);
            });
        });
        
        // Handle browser back/forward button
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.replace('#', '');
            if (hash) {
                navigateToSection(hash);
            } else {
                navigateToSection('dashboard');
            }
        });
        
        // ========== USERS MANAGEMENT ==========
        function loadUsersSection() {
            initUsersData();
            updateUsersStats();
            renderUsersTable();
        }
        
        function updateUsersStats() {
            const totalUsers = usersData.length;
            const activeUsers = usersData.filter(u => u.status === 'active' || !u.status).length;
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const newUsers = usersData.filter(u => u.joinedAt && new Date(u.joinedAt) >= thisMonth).length;
            const totalBalance = usersData.reduce((sum, u) => sum + (u.balance || 0), 0);
            
            document.getElementById('statTotalUsers').textContent = totalUsers;
            document.getElementById('statActiveUsers').textContent = activeUsers;
            document.getElementById('statNewUsers').textContent = newUsers;
            document.getElementById('statTotalBalance').textContent = 'GH ' + totalBalance.toFixed(2);
        }
        
        function renderUsersTable(searchTerm = '', statusFilter = '', roleFilter = '') {
            const tbody = document.getElementById('usersTableBody');
            let filtered = [...usersData];
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(u => 
                    (u.name || '').toLowerCase().includes(term) ||
                    (u.phone || '').toLowerCase().includes(term) ||
                    (u.email || '').toLowerCase().includes(term)
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(u => (u.status || 'active') === statusFilter);
            }
            
            if (roleFilter) {
                filtered = filtered.filter(u => (u.role || '').toUpperCase() === roleFilter.toUpperCase());
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            ${createEmptyState(
                                'fas fa-users-slash',
                                'No Users Found',
                                searchTerm ? 'Try adjusting your search terms' : 'No users have registered yet',
                                searchTerm ? null : 'Add First User',
                                'openAddUserModal()'
                            )}
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Get orders for each user (use ordersCache from API)
            const orders = [...ordersCache];
            
            tbody.innerHTML = filtered.map(user => {
                const userOrders = orders.filter(o => o.phone === user.phone || o.userId === user.id);
                const status = user.status || 'active';
                const role = user.role || 'agent';
                const roleDisplay = role.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                
                return `
                    <tr>
                        <td>
                            <div class="user-profile">
                                <div class="avatar">${(user.name || 'U').charAt(0)}</div>
                                <div class="info">
                                    <div class="name">${user.name || 'Unknown'}</div>
                                    <div class="email">${user.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.phone || 'N/A'}</td>
                        <td><span class="user-role ${role}">${roleDisplay}</span></td>
                        <td class="balance-amount ${user.balance < 50 ? 'low' : ''}">GH ${user.balance.toFixed(2)}</td>
                        <td>GH ${user.totalSpent.toFixed(2)}</td>
                        <td>${userOrders.length}</td>
                        <td><span class="user-status ${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
                        <td>
                            <div class="user-actions">
                                <button class="user-action-btn view" data-action="view-user" data-id="${user.id}" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="user-action-btn edit" data-action="edit-user" data-id="${user.id}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="user-action-btn role" data-action="change-role" data-id="${user.id}" title="Change Role">
                                    <i class="fas fa-user-tag"></i>
                                </button>
                                <button class="user-action-btn fund" data-action="quick-fund" data-id="${user.id}" title="Fund Wallet">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="user-action-btn delete" data-action="delete-user" data-id="${user.id}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // User search and filter
        document.getElementById('usersSearchInput')?.addEventListener('input', function() {
            const statusFilter = document.getElementById('usersStatusFilter')?.value || '';
            const roleFilter = document.getElementById('usersRoleFilter')?.value || '';
            renderUsersTable(this.value, statusFilter, roleFilter);
        });
        
        document.getElementById('usersStatusFilter')?.addEventListener('change', function() {
            const searchTerm = document.getElementById('usersSearchInput')?.value || '';
            const roleFilter = document.getElementById('usersRoleFilter')?.value || '';
            renderUsersTable(searchTerm, this.value, roleFilter);
        });
        
        document.getElementById('usersRoleFilter')?.addEventListener('change', function() {
            const searchTerm = document.getElementById('usersSearchInput')?.value || '';
            const statusFilter = document.getElementById('usersStatusFilter')?.value || '';
            renderUsersTable(searchTerm, statusFilter, this.value);
        });
        
        // Add/Edit User Modal
        let currentViewUserId = null;
        
        function openAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add New User';
            // Clear all add form fields
            if (document.getElementById('userFormAdd')) {
                document.getElementById('userFormAdd').reset();
            }
            if (document.getElementById('editUserIdAdd')) {
                document.getElementById('editUserIdAdd').value = '';
            }
            if (document.getElementById('userBalanceAdd')) {
                document.getElementById('userBalanceAdd').value = '0';
            }
            // Clear edit form fields too
            if (document.getElementById('editUserIdEdit')) {
                document.getElementById('editUserIdEdit').value = '';
            }
            if (document.getElementById('userFullNameEdit')) {
                document.getElementById('userFullNameEdit').value = '';
            }
            if (document.getElementById('userPhoneEdit')) {
                document.getElementById('userPhoneEdit').value = '';
            }
            document.getElementById('userModal').classList.add('active');
        }
        
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }
        
        function editUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            // Set edit form values
            if (document.getElementById('editUserIdEdit')) {
                document.getElementById('editUserIdEdit').value = user.id;
            }
            if (document.getElementById('editUserIdAdd')) {
                document.getElementById('editUserIdAdd').value = user.id;
            }
            // Fill in Edit form
            if (document.getElementById('userFullNameEdit')) {
                document.getElementById('userFullNameEdit').value = user.name || '';
            }
            if (document.getElementById('userPhoneEdit')) {
                document.getElementById('userPhoneEdit').value = user.phone || '';
            }
            if (document.getElementById('userEmailEdit')) {
                document.getElementById('userEmailEdit').value = user.email || '';
            }
            if (document.getElementById('userRoleEdit')) {
                document.getElementById('userRoleEdit').value = user.role || 'AGENT';
            }
            if (document.getElementById('userStatusEdit')) {
                document.getElementById('userStatusEdit').value = user.isActive === false ? 'inactive' : 'active';
            }
            if (document.getElementById('userBalanceEdit')) {
                document.getElementById('userBalanceEdit').value = user.balance || 0;
            }
            if (document.getElementById('userNetworkEdit')) {
                document.getElementById('userNetworkEdit').value = user.network || '';
            }
            if (document.getElementById('userNotesEdit')) {
                document.getElementById('userNotesEdit').value = user.notes || '';
            }
            // Also fill Add form for fallback
            if (document.getElementById('userFullNameAdd')) {
                document.getElementById('userFullNameAdd').value = user.name || '';
            }
            if (document.getElementById('userPhoneAdd')) {
                document.getElementById('userPhoneAdd').value = user.phone || '';
            }
            if (document.getElementById('userEmailAdd')) {
                document.getElementById('userEmailAdd').value = user.email || '';
            }
            if (document.getElementById('userStatusAdd')) {
                document.getElementById('userStatusAdd').value = user.status || 'active';
            }
            if (document.getElementById('userBalanceAdd')) {
                document.getElementById('userBalanceAdd').value = user.balance || 0;
            }
            if (document.getElementById('userNetworkAdd')) {
                document.getElementById('userNetworkAdd').value = user.network || '';
            }
            if (document.getElementById('userNotesAdd')) {
                document.getElementById('userNotesAdd').value = user.notes || '';
            }
            document.getElementById('userModal').classList.add('active');
        }
        
        function saveUser() {
            // Try Edit first, fallback to Add
            const editId = document.getElementById('editUserIdEdit')?.value || document.getElementById('editUserIdAdd')?.value || '';
            const name = document.getElementById('userFullNameEdit')?.value?.trim() || document.getElementById('userFullNameAdd')?.value?.trim() || '';
            const phone = document.getElementById('userPhoneEdit')?.value?.trim() || document.getElementById('userPhoneAdd')?.value?.trim() || '';
            const email = document.getElementById('userEmailEdit')?.value?.trim() || document.getElementById('userEmailAdd')?.value?.trim() || '';
            const role = document.getElementById('userRoleEdit')?.value || 'AGENT';
            const status = document.getElementById('userStatusEdit')?.value || document.getElementById('userStatusAdd')?.value || 'active';
            const balance = parseFloat(document.getElementById('userBalanceEdit')?.value || document.getElementById('userBalanceAdd')?.value || 0);
            const network = document.getElementById('userNetworkEdit')?.value || document.getElementById('userNetworkAdd')?.value || '';
            const notes = document.getElementById('userNotesEdit')?.value?.trim() || document.getElementById('userNotesAdd')?.value?.trim() || '';

            if (!name || !phone) {
                showToast('Name and Phone are required', 'error');
                return;
            }

            const userPayload = {
                name, phone, email, role, isActive: status === 'active', balance, network, notes
            };

            if (editId) {
                // Update existing user via API
                adminFetch(`/api/users/${editId}`, {
                    method: 'PUT',
                    body: JSON.stringify(userPayload)
                })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to update user');
                    return res.json();
                })
                .then(() => {
                    showToast('User updated successfully', 'success');
                    closeUserModal();
                    initUsersData();
                })
                .catch(err => showToast('Error updating user: ' + err.message, 'error'));
            } else {
                // Add new user via API
                adminFetch('/api/users', {
                    method: 'POST',
                    body: JSON.stringify(userPayload)
                })
                .then(res => {
                    if (!res.ok) throw new Error('Failed to add user');
                    return res.json();
                })
                .then(() => {
                    showToast('User added successfully', 'success');
                    closeUserModal();
                    initUsersData();
                })
                .catch(err => showToast('Error adding user: ' + err.message, 'error'));
            }
        }
        
        async function deleteUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            const confirmed = await showConfirmModal({
                title: 'Delete User',
                message: `Are you sure you want to delete "${user.name}"? This action cannot be undone and will remove all associated data.`,
                type: 'danger',
                confirmText: 'Delete User',
                cancelText: 'Keep User'
            });
            if (!confirmed) return;
            
            adminFetch(`/api/users/${userId}`, {
                method: 'DELETE'
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete user');
                showToast('User deleted', 'success');
                initUsersData();
            })
            .catch(err => showToast('Error deleting user: ' + err.message, 'error'));
        }
        
        async function quickFundUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            const amount = await showConfirmModal({
                title: 'Fund User Wallet',
                message: `Enter the amount to add to ${user.name}'s wallet.`,
                type: 'success',
                confirmText: 'Add Funds',
                cancelText: 'Cancel',
                showInput: true,
                inputLabel: 'Amount (GH)',
                inputPlaceholder: 'Enter amount...',
                inputType: 'number'
            });
            if (!amount) return;
            
            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum <= 0) {
                showToast('Invalid amount', 'error');
                return;
            }
            adminFetch(`/api/wallets/${userId}/credit`, {
                method: 'POST',
                body: JSON.stringify({ amount: amountNum, note: 'Quick Fund by Admin' })
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to fund wallet');
                return res.json();
            })
            .then(() => {
                showToast(`GH ${amountNum.toFixed(2)} added to ${user.name}'s wallet`, 'success');
                initUsersData();
                populateUserSelect();
            })
            .catch(err => showToast('Error funding wallet: ' + err.message, 'error'));
        }
        
        // View User Details
        function viewUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            currentViewUserId = userId;
            const orders = [...ordersCache];
            const userOrders = orders.filter(o => o.recipientPhone === user.phone || o.userId === user.id || o.phone === user.phone);
            const completedOrders = userOrders.filter(o => o.status === 'completed').length;
            
            document.getElementById('userDetailContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, #024959, #F2C12E); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; color: white; font-size: 1.8rem; font-weight: 600;">
                        ${(user.name || 'U').charAt(0)}
                    </div>
                    <h3 style="margin: 0; color: #1f2937;">${user.name || 'Unknown'}</h3>
                    <p style="color: #6b7280; margin: 5px 0;">${user.phone || 'No phone'}</p>
                    <span class="user-status ${user.status || 'active'}">${(user.status || 'active').charAt(0).toUpperCase() + (user.status || 'active').slice(1)}</span>
                </div>
                
                <div class="user-detail-grid">
                    <div class="user-detail-card">
                        <h4>Email</h4>
                        <div class="value">${user.email || 'Not provided'}</div>
                    </div>
                    <div class="user-detail-card">
                        <h4>Network Preference</h4>
                        <div class="value">${user.network || 'None'}</div>
                    </div>
                    <div class="user-detail-card">
                        <h4>Wallet Balance</h4>
                        <div class="value" style="color: #10b981;">GH ${(user.balance || 0).toFixed(2)}</div>
                    </div>
                    <div class="user-detail-card">
                        <h4>Total Spent</h4>
                        <div class="value">GH ${(user.totalSpent || 0).toFixed(2)}</div>
                    </div>
                    <div class="user-detail-card">
                        <h4>Total Orders</h4>
                        <div class="value">${userOrders.length}</div>
                    </div>
                    <div class="user-detail-card">
                        <h4>Completed Orders</h4>
                        <div class="value">${completedOrders}</div>
                    </div>
                    <div class="user-detail-card full">
                        <h4>Joined</h4>
                        <div class="value">${user.joinedAt ? new Date(user.joinedAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Unknown'}</div>
                    </div>
                    ${user.notes ? `
                        <div class="user-detail-card full">
                            <h4>Notes</h4>
                            <div class="value" style="font-size: 0.95rem;">${user.notes}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('viewUserModal').classList.add('active');
        }
        
        function closeViewUserModal() {
            document.getElementById('viewUserModal').classList.remove('active');
            currentViewUserId = null;
        }
        
        function closeViewUserModalAlt() {
            document.getElementById('viewUserModalAlt')?.classList.remove('active');
            currentViewUserId = null;
        }
        
        function editUserFromView() {
            if (currentViewUserId) {
                closeViewUserModal();
                editUser(currentViewUserId);
            }
        }
        
        // Change Role Modal Functions
        function openChangeRoleModal(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('changeRoleUserId').value = userId;
            document.getElementById('changeRoleUserName').textContent = user.name || 'Unknown User';
            
            // Role is stored as uppercase (AGENT, SUPER_AGENT, etc.)
            const currentRole = (user.role || 'AGENT').toUpperCase();
            const roleDisplay = currentRole.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
            document.getElementById('changeRoleCurrentRole').textContent = `Current Role: ${roleDisplay}`;
            
            // Set current role as checked
            const radios = document.querySelectorAll('input[name="newRole"]');
            radios.forEach(radio => {
                radio.checked = radio.value === currentRole;
                // Highlight selected option
                radio.closest('label').style.borderColor = radio.value === currentRole ? '#6366f1' : 'transparent';
                radio.closest('label').style.background = radio.value === currentRole ? '#eef2ff' : '#f9fafb';
            });
            
            // Add change event for visual feedback
            radios.forEach(radio => {
                radio.onchange = function() {
                    radios.forEach(r => {
                        r.closest('label').style.borderColor = r.checked ? '#6366f1' : 'transparent';
                        r.closest('label').style.background = r.checked ? '#eef2ff' : '#f9fafb';
                    });
                };
            });
            
            document.getElementById('changeRoleModal').classList.add('active');
        }
        
        function closeChangeRoleModal() {
            document.getElementById('changeRoleModal').classList.remove('active');
        }
        
        async function saveUserRole() {
            const saveBtn = document.querySelector('#changeRoleModal .btn-primary, #changeRoleModal button[onclick*="saveUserRole"]');
            const userId = document.getElementById('changeRoleUserId').value;
            const selectedRole = document.querySelector('input[name="newRole"]:checked');
            if (!selectedRole) {
                showToast('Please select a role', 'error');
                return;
            }
            const newRole = selectedRole.value; // Already uppercase (AGENT, SUPER_AGENT, etc.)
            
            if (saveBtn) setButtonLoading(saveBtn, true);
            
            try {
                const res = await adminFetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: newRole })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to change role');
                }
                
                await res.json();
                closeChangeRoleModal();
                await initUsersData();
                renderUsersTable();
                
                // Format role for display (SUPER_AGENT -> Super Agent)
                const roleDisplay = newRole.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                showToast(`Role changed to ${roleDisplay}`, 'success', 'Role Updated');
            } catch (err) {
                console.error('Role update error:', err);
                showToast('Error changing role: ' + err.message, 'error');
            } finally {
                if (saveBtn) setButtonLoading(saveBtn, false);
            }
        }

        // ========== WALLET MANAGEMENT ==========
        let usersData = [];
        let pendingTopups = [];

        // Fetch users and their wallet data from backend API
        async function initUsersData() {
            try {
                const res = await adminFetch('/api/users');
                if (!res.ok) throw new Error('Failed to fetch users');
                const data = await res.json();
                // Fetch wallet and transactions for each user
                usersData = await Promise.all((Array.isArray(data.users) ? data.users : []).map(async u => {
                    let wallet = null;
                    let transactions = [];
                    try {
                        const walletRes = await adminFetch(`/api/wallet?userId=${u.id}`);
                        if (walletRes.ok) {
                            wallet = await walletRes.json();
                            transactions = (wallet.transactions || []).map(t => ({
                                ...t,
                                date: t.createdAt,
                                type: t.type,
                                amount: parseFloat(t.amount) || 0
                            }));
                        }
                    } catch {}
                    return {
                        id: u.id,
                        name: u.name,
                        phone: u.phone,
                        email: u.email,
                        role: u.role,
                        status: u.isActive ? 'active' : 'inactive',
                        balance: parseFloat(wallet?.balance) || 0,
                        totalSpent: 0, // TODO: fetch from backend if available
                        transactions: transactions,
                        joinedAt: u.createdAt
                    };
                }));
                // Update stats after loading users
                updateUsersStats();
                updateWalletStats();
                renderUsersTable();
            } catch (err) {
                showToast('Error loading users: ' + err.message, 'error');
                usersData = [];
                updateUsersStats();
                updateWalletStats();
                renderUsersTable();
            }
        }

        // No longer save users or pending topups to localStorage
        function saveUsersData() {}
        function savePendingTopups() {}
        
        // Load wallet section
        async function loadWalletSection() {
            // First load users data (this will call updateWalletStats internally)
            await initUsersData();
            
            // Now that users data is loaded, render everything
            renderUserWallets();
            populateUserSelect();
            
            // Load payment stats (for incoming payments)
            await loadIncomingPayments();
            updatePaymentStats();
            
            // Auto-refresh every 30 seconds (reduced from 5 to prevent server overload)
            if (!window.walletRefreshInterval) {
                window.walletRefreshInterval = setInterval(async () => {
                    if (walletSection.classList.contains('active')) {
                        await loadIncomingPayments(true); // Force refresh on interval
                        updateWalletStats();
                        updatePaymentStats();
                        
                        // Refresh current tab if claims tab is active
                        if (document.getElementById('claimsTabContent').classList.contains('active')) {
                            renderIncomingPayments();
                        }
                    }
                }, 30000);
            }
        }
        
        // Update wallet statistics
        function updateWalletStats() {
            // Calculate total balance from usersData (already loaded)
            const totalBalance = usersData.reduce((sum, u) => sum + (parseFloat(u.balance) || 0), 0);
            document.getElementById('totalUserBalances').textContent = 'GH ' + totalBalance.toFixed(2);
            document.getElementById('pendingTopupsCount').textContent = incomingPayments.filter(p => p.status !== 'claimed').length;
            
            // Calculate today's credits/debits (using UTC)
            const todayUTC = getTodayUTC();
            let todayCredits = 0, todayDebits = 0;
            usersData.forEach(u => {
                (u.transactions || []).forEach(t => {
                    const txDate = t.date || t.createdAt;
                    if (txDate) {
                        const txDateUTC = new Date(txDate).toISOString().split('T')[0];
                        if (txDateUTC === todayUTC) {
                            const amount = parseFloat(t.amount) || 0;
                            if (t.type === 'credit' || t.type === 'DEPOSIT' || amount > 0) {
                                todayCredits += Math.abs(amount);
                            } else if (t.type === 'debit' || t.type === 'WITHDRAWAL' || amount < 0) {
                                todayDebits += Math.abs(amount);
                            }
                        }
                    }
                });
            });
            document.getElementById('todayCredits').textContent = 'GH ' + todayCredits.toFixed(2);
            document.getElementById('todayDebits').textContent = 'GH ' + todayDebits.toFixed(2);
        }
        
        // Render user wallets table
        function renderUserWallets(searchTerm = '') {
            const tbody = document.getElementById('userWalletsBody');
            let filtered = usersData;
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = usersData.filter(u => 
                    u.name.toLowerCase().includes(term) || 
                    u.phone.includes(term)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4">
                    ${createEmptyState(
                        'fas fa-wallet',
                        searchTerm ? 'No Wallets Found' : 'No Users Yet',
                        searchTerm ? 'Try adjusting your search terms' : 'Users will appear here once they register',
                        null,
                        null
                    )}
                </td></tr>`;
                return;
            }
            
            tbody.innerHTML = filtered.map(u => {
                const balance = parseFloat(u.balance) || 0;
                const totalSpent = parseFloat(u.totalSpent) || 0;
                return `
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${u.name.charAt(0)}</div>
                            <div>
                                <div class="user-name">${u.name}</div>
                                <div class="user-phone">${u.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="balance-amount ${balance < 50 ? 'low' : ''}">GH ${balance.toFixed(2)}</td>
                    <td>GH ${totalSpent.toFixed(2)}</td>
                    <td>
                        <div class="wallet-actions">
                            <button class="wallet-action-btn fund" onclick="quickFund('${u.id}')">
                                <i class="fas fa-plus"></i> Fund
                            </button>
                            <button class="wallet-action-btn debit" onclick="viewTransactions('${u.id}')">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }
        
        // Populate user select dropdown
        function populateUserSelect() {
            const select = document.getElementById('fundUserSelect');
            select.innerHTML = '<option value="">-- Select User --</option>' +
                usersData.map(u => `<option value="${u.id}">${u.name} (${u.phone}) - GH ${(parseFloat(u.balance) || 0).toFixed(2)}</option>`).join('');
        }
        
        // Quick fund (pre-select user)
        function quickFund(userId) {
            document.getElementById('fundUserSelect').value = userId;
            document.getElementById('fundAmount').focus();
        }
        
        // Process fund/debit transaction
        document.getElementById('fundWalletForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            const userId = document.getElementById('fundUserSelect').value;
            const amount = parseFloat(document.getElementById('fundAmount').value);
            const type = document.getElementById('fundType').value;
            const note = document.getElementById('fundNote').value || (type === 'credit' ? 'Admin Top-up' : 'Admin Debit');
            if (!userId || !amount) {
                showToast('Please select a user and enter amount', 'error');
                return;
            }
            const userIdx = usersData.findIndex(u => u.id === userId);
            if (userIdx === -1) {
                showToast('User not found', 'error');
                return;
            }
            if (type === 'debit' && usersData[userIdx].balance < amount) {
                showToast('Insufficient balance for debit', 'error');
                return;
            }
            
            // Show loading state
            setButtonLoading(submitBtn, true);
            
            // Call backend API to fund or debit wallet
            try {
                const res = await adminFetch('/api/wallet/transfer', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId,
                        amount,
                        type,
                        note
                    })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to process transaction');
                }
                
                // Get user name before refresh (for toast message)
                const userName = usersData[userIdx].name;
                
                // Refresh users data after transaction
                await initUsersData();
                renderUserWallets();
                populateUserSelect();
                this.reset();
                showToast(`GH ${amount.toFixed(2)} ${type === 'credit' ? 'credited to' : 'debited from'} ${userName}`, 'success', 'Transaction Complete');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                setButtonLoading(submitBtn, false);
            }
        });
        
        // View transaction history
        function viewTransactions(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('modalUserName').textContent = user.name;
            const container = document.getElementById('transactionList');
            
            const transactions = user.transactions || [];
            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af;">No transactions yet</p>';
            } else {
                container.innerHTML = transactions.map(t => {
                    const amount = parseFloat(t.amount) || 0;
                    const isCredit = t.type === 'credit' || t.type === 'DEPOSIT' || amount > 0;
                    const displayAmount = Math.abs(amount);
                    return `
                    <div class="transaction-item">
                        <div class="transaction-icon ${isCredit ? 'credit' : 'debit'}">
                            <i class="fas fa-${isCredit ? 'arrow-down' : 'arrow-up'}"></i>
                        </div>
                        <div class="transaction-info">
                            <div class="transaction-desc">${t.description || (isCredit ? 'Credit' : 'Debit')}</div>
                            <div class="transaction-date">${formatTransactionDate(t.date || t.createdAt)}</div>
                        </div>
                        <div class="transaction-amount ${isCredit ? 'credit' : 'debit'}">
                            ${isCredit ? '+' : '-'}GH ${displayAmount.toFixed(2)}
                        </div>
                    </div>
                `}).join('');
            }
            
            document.getElementById('transactionModal').classList.add('active');
        }
        
        function formatTransactionDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return 'N/A';
                const day = date.getUTCDate();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[date.getUTCMonth()];
                const year = date.getUTCFullYear();
                const hours = String(date.getUTCHours()).padStart(2, '0');
                const minutes = String(date.getUTCMinutes()).padStart(2, '0');
                return `${day} ${month} ${year}, ${hours}:${minutes} GMT`;
            } catch {
                return dateStr || 'N/A';
            }
        }
        
        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }
        
        // Close modal on overlay click and close button click
        document.getElementById('transactionModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeTransactionModal();
        });
        document.getElementById('closeTransactionModalBtn')?.addEventListener('click', closeTransactionModal);
        
        // User search
        document.getElementById('userSearch')?.addEventListener('input', function() {
            renderUserWallets(this.value);
        });

        // ========== WALLET TABS ==========
        document.querySelectorAll('.wallet-main-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active from all tabs
                document.querySelectorAll('.wallet-main-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.wallet-tab-content').forEach(c => c.classList.remove('active'));
                
                // Activate clicked tab
                this.classList.add('active');
                const tabId = this.dataset.walletTab + 'TabContent';
                document.getElementById(tabId).classList.add('active');
                
                // Load tab content
                if (this.dataset.walletTab === 'claims') {
                    renderIncomingPayments();
                } else if (this.dataset.walletTab === 'transactions') {
                    renderAllTransactions();
                }
            });
        });
        
        // ========== INCOMING PAYMENTS (MBS STYLE) ==========

        let incomingPayments = [];
        let isLoadingPayments = false;
        let lastPaymentsLoad = 0;
        const PAYMENTS_CACHE_TTL = 3000; // Cache for 3 seconds to prevent excessive calls

        async function loadIncomingPayments(forceRefresh = false) {
            // Prevent concurrent loads and respect cache TTL
            const now = Date.now();
            if (isLoadingPayments || (!forceRefresh && now - lastPaymentsLoad < PAYMENTS_CACHE_TTL)) {
                return;
            }
            
            isLoadingPayments = true;
            try {
                const res = await adminFetch('/api/wallet/deposits');
                if (!res.ok) throw new Error('Failed to fetch incoming payments');
                const data = await res.json();
                lastPaymentsLoad = Date.now();
                // Map API response to expected format
                // Status mapping: API uses PENDING/COMPLETED/FAILED, frontend expects lowercase
                incomingPayments = (data.deposits || []).map(d => {
                    const apiStatus = (d.status || 'pending').toLowerCase();
                    // Map statuses for display
                    let displayStatus = apiStatus;
                    if (apiStatus === 'completed') displayStatus = 'completed';
                    else if (apiStatus === 'failed') displayStatus = 'rejected';
                    else displayStatus = 'pending';
                    
                    return {
                        id: d.id,
                        transactionId: d.reference,
                        amount: parseFloat(d.amount),
                        status: displayStatus,
                        receivedAt: d.createdAt,
                        description: d.description,
                        // User info from wallet
                        senderName: d.user?.name || 'Unknown',
                        phone: d.user?.phone || 'N/A',
                        email: d.user?.email || 'N/A',
                        userId: d.user?.id,
                        network: d.description?.includes('momo') ? 'MTN' : 'MOMO'
                    };
                });
            } catch (err) {
                console.error('Failed to load deposits:', err);
                incomingPayments = [];
            } finally {
                isLoadingPayments = false;
            }
        }

        function saveIncomingPayments() {}
        
        function updatePaymentStats() {
            // loadIncomingPayments(); // Already loaded before calling this
            
            let totalReceived = 0, totalClaimed = 0, totalUnclaimed = 0, pendingAmount = 0;
            let totalRecords = incomingPayments.length;
            let claimedCount = 0, unclaimedCount = 0, pendingCount = 0;
            
            incomingPayments.forEach(p => {
                totalReceived += p.amount;
                if (p.status === 'completed') {
                    totalClaimed += p.amount;
                    claimedCount++;
                } else if (p.status === 'rejected') {
                    // Don't count rejected in unclaimed
                } else {
                    // pending
                    pendingAmount += p.amount;
                    pendingCount++;
                }
            });
            
            document.getElementById('statTotalReceived').textContent = ' ' + totalReceived.toFixed(2);
            document.getElementById('statTotalClaimed').textContent = ' ' + totalClaimed.toFixed(2);
            document.getElementById('statTotalUnclaimed').textContent = ' ' + totalUnclaimed.toFixed(2);
            document.getElementById('statPendingAmount').textContent = ' ' + pendingAmount.toFixed(2);
            document.getElementById('statTotalRecords').textContent = totalRecords;
            document.getElementById('statClaimedCount').textContent = claimedCount;
            document.getElementById('statUnclaimedCount').textContent = unclaimedCount + pendingCount;
            
            // Update badge
            const badge = document.getElementById('claimsBadge');
            const badgeCount = unclaimedCount + pendingCount;
            if (badgeCount > 0) {
                badge.textContent = badgeCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function renderIncomingPayments() {
            loadIncomingPayments().then(() => {
                updatePaymentStats();
            
                // Get filter values
                const searchTxnId = document.getElementById('searchTxnId')?.value?.toLowerCase() || '';
                const searchPhone = document.getElementById('searchPhone')?.value?.toLowerCase() || '';
                const filterStatus = document.getElementById('filterClaimStatus')?.value || '';
                const filterNetwork = document.getElementById('filterClaimNetwork')?.value || '';
                const filterDateVal = document.getElementById('filterClaimDate')?.value || 'all';

                let filtered = [...incomingPayments];

                // Apply filters
                if (searchTxnId) {
                    filtered = filtered.filter(p => (p.transactionId || '').toLowerCase().includes(searchTxnId));
                }
                if (searchPhone) {
                    filtered = filtered.filter(p => (p.phone || '').toLowerCase().includes(searchPhone));
                }
                if (filterStatus) {
                    filtered = filtered.filter(p => p.status === filterStatus);
                }
                if (filterNetwork) {
                    filtered = filtered.filter(p => p.network === filterNetwork);
                }

                // Date filter
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (filterDateVal === 'today') {
                    filtered = filtered.filter(p => new Date(p.receivedAt) >= today);
                } else if (filterDateVal === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    filtered = filtered.filter(p => new Date(p.receivedAt) >= weekAgo);
                } else if (filterDateVal === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    filtered = filtered.filter(p => new Date(p.receivedAt) >= monthAgo);
                }

                // Sort by date (newest first)
                filtered.sort((a, b) => new Date(b.receivedAt) - new Date(a.receivedAt));

                const tbody = document.getElementById('incomingPaymentsBody');
                const perPage = parseInt(document.getElementById('tablePerPage')?.value || 50);

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;"><i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>No claims found</td></tr>';
                    return;
                }
            
                tbody.innerHTML = filtered.slice(0, perPage).map(payment => `
                    <tr>
                        <td>${formatPaymentDate(payment.receivedAt)}</td>
                        <td>
                            <strong>${payment.senderName}</strong><br>
                            <small style="color: #6b7280;">${payment.phone}</small>
                        </td>
                        <td style="font-family: monospace; font-size: 0.85rem; color: #374151;">${payment.transactionId || 'N/A'}</td>
                        <td><strong style="color: #059669;">GHS ${payment.amount.toFixed(2)}</strong></td>
                        <td><span class="status-badge ${payment.status}">${capitalizeFirst(payment.status)}</span></td>
                        <td>
                            ${payment.status === 'pending' ? `
                                <div style="display: flex; gap: 5px;">
                                    <button class="claim-action-btn credit" onclick="openVerifyClaimModal('${payment.id}')" title="Verify & Approve">
                                        <i class="fas fa-check-circle"></i> Verify
                                    </button>
                                    <button class="claim-action-btn" onclick="rejectClaim('${payment.id}')" title="Reject Claim" style="background: #fee2e2; color: #dc2626;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            ` : payment.status === 'completed' ? `
                                <span style="color: #10b981; font-size: 0.85rem;"><i class="fas fa-check-circle"></i> Approved</span>
                            ` : `
                                <span style="color: #dc2626; font-size: 0.85rem;"><i class="fas fa-times-circle"></i> Rejected</span>
                            `}
                        </td>
                    </tr>
                `).join('');
            });
        }
        
        function formatPaymentDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch { return dateStr; }
        }
        
        function capitalizeFirst(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        }
        
        // ========== CLAIM VERIFICATION SYSTEM ==========
        let currentVerifyClaimId = null;
        
        function openVerifyClaimModal(claimId) {
            currentVerifyClaimId = claimId;
            const claim = incomingPayments.find(p => p.id === claimId);
            if (!claim) return;
            
            // Show claim info in modal (but don't reveal the actual values admin must verify)
            document.getElementById('verifyClaimUser').textContent = `${claim.senderName} (${claim.phone})`;
            document.getElementById('verifyClaimDate').textContent = formatPaymentDate(claim.receivedAt);
            
            // Clear input fields
            document.getElementById('verifyTransactionId').value = '';
            document.getElementById('verifyAmount').value = '';
            
            document.getElementById('verifyClaimModal').classList.add('active');
        }
        
        function closeVerifyClaimModal() {
            currentVerifyClaimId = null;
            document.getElementById('verifyClaimModal').classList.remove('active');
        }
        
        async function submitClaimVerification() {
            if (!currentVerifyClaimId) return;
            
            const transactionId = document.getElementById('verifyTransactionId').value.trim();
            const amount = parseFloat(document.getElementById('verifyAmount').value);
            
            if (!transactionId) {
                showToast('Please enter the transaction ID', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            try {
                const res = await adminFetch(`/api/wallet/deposit/${currentVerifyClaimId}/confirm`, {
                    method: 'POST',
                    body: JSON.stringify({ transactionId, amount })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.message || data.error || 'Verification failed');
                }
                
                closeVerifyClaimModal();
                await loadIncomingPayments(true); // Force refresh to bypass cache
                await initUsersData();
                updateWalletStats();
                renderUserWallets();
                renderIncomingPayments();
                showToast('Claim verified and approved! Funds credited to user.', 'success');
            } catch (err) {
                showToast('Verification Failed: ' + err.message, 'error');
            }
        }
        
        async function rejectClaim(claimId) {
            const reason = await showConfirmModal({
                title: 'Reject Claim',
                message: 'Please provide a reason for rejecting this claim.',
                type: 'danger',
                confirmText: 'Reject Claim',
                cancelText: 'Cancel',
                showInput: true,
                inputLabel: 'Rejection Reason (optional)',
                inputPlaceholder: 'e.g., Invalid transaction reference...'
            });
            if (reason === false) return; // User cancelled
            
            try {
                const res = await adminFetch(`/api/wallet/deposit/${claimId}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ reason: reason || '' })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to reject claim');
                }
                
                await loadIncomingPayments(true); // Force refresh to bypass cache
                renderIncomingPayments();
                showToast('Claim rejected', 'success');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        function openAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.add('active');
            document.getElementById('newPaymentTxnId').value = '';
            document.getElementById('newPaymentAmount').value = '';
            document.getElementById('newPaymentSenderName').value = '';
            document.getElementById('newPaymentPhone').value = '';
            document.getElementById('newPaymentNetwork').value = 'MTN';
            document.getElementById('newPaymentRef').value = '';
        }
        
        function closeAddPaymentModal() {
            document.getElementById('addPaymentModal').classList.remove('active');
        }
        
        async function addIncomingPayment() {
            const txnId = document.getElementById('newPaymentTxnId').value.trim();
            const amount = parseFloat(document.getElementById('newPaymentAmount').value);
            const senderName = document.getElementById('newPaymentSenderName').value.trim();
            const phone = document.getElementById('newPaymentPhone').value.trim();
            const network = document.getElementById('newPaymentNetwork').value;
            const reference = document.getElementById('newPaymentRef').value.trim();
            if (!txnId || !amount) {
                showToast('Transaction ID and Amount are required', 'error');
                return;
            }
            try {
                const res = await adminFetch('/api/wallet/deposit', {
                    method: 'POST',
                    body: JSON.stringify({
                        transactionId: txnId,
                        amount,
                        senderName,
                        phone,
                        network,
                        reference
                    })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || 'Failed to add payment');
                }
                await loadIncomingPayments();
                closeAddPaymentModal();
                renderIncomingPayments();
                showToast('Payment of ' + amount.toFixed(2) + ' added successfully');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        ['searchTxnId', 'searchPhone', 'filterClaimStatus', 'filterClaimNetwork', 'filterClaimDate'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', renderIncomingPayments);
            document.getElementById(id)?.addEventListener('input', renderIncomingPayments);
        });
        
        // ========== ALL TRANSACTIONS TAB ==========
        let allTransactions = [];
        
        function gatherAllTransactions() {
            allTransactions = [];
            usersData.forEach(user => {
                (user.transactions || []).forEach(txn => {
                    allTransactions.push({
                        ...txn,
                        date: txn.date || txn.createdAt, // Use createdAt if date not available
                        userName: user.name,
                        userPhone: user.phone,
                        userId: user.id
                    });
                });
            });
            // Sort by date (newest first)
            allTransactions.sort((a, b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
        }
        
        function renderAllTransactions(searchTerm = '', typeFilter = '') {
            gatherAllTransactions();
            
            let filtered = allTransactions;
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(t => 
                    (t.userName || '').toLowerCase().includes(term) ||
                    (t.description || '').toLowerCase().includes(term) ||
                    (t.id || '').toLowerCase().includes(term)
                );
            }
            
            if (typeFilter) {
                // Filter by credit (positive amounts) or debit (negative amounts)
                filtered = filtered.filter(t => {
                    const txnType = (t.type || '').toLowerCase();
                    const amount = t.amount || 0;
                    const isCredit = amount > 0 || txnType === 'deposit' || txnType === 'refund' || txnType === 'transfer_in' || txnType === 'credit';
                    
                    if (typeFilter === 'credit') return isCredit;
                    if (typeFilter === 'debit') return !isCredit;
                    return true;
                });
            }
            
            const tbody = document.getElementById('allTransactionsBody');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><p>No transactions found</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.slice(0, 100).map(txn => {
                const txnType = (txn.type || '').toLowerCase();
                const isCredit = txnType === 'credit' || txnType === 'deposit' || txnType === 'refund';
                return `
                <tr>
                    <td>${formatTransactionDate(txn.date || txn.createdAt)}</td>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="width:30px;height:30px;font-size:0.75rem;">${(txn.userName || 'U').charAt(0)}</div>
                            <div>
                                <div class="user-name" style="font-size:0.9rem;">${txn.userName || 'Unknown'}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="txn-type-badge ${isCredit ? 'credit' : 'debit'}">${txn.type || 'N/A'}</span></td>
                    <td class="txn-amount ${isCredit ? 'credit' : 'debit'}">${isCredit ? '+' : '-'}GH ${(txn.amount || 0).toFixed(2)}</td>
                    <td>${txn.description || 'N/A'}</td>
                    <td>${txn.processedBy || txn.verifiedBy || 'System'}</td>
                </tr>
            `}).join('');
        }
        
        // Transaction search and filter
        document.getElementById('txnSearch')?.addEventListener('input', function() {
            const typeFilter = document.getElementById('txnTypeFilter')?.value || '';
            renderAllTransactions(this.value, typeFilter);
        });
        
        document.getElementById('txnTypeFilter')?.addEventListener('change', function() {
            const searchTerm = document.getElementById('txnSearch')?.value || '';
            renderAllTransactions(searchTerm, this.value);
        });

        // ========== HISTORY SECTION ==========
        let historyData = [];
        let historyPerPage = 100;
        
        function loadHistorySection() {
            loadHistoryData();
            populateHistoryFilters();
            updateHistoryStats();
            renderHistoryTable();
        }
        
        function loadHistoryData() {
            const orders = [...ordersCache];
            // Sort orders by date descending (newest first)
            orders.sort((a, b) => new Date(b.createdAt || b.timestamp) - new Date(a.createdAt || a.timestamp));
            const totalOrders = orders.length;
            
            historyData = orders.map((order, idx) => {
                const bundle = order.bundle || {};
                const userName = order.user?.name || order.userName || order.name || 'Unknown User';
                const userId = order.userId || order.user?.id || '';
                const agentCode = generateAgentCode(userId);
                const orderNum = formatOrderNumber(idx, totalOrders);
                
                // Extract data size from bundle
                let bundleSize = '0';
                const dataAmount = bundle.dataAmount || order.dataAmount || bundle.name || order.bundle || '';
                const match = dataAmount.toString().match(/(\d+\.?\d*)\s*(GB|MB)?/i);
                if (match) {
                    bundleSize = match[2]?.toUpperCase() === 'MB' ? (parseFloat(match[1]) / 1024).toFixed(2) : match[1];
                }
                
                return {
                    id: order.id || `ORD-${String(idx + 1).padStart(4, '0')}`,
                    orderNo: orderNum,
                    date: order.createdAt || order.orderDate || order.timestamp || new Date().toISOString(),
                    userName: userName,
                    userPhone: order.user?.phone || order.userPhone || '',
                    recipient: order.recipientPhone || order.recipientNumber || order.recipient || 'N/A',
                    network: bundle.network || order.network || 'N/A',
                    bundle: bundle.name || order.bundle || order.packageName || 'N/A',
                    bundleSize: bundleSize,
                    amount: parseFloat(order.totalPrice || order.total || order.amount || 0),
                    status: (order.status || 'PENDING').toLowerCase(),
                    paymentStatus: (order.paymentStatus || order.payment || 'COMPLETED').toLowerCase(),
                    agent: userName,
                    agentCode: agentCode,
                    reference: order.reference || order.txId || '-'
                };
            });
        }
        
        function populateHistoryFilters() {
            // Populate network filter
            const networkFilter = document.getElementById('filterNetworkHistory');
            if (networkFilter) {
                const networks = [...new Set(historyData.map(h => h.network))];
                networkFilter.innerHTML = '<option value="">-- Select Network --</option>' +
                    networks.map(n => `<option value="${n}">${n}</option>`).join('');
            }
            
            // Populate agent filter
            const agentFilter = document.getElementById('filterAgentHistory');
            if (agentFilter) {
                const agents = [...new Set(historyData.map(h => `${h.userName} ${h.agentCode}`))];
                agentFilter.innerHTML = '<option value="">-- Select Agent --</option>' +
                    agents.map(a => `<option value="${a}">${a}</option>`).join('');
            }
        }
        
        function updateHistoryStats() {
            const filtered = getFilteredHistoryData();
            
            // Calculate stats
            const totalOrders = filtered.length;
            const totalAmount = filtered.reduce((sum, h) => sum + h.amount, 0);
            
            // Calculate total data in GB
            let totalDataGB = 0;
            filtered.forEach(h => {
                const size = h.bundleSize.toString().toUpperCase();
                if (size.includes('GB')) {
                    totalDataGB += parseFloat(size) || 0;
                } else if (size.includes('MB')) {
                    totalDataGB += (parseFloat(size) || 0) / 1024;
                } else {
                    // Assume it's GB if just a number
                    totalDataGB += parseFloat(size) || 0;
                }
            });
            
            document.getElementById('historyStatOrders').textContent = totalOrders.toLocaleString();
            document.getElementById('historyStatAmount').textContent = `GH ${totalAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('historyStatBundle').textContent = `${totalDataGB.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} GB`;
        }
        
        function getFilteredHistoryData() {
            const dateFrom = document.getElementById('filterDateFrom')?.value || '';
            const dateTo = document.getElementById('filterDateTo')?.value || '';
            const orderNo = document.getElementById('filterOrderNoModal')?.value?.trim() || '';
            const phone = document.getElementById('filterPhoneModal')?.value?.trim() || '';
            const status = document.getElementById('filterStatusHistory')?.value || '';
            const payment = document.getElementById('filterPaymentHistory')?.value || '';
            const agent = document.getElementById('filterAgentHistory')?.value || '';
            const network = document.getElementById('filterNetworkHistory')?.value || '';
            
            let filtered = [...historyData];
            
            // Date range filter
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(h => new Date(h.date) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(h => new Date(h.date) <= toDate);
            }
            
            // Order number filter
            if (orderNo) {
                filtered = filtered.filter(h => 
                    h.orderNo.toString().includes(orderNo) || 
                    h.id.toLowerCase().includes(orderNo.toLowerCase())
                );
            }
            
            // Phone filter - only filter if input contains only digits
            if (phone && /^\d+$/.test(phone)) {
                filtered = filtered.filter(h => 
                    h.recipient.includes(phone) || 
                    h.userPhone.includes(phone)
                );
            }
            
            // Status filter
            if (status) {
                filtered = filtered.filter(h => h.status === status);
            }
            
            // Payment filter
            if (payment) {
                filtered = filtered.filter(h => h.paymentStatus === payment);
            }
            
            // Agent filter
            if (agent) {
                filtered = filtered.filter(h => `${h.userName} ${h.agentCode}` === agent);
            }
            
            // Network filter
            if (network) {
                filtered = filtered.filter(h => h.network === network);
            }
            
            return filtered;
        }
        
        function filterHistory() {
            updateHistoryStats();
            renderHistoryTable();
        }
        
        // Toggle filter visibility
        function toggleHistoryFilters() {
            const content = document.getElementById('historyFilterContent');
            const header = document.querySelector('.history-filter-header');
            const icon = document.getElementById('filterToggleIcon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        }
        
        function clearHistoryFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterOrderNoModal').value = '';
            document.getElementById('filterPhoneModal').value = '';
            document.getElementById('filterStatusHistory').value = '';
            document.getElementById('filterPaymentHistory').value = '';
            document.getElementById('filterAgentHistory').value = '';
            document.getElementById('filterNetworkHistory').value = '';
            filterHistory();
        }
        
        // Add event listeners for filter inputs
        document.addEventListener('DOMContentLoaded', function() {
            const filterInputs = ['filterDateFrom', 'filterDateTo', 'filterOrderNoModal', 'filterPhoneModal', 'filterStatusHistory', 'filterPaymentHistory', 'filterAgentHistory', 'filterNetworkHistory'];
            filterInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', filterHistory);
                    if (el.tagName === 'INPUT' && el.type === 'text') {
                        el.addEventListener('keyup', filterHistory);
                    }
                }
            });
        });
        
        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            const filtered = getFilteredHistoryData();
            const perPage = parseInt(document.getElementById('historyPerPage')?.value || 100);
            
            // Update page info
            const pageInfo = document.getElementById('historyPageInfo');
            if (pageInfo) {
                pageInfo.textContent = `Showing ${Math.min(filtered.length, perPage)} of ${filtered.length} orders`;
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10">
                    ${createEmptyState(
                        'fas fa-history',
                        'No Order History',
                        'Completed orders will appear here for reference',
                        null,
                        null
                    )}
                </td></tr>`;
                return;
            }
            
            tbody.innerHTML = filtered.slice(0, perPage).map(h => `
                <tr>
                    <td>${formatHistoryDate(h.date)}</td>
                    <td><strong>${h.userName}</strong> ${h.agentCode}</td>
                    <td><strong>${h.orderNo}</strong></td>
                    <td>${h.recipient}</td>
                    <td>${h.network}</td>
                    <td>${h.bundleSize} GB</td>
                    <td><strong>${h.amount.toFixed(2)}</strong></td>
                    <td><span class="status-badge ${h.paymentStatus}">${h.paymentStatus}</span></td>
                    <td><span class="status-badge ${h.status}">${h.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn refund" title="Refund" onclick="refundOrder('${h.id}')">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="action-btn approve" title="Approve" onclick="approveOrder('${h.id}')">
                                <i class="fas fa-check"></i>
                            </button>
                            <span class="action-btn status-dot"></span>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function formatHistoryDate(dateStr) {
            const date = new Date(dateStr);
            const day = date.getUTCDate();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[date.getUTCMonth()];
            const year = date.getUTCFullYear();
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            
            // Add ordinal suffix
            const ordinal = (d) => {
                if (d > 3 && d < 21) return 'th';
                switch (d % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            };
            
            return `${day}${ordinal(day)} ${month} ${year} at ${hours}:${minutes}`;
        }
        
        async function refundOrder(orderId) {
            const confirmed = await showConfirmModal({
                title: 'Refund Order',
                message: 'Are you sure you want to refund this order? This will set the order status to CANCELLED and credit the amount back to the user\'s wallet.',
                type: 'warning',
                confirmText: 'Refund Order',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            try {
                const res = await adminFetch(`/api/orders/${orderId}/refund`, {
                    method: 'POST'
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to refund order');
                }
                const result = await res.json();
                showToast(`Order refunded! GHS ${result.refundedAmount?.toFixed(2) || ''} credited to user wallet`);
                loadStats();
                loadHistoryData();
                renderHistoryTable();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        async function approveOrder(orderId) {
            const confirmed = await showConfirmModal({
                title: 'Approve Order',
                message: 'Mark this order as approved and completed?',
                type: 'success',
                confirmText: 'Approve',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            try {
                const res = await adminFetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'COMPLETED' })
                });
                if (!res.ok) throw new Error('Failed to approve order');
                showToast('Order approved successfully!');
                loadStats();
                if (typeof loadHistoryData === 'function') loadHistoryData();
                if (typeof renderHistoryTable === 'function') renderHistoryTable();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        function exportHistory() {
            const filtered = getFilteredHistoryData();
            
            if (filtered.length === 0) {
                alert('No orders to export');
                return;
            }
            
            const fromDate = document.getElementById('filterDateFrom')?.value || 'all';
            const toDate = document.getElementById('filterDateTo')?.value || 'time';
            
            const headers = ['Order Date', 'Agent', 'Order #', 'Recipient', 'Network', 'Data (GB)', 'Total (GHS)', 'Payment', 'Order Status'];
            const rows = filtered.map(h => [
                formatHistoryDate(h.date), 
                `${h.userName} ${h.agentCode}`,
                h.orderNo,
                h.recipient, 
                h.network, 
                h.bundleSize,
                h.amount.toFixed(2), 
                h.paymentStatus,
                h.status
            ]);
            
            const csvContent = [headers.join(','), ...rows.map(r => r.map(cell => `"${cell}"`).join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order_history_${fromDate}_to_${toDate}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('History exported successfully!');
        }

        // ========== NETWORKS SECTION ==========

        let networksData = [];
        let bundleTariffsData = [];

        async function loadNetworksSection() {
            // Fetch all bundles from backend
            try {
                console.log('[Networks] Loading bundles...');
                const res = await adminFetch('/api/bundles');
                console.log('[Networks] Response status:', res.status);
                if (!res.ok) throw new Error('Failed to fetch bundles from backend');
                const bundles = await res.json();
                console.log('[Networks] Bundles received:', bundles.length, bundles);

                // Group bundles by network for UI
                const networkMap = {};
                bundles.forEach(b => {
                    const net = b.network.toUpperCase();
                    if (!networkMap[net]) {
                        networkMap[net] = [];
                    }
                    networkMap[net].push(b);
                });

                // Build networksData and bundleTariffsData for UI compatibility
                networksData = Object.keys(networkMap).map((net, idx) => ({
                    id: 'net-' + (idx + 1),
                    name: net,
                    active: networkMap[net].some(b => b.isActive)
                }));
                bundleTariffsData = bundles.map(b => ({
                    id: b.id,
                    networkId: networksData.find(n => n.name === b.network.toUpperCase())?.id || '',
                    network: b.network,
                    capacity: b.dataAmount,
                    cost: b.basePrice || 0,
                    // Role prices from API (admin sees rolePrices object)
                    partner: b.rolePrices?.PARTNER || '',
                    superDealer: b.rolePrices?.SUPER_DEALER || '',
                    dealer: b.rolePrices?.DEALER || '',
                    superAgent: b.rolePrices?.SUPER_AGENT || '',
                    agent: b.rolePrices?.AGENT || '',
                    active: b.isActive,
                    validity: b.validity,
                    description: b.description || ''
                }));
                
                console.log('[Networks] networksData:', networksData);
                console.log('[Networks] bundleTariffsData:', bundleTariffsData);

                renderNetworkCards();
                renderBundleTariffs();
                populateNetworkDropdowns();
                // Initial sync to frontend
                syncBundlesToFrontend();
            } catch (err) {
                console.error('[Networks] Error:', err);
                showToast('Error loading bundles: ' + err.message, 'error');
            }
        }
        
        // Render Network Cards
        function renderNetworkCards() {
            const container = document.getElementById('networksCardsGrid');
            
            if (networksData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No networks registered yet</p>';
                return;
            }
            
            container.innerHTML = networksData.map(net => `
                <div class="network-card-new ${net.name.toLowerCase().replace(/\s+/g, '-')}">
                    <div class="network-card-actions">
                        <button class="edit-network" onclick="editNetwork('${net.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-network" onclick="deleteNetwork('${net.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="network-card-toggle">
                        <div class="network-toggle-switch" onclick="toggleNetworkStatus('${net.id}')">
                            <div class="toggle-track ${net.active ? 'active' : ''}">
                                <div class="toggle-thumb"></div>
                            </div>
                            <span class="toggle-label">${net.active ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                    <div class="network-card-name">${net.name}</div>
                </div>
            `).join('');
        }
        
        // Render Bundle Tariffs Table
        function renderBundleTariffs(filterNetwork = '') {
            const tbody = document.getElementById('bundleTariffsBody');
            let filtered = bundleTariffsData;
            
            if (filterNetwork) {
                filtered = bundleTariffsData.filter(b => b.networkId === filterNetwork || b.network === filterNetwork);
            }
            
            // Sort by network first, then by capacity (ascending order)
            filtered = [...filtered].sort((a, b) => {
                // First sort by network name
                const netA = (a.network || '').toUpperCase();
                const netB = (b.network || '').toUpperCase();
                if (netA !== netB) {
                    return netA.localeCompare(netB);
                }
                // Then sort by capacity (numeric)
                const capA = parseFloat((a.capacity || '').replace(/[^\d.]/g, '')) || 0;
                const capB = parseFloat((b.capacity || '').replace(/[^\d.]/g, '')) || 0;
                return capA - capB;
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #9ca3af;">
                            <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No bundles configured yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filtered.map(b => {
                // Check if parent network is active
                const parentNetwork = networksData.find(n => n.id === b.networkId);
                const networkInactive = !parentNetwork || !parentNetwork.active;
                const isDisabled = networkInactive && !b.active;
                
                return `
                <tr class="${networkInactive ? 'network-inactive-row' : ''}">
                    <td class="network-name">
                        ${b.network}
                        ${networkInactive ? '<span class="network-badge-inactive"><i class="fas fa-ban"></i> Network Off</span>' : ''}
                    </td>
                    <td>${b.capacity}</td>
                    <td>${parseFloat(b.cost).toFixed(2)}</td>
                    <td>${parseFloat(b.superDealer || 0).toFixed(2)}</td>
                    <td>${parseFloat(b.dealer || 0).toFixed(2)}</td>
                    <td>${parseFloat(b.superAgent || 0).toFixed(2)}</td>
                    <td>${parseFloat(b.agent).toFixed(2)}</td>
                    <td>
                        <div class="bundle-status-toggle">
                            <div class="mini-toggle ${b.active ? 'active' : ''} ${networkInactive ? 'disabled' : ''}"
                                 data-action="${networkInactive && !b.active ? 'show-toast' : 'toggle-bundle-status'}" data-id="${b.id}"
                                 data-message="Enable the network first to activate this bundle" data-type="error"
                                 title="${networkInactive && !b.active ? 'Network is inactive - enable network first' : ''}">
                                <div class="mini-toggle-thumb"></div>
                            </div>
                            <span class="status-text ${networkInactive ? 'text-muted' : ''}">${b.active ? 'Active' : 'Inactive'}</span>
                            ${networkInactive ? '<span class="out-of-stock-badge">Out of Stock</span>' : ''}
                        </div>
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-edit" data-action="edit-bundle-tariff" data-id="${b.id}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete" data-action="delete-bundle-tariff" data-id="${b.id}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        // Populate network dropdowns
        function populateNetworkDropdowns() {
            const filterSelect = document.getElementById('bundleNetworkFilter');
            const bundleSelectEdit = document.getElementById('bundleNetworkEdit');
            const bundleSelectAdd = document.getElementById('bundleNetworkAdd');
            
            const options = '<option value="">-- Select Network --</option>' + 
                networksData.map(n => `<option value="${n.id}">${n.name}</option>`).join('');
            
            if (filterSelect) filterSelect.innerHTML = options;
            if (bundleSelectEdit) bundleSelectEdit.innerHTML = options;
            if (bundleSelectAdd) bundleSelectAdd.innerHTML = options;
        }
        
        // Filter bundle tariffs
        function filterBundleTariffs() {
            const networkId = document.getElementById('bundleNetworkFilter').value;
            renderBundleTariffs(networkId);
        }
        
        // Toggle network status
        async function toggleNetworkStatus(networkId) {
            const idx = networksData.findIndex(n => n.id === networkId);
            if (idx === -1) return;
            
            const wasActive = networksData[idx].active;
            const newActiveState = !wasActive;
            
            // Get all bundles under this network
            const networkBundles = bundleTariffsData.filter(b => b.networkId === networkId);
            
            if (networkBundles.length === 0) {
                showToast('No bundles found for this network', 'error');
                return;
            }
            
            try {
                // Update all bundles in the database
                const updatePromises = networkBundles.map(bundle => 
                    adminFetch(`/api/bundles/${bundle.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            isActive: newActiveState
                        })
                    })
                );
                
                const results = await Promise.all(updatePromises);
                const allSuccessful = results.every(r => r.ok);
                
                if (!allSuccessful) {
                    throw new Error('Some bundles failed to update');
                }
                
                // Reload data from server to get fresh state
                await loadNetworksSection();
                
                if (wasActive) {
                    showToast(`Network deactivated - All ${networkBundles.length} bundles are now inactive`);
                } else {
                    showToast(`Network activated - All ${networkBundles.length} bundles are now active`);
                }
            } catch (err) {
                showToast('Error updating network: ' + err.message, 'error');
                // Reload to restore correct state
                await loadNetworksSection();
            }
        }
        
        // Toggle bundle status
        async function toggleBundleStatus(bundleId) {
            const idx = bundleTariffsData.findIndex(b => b.id === bundleId);
            if (idx === -1) return;
            const bundle = bundleTariffsData[idx];
            // Check if trying to activate
            if (!bundle.active) {
                // Check if parent network is active
                const network = networksData.find(n => n.id === bundle.networkId);
                if (!network || !network.active) {
                    showToast('Cannot activate bundle - Parent network is inactive. Activate the network first.', 'error');
                    return;
                }
            }
            try {
                const res = await adminFetch(`/api/bundles/${bundleId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        isActive: !bundle.active
                    })
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Failed to update bundle status');
                await loadNetworksSection();
                showToast('Bundle status updated');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        // Sync bundles - No longer needed since client fetches from API
        function syncBundlesToFrontend() {
            console.log(' syncBundlesToFrontend: Client now fetches directly from API');
            // No localStorage sync needed - client uses /api/bundles endpoint
        }
        
        // Network Modal Functions
        let editingNetworkId = null;
        
        function openAddNetworkModal() {
            editingNetworkId = null;
            document.getElementById('networkModalTitle').textContent = 'Add New Network';
            document.getElementById('networkForm').reset();
            document.getElementById('editNetworkId').value = '';
            document.getElementById('networkModal').classList.add('active');
        }
        
        function editNetwork(networkId) {
            const network = networksData.find(n => n.id === networkId);
            if (!network) return;
            
            editingNetworkId = networkId;
            document.getElementById('networkModalTitle').textContent = 'Edit Network';
            document.getElementById('editNetworkId').value = networkId;
            document.getElementById('networkName').value = network.name;
            document.getElementById('networkModal').classList.add('active');
        }
        
        function closeNetworkModal() {
            document.getElementById('networkModal').classList.remove('active');
        }
        
        async function saveNetwork(e) {
            if (e) e.preventDefault();
            
            const networkName = document.getElementById('networkName')?.value?.trim();
            if (!networkName) {
                showToast('Please enter a network name', 'error');
                return;
            }
            
            if (editingNetworkId) {
                // Update existing network
                const idx = networksData.findIndex(n => n.id === editingNetworkId);
                if (idx !== -1) {
                    const oldName = networksData[idx].name;
                    networksData[idx].name = networkName.toUpperCase();
                    
                    // Update network name in all associated bundles
                    bundleTariffsData.forEach(b => {
                        if (b.networkId === editingNetworkId) {
                            b.network = networkName.toUpperCase();
                        }
                    });
                    
                    showToast('Network updated successfully!');
                }
            } else {
                // Create new network
                const newId = 'net-' + (networksData.length + 1) + '-' + Date.now();
                networksData.push({
                    id: newId,
                    name: networkName.toUpperCase(),
                    active: true
                });
                showToast('Network added successfully!');
            }
            
            closeNetworkModal();
            renderNetworkCards();
            renderBundleTariffs();
            populateNetworkDropdowns();
            syncBundlesToFrontend();
        }
        
        async function bulkComplete() {
            // Check if any orders are selected
            const selected = getSelectedOrders();
            
            // If orders are selected, complete only those
            if (selected.length > 0) {
                const confirmed = await showConfirmModal({
                    title: 'Complete Selected Orders',
                    message: `Mark ${selected.length} selected order(s) as completed?`,
                    type: 'success',
                    confirmText: 'Complete Selected',
                    cancelText: 'Cancel'
                });
                if (!confirmed) return;
                let success = 0;
                for (const id of selected) {
                    try {
                        // Try new OrderItem endpoint first, fallback to legacy
                        let res = await adminFetch(`/api/order-groups/admin/item/${id}/complete`, {
                            method: 'POST'
                        });
                        if (!res.ok) {
                            res = await adminFetch(`/api/orders/${id}/status`, {
                                method: 'PUT',
                                body: JSON.stringify({ status: 'COMPLETED' })
                            });
                        }
                        if (res.ok) success++;
                    } catch {}
                }
                loadStats();
                document.getElementById('selectAll').checked = false;
                showToast(`${success} order(s) completed`);
            } else {
                // No orders selected - complete ALL processing orders
                const confirmed = await showConfirmModal({
                    title: 'Complete All Processing Orders',
                    message: 'Mark ALL orders with PROCESSING status as COMPLETED?',
                    type: 'success',
                    confirmText: 'Complete All Processing',
                    cancelText: 'Cancel'
                });
                if (!confirmed) return;
                
                try {
                    const res = await adminFetch('/api/order-groups/admin/complete-all-processing', {
                        method: 'POST'
                    });
                    if (res.ok) {
                        const result = await res.json();
                        showToast(result.message || 'Processing orders completed');
                    } else {
                        const err = await res.json();
                        showToast('Error: ' + (err.error || 'Failed to complete orders'), 'error');
                    }
                } catch (err) {
                    showToast('Error completing orders', 'error');
                }
                loadStats();
            }
        }

        async function bulkCancel() {
            const selected = getSelectedOrders();
            if (selected.length === 0) {
                showToast('Please select orders first', 'error');
                return;
            }
            const confirmed = await showConfirmModal({
                title: 'Cancel Selected Orders',
                message: `Cancel ${selected.length} order(s) and issue refunds?`,
                type: 'danger',
                confirmText: 'Cancel & Refund',
                cancelText: 'Keep Orders'
            });
            if (!confirmed) return;
            let success = 0;
            for (const id of selected) {
                try {
                    const res = await adminFetch(`/api/orders/${id}/cancel`, {
                        method: 'POST'
                    });
                    if (res.ok) success++;
                } catch {}
            }
            loadStats();
            document.getElementById('selectAll').checked = false;
            showToast(`${success} order(s) cancelled`);
        }
        async function deleteNetwork(networkId) {
            const confirmed = await showConfirmModal({
                title: 'Delete Network',
                message: 'Delete this network? All bundles for this network will also be removed. This action cannot be undone.',
                type: 'danger',
                confirmText: 'Delete Network',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            
            networksData = networksData.filter(n => n.id !== networkId);
            bundleTariffsData = bundleTariffsData.filter(b => b.networkId !== networkId);
            
            
            renderNetworkCards();
            renderBundleTariffs();
            populateNetworkDropdowns();
            showToast('Network deleted');
            
            // Sync to frontend
            syncBundlesToFrontend();
        }
        
        // Bundle Modal Functions
        let editingBundleId = null;
        
        function openAddBundleModal() {
            editingBundleId = null;
            // Try to set title on both possible modal structures
            const titleEl = document.getElementById('bundleModalTitle');
            if (titleEl) titleEl.textContent = 'Add New Bundle';
            
            // Reset form fields
            if (document.getElementById('bundleForm')) {
                document.getElementById('bundleForm').reset();
            }
            // Clear edit IDs
            if (document.getElementById('editBundleIdEdit')) {
                document.getElementById('editBundleIdEdit').value = '';
            }
            if (document.getElementById('bundleIdAdd')) {
                document.getElementById('bundleIdAdd').value = '';
            }
            document.getElementById('bundleModal').classList.add('active');
        }
        
        function editBundleTariff(bundleId) {
            const bundle = bundleTariffsData.find(b => b.id === bundleId);
            if (!bundle) return;
            
            editingBundleId = bundleId;
            const titleEl = document.getElementById('bundleModalTitle');
            if (titleEl) titleEl.textContent = 'Edit Bundle';
            
            // Set IDs
            if (document.getElementById('editBundleIdEdit')) {
                document.getElementById('editBundleIdEdit').value = bundleId;
            }
            
            // Set Edit form fields
            if (document.getElementById('bundleNetworkEdit')) {
                document.getElementById('bundleNetworkEdit').value = bundle.networkId || '';
            }
            if (document.getElementById('bundleCapacityEdit')) {
                document.getElementById('bundleCapacityEdit').value = bundle.capacity || '';
            }
            if (document.getElementById('bundleCostEdit')) {
                document.getElementById('bundleCostEdit').value = bundle.cost || '';
            }
            if (document.getElementById('bundlePartnerEdit')) {
                document.getElementById('bundlePartnerEdit').value = bundle.partner || '';
            }
            if (document.getElementById('bundleSuperDealerEdit')) {
                document.getElementById('bundleSuperDealerEdit').value = bundle.superDealer || '';
            }
            if (document.getElementById('bundleDealerEdit')) {
                document.getElementById('bundleDealerEdit').value = bundle.dealer || '';
            }
            if (document.getElementById('bundleSuperAgentEdit')) {
                document.getElementById('bundleSuperAgentEdit').value = bundle.superAgent || '';
            }
            if (document.getElementById('bundleAgentEdit')) {
                document.getElementById('bundleAgentEdit').value = bundle.agent || '';
            }
            if (document.getElementById('bundleStatusEdit')) {
                document.getElementById('bundleStatusEdit').value = bundle.active ? 'active' : 'inactive';
            }
            
            document.getElementById('bundleModal').classList.add('active');
        }
        
        function closeBundleModal() {
            document.getElementById('bundleModal').classList.remove('active');
        }
        
        function closeBundleModalAdd() {
            document.getElementById('bundleModalAdd')?.classList.remove('active');
        }
        
        async function saveBundleAdd() {
            // Get form values
            const networkId = document.getElementById('bundleNetworkAdd')?.value || '';
            const name = document.getElementById('bundleNameAdd')?.value?.trim() || '';
            const capacity = document.getElementById('bundleCapacityAdd')?.value?.trim() || '';
            const validity = document.getElementById('bundleValidityAdd')?.value?.trim() || '';
            const costPrice = parseFloat(document.getElementById('bundleCostPriceAdd')?.value) || 0;
            
            // Get role prices - STRICT: only set prices are sent
            const partnerPrice = document.getElementById('bundlePartnerPriceAdd')?.value;
            const superDealerPrice = document.getElementById('bundleSuperDealerPriceAdd')?.value;
            const dealerPrice = document.getElementById('bundleDealerPriceAdd')?.value;
            const superAgentPrice = document.getElementById('bundleSuperAgentPriceAdd')?.value;
            const agentPrice = document.getElementById('bundleAgentPriceAdd')?.value;
            
            if (!capacity || !agentPrice) {
                showToast('Please fill all required fields (Capacity and Agent Price)', 'error');
                return;
            }
            
            const network = networksData.find(n => n.id === networkId);
            const networkName = network ? network.name : (networkId || 'MTN');
            
            // Build request body - STRICT: only include prices that are set
            const requestBody = {
                name: name || (networkName + ' ' + capacity),
                network: networkName,
                dataAmount: capacity,
                basePrice: costPrice,
                validity: validity
            };
            
            // Only add role prices if they are explicitly set
            if (partnerPrice !== '' && partnerPrice !== undefined) requestBody.partnerPrice = parseFloat(partnerPrice);
            if (superDealerPrice !== '' && superDealerPrice !== undefined) requestBody.superDealerPrice = parseFloat(superDealerPrice);
            if (dealerPrice !== '' && dealerPrice !== undefined) requestBody.dealerPrice = parseFloat(dealerPrice);
            if (superAgentPrice !== '' && superAgentPrice !== undefined) requestBody.superAgentPrice = parseFloat(superAgentPrice);
            if (agentPrice !== '' && agentPrice !== undefined) requestBody.agentPrice = parseFloat(agentPrice);
            
            try {
                const res = await adminFetch('/api/bundles', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });
                const result = await res.json();
                if (res.ok) {
                    showToast('Bundle added successfully!', 'success');
                    closeBundleModalAdd();
                    await loadNetworksSection(); // Reload bundles from API
                } else {
                    showToast(result.error || result.message || 'Failed to add bundle', 'error');
                }
            } catch (err) {
                console.error('Error saving bundle:', err);
                showToast('Error saving bundle', 'error');
            }
        }
        
        async function saveBundle() {
            // Get Edit form values
            const networkId = document.getElementById('bundleNetworkEdit')?.value || '';
            const capacity = (document.getElementById('bundleCapacityEdit')?.value || '').trim();
            const cost = document.getElementById('bundleCostEdit')?.value;
            const status = document.getElementById('bundleStatusEdit')?.value || 'active';
            const partner = document.getElementById('bundlePartnerEdit')?.value;
            const superDealer = document.getElementById('bundleSuperDealerEdit')?.value;
            const dealer = document.getElementById('bundleDealerEdit')?.value;
            const superAgent = document.getElementById('bundleSuperAgentEdit')?.value;
            const agent = document.getElementById('bundleAgentEdit')?.value;
            
            if (!capacity) {
                showToast('Please fill the Capacity field', 'error');
                return;
            }
            
            const network = networksData.find(n => n.id === networkId);
            const networkName = network ? network.name : (networkId || 'MTN');
            
            // Build request body - STRICT: only include prices that are set
            const requestBody = {
                name: networkName + ' ' + capacity,
                network: networkName,
                dataAmount: capacity,
                isActive: status === 'active'
            };
            
            // Only add prices if they are explicitly set
            if (cost !== '' && cost !== undefined) requestBody.basePrice = parseFloat(cost);
            if (partner !== '' && partner !== undefined) requestBody.partnerPrice = parseFloat(partner);
            if (superDealer !== '' && superDealer !== undefined) requestBody.superDealerPrice = parseFloat(superDealer);
            if (dealer !== '' && dealer !== undefined) requestBody.dealerPrice = parseFloat(dealer);
            if (superAgent !== '' && superAgent !== undefined) requestBody.superAgentPrice = parseFloat(superAgent);
            if (agent !== '' && agent !== undefined) requestBody.agentPrice = parseFloat(agent);
            
            try {
                let res, result;
                if (editingBundleId) {
                    // Update bundle
                    res = await adminFetch(`/api/bundles/${editingBundleId}`, {
                        method: 'PUT',
                        body: JSON.stringify(requestBody)
                    });
                    result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'Failed to update bundle');
                } else {
                    // Create bundle
                    res = await adminFetch('/api/bundles', {
                        method: 'POST',
                        body: JSON.stringify(requestBody)
                    });
                    result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'Failed to add bundle');
                }
                await loadNetworksSection();
                closeBundleModal();
                showToast(editingBundleId ? 'Bundle updated!' : 'Bundle added!');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }
        
        async function deleteBundleTariff(bundleId) {
            const confirmed = await showConfirmModal({
                title: 'Delete Bundle',
                message: 'Are you sure you want to delete this bundle? This action cannot be undone.',
                type: 'danger',
                confirmText: 'Delete Bundle',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            try {
                const res = await adminFetch(`/api/bundles/${bundleId}`, {
                    method: 'DELETE'
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error || 'Failed to delete bundle');
                await loadNetworksSection();
                showToast('Bundle deleted');
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }

        // ========== REPORTS SECTION ==========
        let currentReportPeriod = 'today';
        let currentReportTab = 'sales';
        
        function loadReportsSection() {
            calculateReportStats();
            renderSalesReport();
            renderUserReport();
        }
        
        function switchReportTab(tab) {
            currentReportTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.report-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Show/hide views
            document.getElementById('salesReportView').classList.toggle('active', tab === 'sales');
            document.getElementById('userReportView').classList.toggle('active', tab === 'users');
            
            // Refresh data for active tab
            if (tab === 'sales') {
                calculateReportStats();
                renderSalesReport();
            } else {
                renderUserReport();
            }
        }
        
        function setReportPeriod(period) {
            currentReportPeriod = period;
            
            // Update button states
            document.querySelectorAll('.report-period-filter button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(period === 'all' ? 'all' : period)) {
                    btn.classList.add('active');
                }
            });
            
            calculateReportStats();
            renderSalesReport();
        }
        
        function getFilteredOrders() {
            const orders = [...ordersCache];
            const now = new Date();
            let startDate;
            
            switch (currentReportPeriod) {
                case 'today':
                    // Start of today in UTC
                    startDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
                    break;
                case 'week':
                    // 7 days ago in UTC
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    // Start of this month in UTC
                    startDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));
                    break;
                case 'year':
                    // Start of this year in UTC
                    startDate = new Date(Date.UTC(now.getUTCFullYear(), 0, 1, 0, 0, 0));
                    break;
                default:
                    return orders;
            }
            
            return orders.filter(o => new Date(o.orderDate || o.timestamp || o.createdAt) >= startDate);
        }
        
        function calculateReportStats() {
            const filtered = getFilteredOrders();
            const bundles = bundleTariffsData;
            
            // Create bundle lookup for cost calculation
            const bundleLookup = {};
            bundles.forEach(b => {
                const key = `${b.network}-${b.name}`;
                bundleLookup[key] = {
                    agent: parseFloat(b.agent || b.agentPrice || 0),
                    price: parseFloat(b.price || 0),
                    capacity: parseFloat(b.capacity || 0)
                };
            });
            
            let totalOrders = filtered.length;
            let totalData = 0;
            let totalCost = 0;
            let totalRevenue = 0;
            
            filtered.forEach(o => {
                // Get bundle info from API response structure
                const bundleNetwork = o.bundle?.network || o.network || 'MTN';
                const bundleName = o.bundle?.name || o.bundle || o.packageName || '';
                const bundleKey = `${bundleNetwork}-${bundleName}`;
                const bundleInfo = bundleLookup[bundleKey];
                
                // Get the capacity (data) from bundle.dataAmount or parse from bundle name
                let dataGB = 0;
                const dataAmount = o.bundle?.dataAmount || '';
                if (dataAmount) {
                    const match = dataAmount.match(/(\d+\.?\d*)\s*(GB|MB)?/i);
                    if (match) {
                        dataGB = match[2]?.toUpperCase() === 'MB' ? parseFloat(match[1]) / 1000 : parseFloat(match[1]);
                    }
                } else if (bundleInfo && bundleInfo.capacity) {
                    dataGB = bundleInfo.capacity;
                }
                totalData += dataGB * (parseInt(o.quantity) || 1);
                
                // Revenue (totalPrice from order)
                const price = parseFloat(o.totalPrice || o.total || o.amount || 0);
                totalRevenue += price;
                
                // Cost calculation
                if (bundleInfo) {
                    totalCost += bundleInfo.agent * (parseInt(o.quantity) || 1);
                } else {
                    // If no bundle info, estimate cost as 95% of price
                    totalCost += price * 0.95;
                }
            });
            
            const totalProfit = totalRevenue - totalCost;
            
            document.getElementById('reportTotalOrders').textContent = totalOrders;
            document.getElementById('reportTotalData').textContent = totalData.toFixed(0);
            document.getElementById('reportTotalRevenue').textContent = `GH ${totalRevenue.toFixed(2)}`;
            document.getElementById('reportTotalProfit').textContent = `GH ${totalProfit.toFixed(2)}`;
        }
        
        function formatSalesDate(dateStr) {
            const date = new Date(dateStr);
            const day = date.getUTCDate();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[date.getUTCMonth()];
            const year = date.getUTCFullYear();
            
            // Add ordinal suffix
            const suffix = (day === 1 || day === 21 || day === 31) ? 'st' :
                          (day === 2 || day === 22) ? 'nd' :
                          (day === 3 || day === 23) ? 'rd' : 'th';
            
            return `${day}${suffix} ${month} ${year}`;
        }
        
        function renderSalesReport() {
            const filtered = getFilteredOrders();
            const tbody = document.getElementById('salesReportBody');
            const emptyState = document.getElementById('salesReportEmpty');
            const bundles = bundleTariffsData;
            
            // Create bundle lookup for cost calculation
            const bundleLookup = {};
            bundles.forEach(b => {
                const key = `${b.network}-${b.name}`;
                bundleLookup[key] = {
                    agent: parseFloat(b.agent || b.agentPrice || 0),
                    price: parseFloat(b.price || 0),
                    capacity: parseFloat(b.capacity || 0)
                };
            });
            
            // Group orders by date (UTC date string)
            const dailyData = {};
            
            filtered.forEach(o => {
                const date = new Date(o.orderDate || o.timestamp || o.createdAt);
                const dateKey = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}`;
                
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = {
                        orders: 0,
                        dataGB: 0,
                        cost: 0,
                        price: 0
                    };
                }
                
                dailyData[dateKey].orders++;
                
                // Get bundle info from API response structure
                const bundleNetwork = o.bundle?.network || o.network || 'MTN';
                const bundleName = o.bundle?.name || o.bundle || o.packageName || '';
                const bundleKey = `${bundleNetwork}-${bundleName}`;
                const bundleInfo = bundleLookup[bundleKey];
                
                // Calculate data GB from bundle.dataAmount
                let dataGB = 0;
                const dataAmount = o.bundle?.dataAmount || '';
                if (dataAmount) {
                    const match = dataAmount.match(/(\d+\.?\d*)\s*(GB|MB)?/i);
                    if (match) {
                        dataGB = match[2]?.toUpperCase() === 'MB' ? parseFloat(match[1]) / 1000 : parseFloat(match[1]);
                    }
                } else if (bundleInfo && bundleInfo.capacity) {
                    dataGB = bundleInfo.capacity;
                }
                dailyData[dateKey].dataGB += dataGB * (parseInt(o.quantity) || 1);
                
                // Revenue (totalPrice from order)
                const orderPrice = parseFloat(o.totalPrice || o.total || o.amount || 0);
                dailyData[dateKey].price += orderPrice;
                
                // Cost (agent price from bundle)
                if (bundleInfo) {
                    dailyData[dateKey].cost += bundleInfo.agent * (parseInt(o.quantity) || 1);
                } else {
                    dailyData[dateKey].cost += orderPrice * 0.95;
                }
            });
            
            // Sort by date descending
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(b) - new Date(a));
            
            if (sortedDates.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = sortedDates.map(dateKey => {
                const data = dailyData[dateKey];
                const profit = data.price - data.cost;
                const profitClass = profit >= 0 ? 'profit-positive' : 'profit-negative';
                
                return `
                    <tr>
                        <td>${formatSalesDate(dateKey)}</td>
                        <td>${data.orders}</td>
                        <td>${data.dataGB.toFixed(0)}GB</td>
                        <td>${data.cost.toFixed(2)}</td>
                        <td>${data.price.toFixed(2)}</td>
                        <td class="${profitClass}">${profit.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        async function renderUserReport() {
            const tbody = document.getElementById('userReportBody');
            const emptyState = document.getElementById('userReportEmpty');
            // Update report date
            const now = new Date();
            const dateStr = `${String(now.getUTCMonth() + 1).padStart(2, '0')}/${String(now.getUTCDate()).padStart(2, '0')}/${now.getUTCFullYear()}`;
            document.getElementById('userReportDate').textContent = dateStr;
            try {
                const [usersRes, walletsRes, ordersRes] = await Promise.all([
                    adminFetch('/api/users'),
                    adminFetch('/api/wallet/all'),
                    adminFetch('/api/order-groups/admin/all?limit=1000')
                ]);
                const users = (await usersRes.json()).users || [];
                const wallets = (await walletsRes.json()).wallets || [];
                const orders = (await ordersRes.json()).orders || [];
                const bundles = bundleTariffsData;
                // Create bundle lookup for cost/profit calculation
                const bundleLookup = {};
                bundles.forEach(b => {
                    const key = `${b.network}-${b.name}`;
                    bundleLookup[key] = {
                        agent: parseFloat(b.agent || b.agentPrice || 0),
                        price: parseFloat(b.price || 0),
                        capacity: parseFloat(b.capacity || 0)
                    };
                });
                // Build user data
                const userData = [];
                users.forEach(user => {
                    const userPhone = user.phone;
                    const userName = user.name || user.fullName || 'Unknown';
                    const userId = user.id || user.userId || '';
                    // Get wallet info
                    const wallet = wallets.find(w => w.phone === userPhone || w.userId === userId);
                    const walletBalance = wallet ? parseFloat(wallet.balance || 0) : 0;
                    // Calculate total wallet loads (deposits)
                    let totalDeposits = 0;
                    if (wallet && wallet.transactions) {
                        wallet.transactions.forEach(tx => {
                            if (tx.type === 'credit' || tx.type === 'deposit' || tx.type === 'claim' || tx.type === 'DEPOSIT') {
                                totalDeposits += Math.abs(parseFloat(tx.amount || 0));
                            }
                        });
                    }
                    // Get user orders - match by userId (order.userId) or nested user.id
                    const userOrders = orders.filter(o =>
                        o.userId === userId ||
                        (o.user && o.user.id === userId)
                    );
                    let totalOrdersAmount = 0;
                    let totalDataCapacity = 0;
                    let totalCost = 0;
                    userOrders.forEach(o => {
                        const orderPrice = parseFloat(o.totalPrice || o.total || o.amount || 0);
                        totalOrdersAmount += orderPrice;
                        // Get bundle info from order
                        const bundleName = o.bundle?.name || o.bundle || o.packageName || '';
                        const bundleNetwork = o.bundle?.network || o.network || 'MTN';
                        const bundleKey = `${bundleNetwork}-${bundleName}`;
                        const bundleInfo = bundleLookup[bundleKey];
                        // Calculate data capacity from bundle.dataAmount (e.g., "5GB")
                        let dataGB = 0;
                        const dataAmount = o.bundle?.dataAmount || '';
                        if (dataAmount) {
                            const match = dataAmount.match(/(\d+\.?\d*)\s*(GB|MB)?/i);
                            if (match) {
                                dataGB = match[2]?.toUpperCase() === 'MB' ? parseFloat(match[1]) / 1000 : parseFloat(match[1]);
                            }
                        } else if (bundleInfo && bundleInfo.capacity) {
                            dataGB = bundleInfo.capacity;
                        }
                        totalDataCapacity += dataGB * (parseInt(o.quantity) || 1);
                        // Calculate cost
                        if (bundleInfo) {
                            totalCost += bundleInfo.agent;
                        } else {
                            totalCost += orderPrice * 0.95;
                        }
                    });
                    const profit = totalOrdersAmount - totalCost;
                    userData.push({
                        name: userName,
                        id: userId,
                        walletLoads: totalDeposits,
                        walletBalance: walletBalance,
                        totalOrders: totalOrdersAmount,
                        dataCapacity: totalDataCapacity,
                        profit: profit
                    });
                });
                // Sort by total orders descending
                userData.sort((a, b) => b.totalOrders - a.totalOrders);
                if (userData.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }
                emptyState.style.display = 'none';
                
                // Calculate grand totals
                const grandTotals = userData.reduce((acc, user) => {
                    acc.walletLoads += user.walletLoads;
                    acc.totalOrders += user.totalOrders;
                    acc.dataCapacity += user.dataCapacity;
                    acc.profit += user.profit;
                    return acc;
                }, { walletLoads: 0, totalOrders: 0, dataCapacity: 0, profit: 0 });
                
                tbody.innerHTML = userData.map(user => {
                    const walletClass = user.walletLoads < 0 ? 'wallet-negative' : 'wallet-positive';
                    return `
                        <tr>
                            <td class="user-name">${user.name.toUpperCase()} (${user.id.slice(-8)})</td>
                            <td class="${walletClass}">${user.walletLoads.toFixed(2)}</td>
                            <td>${user.totalOrders.toFixed(2)}</td>
                            <td>${user.dataCapacity.toFixed(0)} GB</td>
                            <td>${user.profit.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('') + `
                    <tr style="font-weight: bold; background: #f0f0f0; border-top: 2px solid #024959;">
                        <td>GRAND TOTAL</td>
                        <td>${grandTotals.walletLoads.toFixed(2)}</td>
                        <td>${grandTotals.totalOrders.toFixed(2)}</td>
                        <td>${grandTotals.dataCapacity.toFixed(0)} GB</td>
                        <td style="color: ${grandTotals.profit >= 0 ? '#10b981' : '#ef4444'}">${grandTotals.profit.toFixed(2)}</td>
                    </tr>
                `;
            } catch (err) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                console.error('Error rendering user report:', err);
            }
        }
        
        async function exportUserReport() {
            let csvContent = "Agent,Wallet Loads,Total Orders (GHS),Data Capacity,Profit (GHS)\n";
            try {
                const [usersRes, walletsRes, ordersRes] = await Promise.all([
                    adminFetch('/api/users'),
                    adminFetch('/api/wallet/all'),
                    adminFetch('/api/order-groups/admin/all?limit=1000')
                ]);
                const users = (await usersRes.json()).users || [];
                const wallets = (await walletsRes.json()).wallets || [];
                const orders = (await ordersRes.json()).orders || [];
                users.forEach(user => {
                    const userPhone = user.phone;
                    const userName = user.name || user.fullName || 'Unknown';
                    const userId = user.id || user.userId || '';
                    const wallet = wallets.find(w => w.phone === userPhone || w.userId === userId);
                    let totalDeposits = 0;
                    if (wallet && wallet.transactions) {
                        wallet.transactions.forEach(tx => {
                            if (tx.type === 'credit' || tx.type === 'deposit' || tx.type === 'claim' || tx.type === 'DEPOSIT') {
                                totalDeposits += Math.abs(parseFloat(tx.amount || 0));
                            }
                        });
                    }
                    // Match orders by userId
                    const userOrders = orders.filter(o => o.userId === userId || (o.user && o.user.id === userId));
                    const totalOrdersAmount = userOrders.reduce((sum, o) => sum + parseFloat(o.totalPrice || o.total || o.amount || 0), 0);
                    // Calculate data capacity
                    let totalDataCapacity = 0;
                    userOrders.forEach(o => {
                        const dataAmount = o.bundle?.dataAmount || '';
                        if (dataAmount) {
                            const match = dataAmount.match(/(\d+\.?\d*)/);
                            if (match) totalDataCapacity += parseFloat(match[1]) * (parseInt(o.quantity) || 1);
                        }
                    });
                    csvContent += `"${userName} (${userId.slice(-8)})",${totalDeposits.toFixed(2)},${totalOrdersAmount.toFixed(2)},${totalDataCapacity} GB,${(totalOrdersAmount * 0.05).toFixed(2)}\n`;
                });
            } catch {}
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'user_report.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== XSS PROTECTION UTILITY ==========
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== SETTINGS SECTION ==========
        let adminSettings = {
            adminName: 'Administrator',
            adminEmail: 'admin@kemdataplus.com',
            momoNumbers: ['0555546229'],
            autoApprove: false,
            autoApproveLimit: 50,
            emailNotify: true,
            smsNotify: false,
            maintenance: false,
            apiUrl: '',
            apiKey: ''
        };
        
        // Site Settings Object
        let siteSettings = {
            masterAPI: false,
            easydata_mtnAPI: true,
            easydata_telecelAPI: true,
            easydata_airteltigoAPI: true,
            easyDataAutoSync: false,
            mcbisAPI: false,
            mcbis_mtnAPI: true,
            mcbis_telecelAPI: true,
            mcbis_airteltigoAPI: true,
            mcbisAutoSync: false,
            placeOrders: true,
            loadWallet: false,
            claimWallet: true,
            bulkOrders: true,
            excelImport: false,
            cartOrder: true,
            newRegistration: true,
            websiteUpdate: false
        };
        
        async function loadSettingsSection() {
            // Load settings from API
            try {
                const res = await adminFetch('/api/settings');
                if (res.ok) {
                    const data = await res.json();
                    if (data.adminSettings) {
                        adminSettings = { ...adminSettings, ...data.adminSettings };
                    }
                    if (data.siteSettings) {
                        siteSettings = { ...siteSettings, ...data.siteSettings };
                    }
                }
            } catch (err) {
                console.warn('Failed to load settings from API:', err);
            }
            
            // Populate API fields
            document.getElementById('settingApiUrl').value = adminSettings.apiUrl || window.location.origin;
            document.getElementById('settingApiKey').value = adminSettings.apiKey || '';
            
            // Set all site setting toggles
            Object.keys(siteSettings).forEach(key => {
                // Handle special cases for toggle IDs (mcbisAPI -> toggleMcbisApi, etc.)
                let toggleId;
                if (key === 'mcbisAPI') {
                    toggleId = 'toggleMcbisApi';
                } else if (key === 'mcbisAutoSync') {
                    toggleId = 'toggleMcbisAutoSync';
                } else if (key === 'easyDataAutoSync') {
                    toggleId = 'toggleEasyDataAutoSync';
                } else if (key === 'easydata_mtnAPI') {
                    toggleId = 'toggleEasydataMtnAPI';
                } else if (key === 'easydata_telecelAPI') {
                    toggleId = 'toggleEasydataTelecelAPI';
                } else if (key === 'easydata_airteltigoAPI') {
                    toggleId = 'toggleEasydataAirtelTigoAPI';
                } else if (key === 'mcbis_mtnAPI') {
                    toggleId = 'toggleMcbisMtnAPI';
                } else if (key === 'mcbis_telecelAPI') {
                    toggleId = 'toggleMcbisTelecelAPI';
                } else if (key === 'mcbis_airteltigoAPI') {
                    toggleId = 'toggleMcbisAirtelTigoAPI';
                } else {
                    toggleId = 'toggle' + key.charAt(0).toUpperCase() + key.slice(1);
                }
                setToggleState(toggleId, siteSettings[key]);
            });
            
            // Update status texts
            updateSettingStatusTexts();
            
            // Render MoMo numbers
            renderMomoNumbers();
            
            // Load Mcbis settings
            loadMcbisSettings();
        }
        
        function updateSettingStatusTexts() {
            // EasyDataGH network statuses
            const easydataMtnEl = document.getElementById('easydataMtnApiStatus');
            const easydataTelecelEl = document.getElementById('easydataTelecelApiStatus');
            const easydataAirteltigoEl = document.getElementById('easydataAirteltigoApiStatus');
            const easydataAutoSyncEl = document.getElementById('easyDataAutoSyncStatus');
            if (easydataMtnEl) easydataMtnEl.textContent = siteSettings.easydata_mtnAPI !== false ? 'Push MTN orders to EasyDataGH' : 'MTN orders NOT pushed';
            if (easydataTelecelEl) easydataTelecelEl.textContent = siteSettings.easydata_telecelAPI !== false ? 'Push Telecel orders to EasyDataGH' : 'Telecel orders NOT pushed';
            if (easydataAirteltigoEl) easydataAirteltigoEl.textContent = siteSettings.easydata_airteltigoAPI !== false ? 'Push AirtelTigo orders to EasyDataGH' : 'AirtelTigo orders NOT pushed';
            if (easydataAutoSyncEl) easydataAutoSyncEl.textContent = siteSettings.easyDataAutoSync ? 'Auto-checking order status every 30s' : 'Auto-sync disabled';
            
            // MCBIS network statuses
            const mcbisMtnEl = document.getElementById('mcbisMtnApiStatus');
            const mcbisTelecelEl = document.getElementById('mcbisTelecelApiStatus');
            const mcbisAirteltigoEl = document.getElementById('mcbisAirteltigoApiStatus');
            if (mcbisMtnEl) mcbisMtnEl.textContent = siteSettings.mcbis_mtnAPI !== false ? 'Push MTN orders to MCBIS' : 'MTN orders NOT pushed';
            if (mcbisTelecelEl) mcbisTelecelEl.textContent = siteSettings.mcbis_telecelAPI !== false ? 'Push Telecel orders to MCBIS' : 'Telecel orders NOT pushed';
            if (mcbisAirteltigoEl) mcbisAirteltigoEl.textContent = siteSettings.mcbis_airteltigoAPI !== false ? 'Push AirtelTigo orders to MCBIS' : 'AirtelTigo orders NOT pushed';
            
            // Wallet & Order statuses
            document.getElementById('loadWalletStatus').textContent = siteSettings.loadWallet ? 'Agents can load wallet' : 'Agents CANNOT load wallet';
            document.getElementById('claimWalletStatus').textContent = siteSettings.claimWallet ? 'Agents can claim wallet top-up' : 'Agents CANNOT claim wallet';
            document.getElementById('bulkOrderStatus').textContent = siteSettings.bulkOrders ? 'Agents can use text input to Order' : 'Agents CANNOT use text input';
            document.getElementById('excelImportStatus').textContent = siteSettings.excelImport ? 'Agents can use Excel Import' : 'Agents CANNOT use Excel Import';
            document.getElementById('cartOrderStatus').textContent = siteSettings.cartOrder ? 'Agents can use Cart' : 'Agents CANNOT use Cart';
            
            // Other statuses
            document.getElementById('newRegStatus').textContent = siteSettings.newRegistration ? 'Portal is accepting new Agents' : 'Portal is NOT accepting new Agents';
            document.getElementById('websiteUpdateStatus').textContent = siteSettings.websiteUpdate ? 'Portal is under maintenance' : 'Portal is available for use';
        }
        
        function setToggleState(elementId, state) {
            const el = document.getElementById(elementId);
            if (el) {
                el.classList.toggle('active', state);
            }
        }
        
        async function toggleSiteSetting(setting) {
            siteSettings[setting] = !siteSettings[setting];
            
            // Build toggle ID from setting name (handle special cases)
            let toggleId;
            if (setting === 'mcbisAPI') {
                toggleId = 'toggleMcbisApi';
            } else if (setting === 'mcbisAutoSync') {
                toggleId = 'toggleMcbisAutoSync';
            } else if (setting === 'easyDataAutoSync') {
                toggleId = 'toggleEasyDataAutoSync';
            } else if (setting === 'easydata_mtnAPI') {
                toggleId = 'toggleEasydataMtnAPI';
            } else if (setting === 'easydata_telecelAPI') {
                toggleId = 'toggleEasydataTelecelAPI';
            } else if (setting === 'easydata_airteltigoAPI') {
                toggleId = 'toggleEasydataAirtelTigoAPI';
            } else if (setting === 'mcbis_mtnAPI') {
                toggleId = 'toggleMcbisMtnAPI';
            } else if (setting === 'mcbis_telecelAPI') {
                toggleId = 'toggleMcbisTelecelAPI';
            } else if (setting === 'mcbis_airteltigoAPI') {
                toggleId = 'toggleMcbisAirtelTigoAPI';
            } else {
                toggleId = 'toggle' + setting.charAt(0).toUpperCase() + setting.slice(1);
            }
            setToggleState(toggleId, siteSettings[setting]);
            
            // Update status texts
            updateSettingStatusTexts();
            
            // Auto-save to API
            await saveSettingsToAPI();
            
            showToast(`${setting} ${siteSettings[setting] ? 'enabled' : 'disabled'}`);
        }
        
        function toggleSetting(setting) {
            adminSettings[setting] = !adminSettings[setting];
            
            const toggleMap = {
                autoApprove: 'toggleAutoApprove',
                emailNotify: 'toggleEmailNotify',
                smsNotify: 'toggleSmsNotify',
                maintenance: 'toggleMaintenance'
            };
            
            setToggleState(toggleMap[setting], adminSettings[setting]);
        }
        
        function renderMomoNumbers() {
            const container = document.getElementById('momoNumbersList');
            const numbers = adminSettings.momoNumbers || [];
            
            container.innerHTML = numbers.map((num, idx) => `
                <div class="momo-number-item">
                    <select style="width: 100px;">
                        <option value="MTN" ${num.startsWith('024') || num.startsWith('054') || num.startsWith('055') ? 'selected' : ''}>MTN</option>
                        <option value="Vodafone" ${num.startsWith('020') || num.startsWith('050') ? 'selected' : ''}>Vodafone</option>
                        <option value="AirtelTigo" ${num.startsWith('026') || num.startsWith('027') || num.startsWith('057') ? 'selected' : ''}>AirtelTigo</option>
                    </select>
                    <input type="text" value="${num}" placeholder="Phone number" data-action="update-momo-number" data-idx="${idx}">
                    <button class="remove-btn" data-action="remove-momo-number" data-idx="${idx}"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }
        
        function addMomoNumberField() {
            adminSettings.momoNumbers.push('');
            renderMomoNumbers();
        }
        
        // Event delegation for MoMo number actions
        (function setupMomoEventDelegation() {
            const momoList = document.getElementById('momoNumbersList');
            if (momoList) {
                momoList.addEventListener('input', function(e) {
                    const input = e.target.closest('[data-action="update-momo-number"]');
                    if (input) {
                        const idx = parseInt(input.getAttribute('data-idx'), 10);
                        updateMomoNumber(idx, input.value);
                    }
                });
                momoList.addEventListener('click', function(e) {
                    const btn = e.target.closest('[data-action="remove-momo-number"]');
                    if (btn) {
                        const idx = parseInt(btn.getAttribute('data-idx'), 10);
                        removeMomoNumber(idx);
                    }
                });
            }
        })();
        
        function updateMomoNumber(index, value) {
            adminSettings.momoNumbers[index] = value;
        }
        
        function removeMomoNumber(index) {
            adminSettings.momoNumbers.splice(index, 1);
            renderMomoNumbers();
        }
        
        async function openChangePasswordModal() {
            const newPassword = await showConfirmModal({
                title: 'Change Password',
                message: 'Enter a new password for your account. Minimum 6 characters.',
                type: 'info',
                confirmText: 'Change Password',
                cancelText: 'Cancel',
                showInput: true,
                inputLabel: 'New Password',
                inputPlaceholder: 'Enter new password...',
                inputType: 'password'
            });
            if (newPassword && newPassword.length >= 6) {
                // Password change should be done via API
                showToast('Password change via API not implemented yet');
            } else if (newPassword) {
                showToast('Password must be at least 6 characters', 'error');
            }
        }
        
        // Save settings to API
        async function saveSettingsToAPI() {
            try {
                const res = await adminFetch('/api/settings', {
                    method: 'PUT',
                    body: JSON.stringify({ adminSettings, siteSettings })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    console.error('Settings save error:', data);
                    throw new Error(data.error || 'Failed to save settings');
                }
                
                console.log('Settings saved successfully:', data);
                return true;
            } catch (err) {
                console.error('Failed to save settings to API:', err);
                showToast('Error: ' + err.message, 'error');
                return false;
            }
        }
        
        async function saveAllSettings() {
            // Gather API settings
            adminSettings.apiUrl = document.getElementById('settingApiUrl')?.value || '';
            adminSettings.apiKey = document.getElementById('settingApiKey')?.value || '';
            
            // Gather Mcbis API settings
            adminSettings.mcbisApiUrl = document.getElementById('mcbisApiUrl')?.value || 'https://datahub.mcbissolution.com/api/v1';
            adminSettings.mcbisApiToken = document.getElementById('mcbisApiToken')?.value || '';
            
            // Clean empty MoMo numbers
            adminSettings.momoNumbers = (adminSettings.momoNumbers || []).filter(n => n && n.trim());
            
            // Ensure momoNumbers has at least an empty array
            if (!adminSettings.momoNumbers || adminSettings.momoNumbers.length === 0) {
                adminSettings.momoNumbers = [];
            }
            
            console.log('Saving settings:', { adminSettings, siteSettings });
            
            // Save to API
            const success = await saveSettingsToAPI();
            if (success) {
                showToast('Settings saved successfully!');
            }
        }

        // ========== MCBIS API FUNCTIONS ==========
        async function testMcbisConnection() {
            showToast('Testing Mcbis API connection...', 'info');
            try {
                const res = await adminFetch('/api/datahub/test', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast(` Connected! Balance: GHS ${data.balance}`, 'success');
                    document.getElementById('mcbisBalanceDisplay').style.display = 'block';
                    document.getElementById('mcbisBalanceAmount').textContent = `GHS ${parseFloat(data.balance).toFixed(2)}`;
                } else {
                    // Show detailed error info
                    let errorMsg = data.error || 'Unknown error';
                    if (data.hint) {
                        errorMsg += ` (Hint: ${data.hint})`;
                    }
                    showToast(` Connection failed: ${errorMsg}`, 'error');
                    console.error('Mcbis API Test Failed:', data);
                    
                    // Show preview if available
                    if (data.responsePreview) {
                        console.log('API Response Preview:', data.responsePreview);
                    }
                }
            } catch (err) {
                showToast(' Connection error: ' + err.message, 'error');
            }
        }

        async function checkMcbisBalance() {
            try {
                const res = await adminFetch('/api/datahub/balance');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('mcbisBalanceDisplay').style.display = 'block';
                    document.getElementById('mcbisBalanceAmount').textContent = `GHS ${parseFloat(data.balance).toFixed(2)}`;
                    showToast(`API Balance: GHS ${data.balance}`, 'success');
                } else {
                    showToast('Failed to get balance: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                showToast('Error checking balance: ' + err.message, 'error');
            }
        }

        async function syncAllMcbisOrders() {
            showToast('Syncing all pending orders...', 'info');
            try {
                const res = await adminFetch('/api/datahub/sync-all', { method: 'POST' });
                const data = await res.json();
                
                showToast(`Synced ${data.synced || 0} orders`, 'success');
                
                // Refresh orders table
                await loadStats();
            } catch (err) {
                showToast('Sync error: ' + err.message, 'error');
            }
        }

        // ========== EASYDATA API FUNCTIONS ==========
        async function testEasyDataConnection() {
            showToast('Testing EasyDataGH API connection...', 'info');
            try {
                const res = await adminFetch('/api/easydata/test', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast(` Connected! Balance: GHS ${data.balance}`, 'success');
                    document.getElementById('easyDataBalanceDisplay').style.display = 'block';
                    document.getElementById('easyDataBalanceAmount').textContent = `GHS ${parseFloat(data.balance).toFixed(2)}`;
                } else {
                    showToast(` Connection failed: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (err) {
                showToast(' Connection error: ' + err.message, 'error');
            }
        }

        async function checkEasyDataBalance() {
            try {
                const res = await adminFetch('/api/easydata/balance');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('easyDataBalanceDisplay').style.display = 'block';
                    document.getElementById('easyDataBalanceAmount').textContent = `GHS ${parseFloat(data.balance).toFixed(2)}`;
                    showToast(`EasyDataGH Balance: GHS ${data.balance}`, 'success');
                } else {
                    showToast('Failed to get balance: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                showToast('Error checking balance: ' + err.message, 'error');
            }
        }

        async function processMcbisOrder(orderId) {
            const confirmed = await showConfirmModal({
                title: 'Process via MCBIS',
                message: 'Send this order to the MCBIS API for processing?',
                type: 'info',
                confirmText: 'Process Order',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            
            showToast('Processing order...', 'info');
            try {
                const res = await adminFetch(`/api/datahub/process/${orderId}`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast(` Order sent! Ref: ${data.apiReference}`, 'success');
                    await loadStats();
                } else {
                    showToast(` Failed: ${data.error || data.message}`, 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            }
        }

        // Load Mcbis settings on page load
        function loadMcbisSettings() {
            if (adminSettings.mcbisApiUrl) {
                document.getElementById('mcbisApiUrl').value = adminSettings.mcbisApiUrl;
            }
            if (adminSettings.mcbisApiToken) {
                document.getElementById('mcbisApiToken').value = adminSettings.mcbisApiToken;
            }
            // Update toggle states
            const mcbisToggle = document.getElementById('toggleMcbisApi');
            const syncToggle = document.getElementById('toggleMcbisAutoSync');
            if (mcbisToggle && siteSettings.mcbisAPI) {
                mcbisToggle.classList.add('active');
            }
            if (syncToggle && siteSettings.mcbisAutoSync) {
                syncToggle.classList.add('active');
            }
        }

        // Logout
        async function logout() {
            try {
                // Call server to clear httpOnly cookie
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (err) {
                console.error('Logout API error:', err);
            }
            window.location.href = '../pages/login.html';
        }

        // History filter event listeners
        document.getElementById('historySearchInput')?.addEventListener('input', filterHistory);
        document.getElementById('historyNetworkFilter')?.addEventListener('change', filterHistory);
        document.getElementById('historyStatusFilter')?.addEventListener('change', filterHistory);

        // Update filter pending counts
        function updateFilterCounts() {
            // This function updates the network filter button counts
            // Already handled in loadStats() - this is a placeholder for any additional filter counting
        }

        // ========== EVENT DELEGATION FOR ACTION BUTTONS ==========
        // Order actions event delegation
        document.getElementById('ordersTableBody')?.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const id = btn.getAttribute('data-id');
            if (action === 'cancel-order') cancelOrder(id);
            else if (action === 'complete-order') completeOrder(id);
            else if (action === 'view-order') viewOrder(id);
        });

        // Users table actions event delegation
        document.getElementById('usersTableBody')?.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const id = btn.getAttribute('data-id');
            if (action === 'view-user') viewUser(id);
            else if (action === 'edit-user') editUser(id);
            else if (action === 'change-role') openChangeRoleModal(id);
            else if (action === 'quick-fund') quickFundUser(id);
            else if (action === 'delete-user') deleteUser(id);
        });

        // Bundle tariffs table actions event delegation
        document.getElementById('bundleTariffsBody')?.addEventListener('click', function(e) {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;
            const action = btn.getAttribute('data-action');
            const id = btn.getAttribute('data-id');
            if (action === 'toggle-bundle-status') toggleBundleStatus(id);
            else if (action === 'edit-bundle-tariff') editBundleTariff(id);
            else if (action === 'delete-bundle-tariff') deleteBundleTariff(id);
            else if (action === 'show-toast') {
                const msg = btn.getAttribute('data-message');
                const type = btn.getAttribute('data-type') || 'error';
                showToast(msg, type);
            }
        });

        // Network filter buttons click handler - COPY PENDING ORDERS AND MARK AS PROCESSING
        document.querySelectorAll('.network-filter-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const network = this.dataset.network;
                document.querySelectorAll('.network-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Copy pending orders for this network
                const pendingOrders = ordersCache.filter(o => {
                    if ((o.status || '').toLowerCase() !== 'pending') return false;
                    const net = (o.bundle?.network || o.network || '').toUpperCase();
                    if (network === 'MTN') return net.includes('MTN');
                    if (network === 'Telecel') return net.includes('TELECEL');
                    if (network === 'AirtelTigo') return net.includes('AIRTELTIGO') || net.includes('AIRTEL');
                    return false;
                });
                
                if (pendingOrders.length === 0) {
                    showToast(`No pending ${network} orders to copy`, 'error');
                    return;
                }
                
                // Format: phone number and bundle (without GB suffix)
                const copyText = pendingOrders.map(o => {
                    const phone = o.recipientPhone || o.recipient || '';
                    let bundle = o.bundle?.dataAmount || o.bundle?.name || o.quantity || '';
                    // Remove GB suffix for cleaner copy
                    bundle = String(bundle).replace(/\s*GB$/i, '').trim();
                    return `${phone} ${bundle}`;
                }).join('\n');
                
                try {
                    // Copy to clipboard first
                    await navigator.clipboard.writeText(copyText);
                    showToast(`${pendingOrders.length} ${network} orders copied. Marking as processing...`);
                    
                    // Update all pending orders to PROCESSING status using unified endpoint
                    let successCount = 0;
                    
                    for (const order of pendingOrders) {
                        try {
                            // Use unified endpoint that handles both OrderItem and legacy Order
                            const res = await adminFetch(`/api/order-groups/admin/item/${order.id}/status`, {
                                method: 'PUT',
                                body: JSON.stringify({ status: 'PROCESSING' })
                            });
                            if (res.ok) successCount++;
                        } catch (err) {
                            console.error(`Failed to update order ${order.id}:`, err);
                        }
                    }
                    
                    // Refresh orders list
                    await loadStats();
                    
                    // Show success message
                    showToast(`${successCount}/${pendingOrders.length} orders marked as processing`);
                } catch (err) {
                    showToast('Failed to copy to clipboard', 'error');
                }
            });
        });

        // Logout button handler
        document.getElementById('logoutBtn')?.addEventListener('click', logout);

        // Select all checkbox handler
        document.getElementById('selectAll')?.addEventListener('change', toggleSelectAll);

        // Bulk action buttons
        document.getElementById('bulkCompleteBtn')?.addEventListener('click', bulkComplete);
        document.getElementById('bulkCancelBtn')?.addEventListener('click', bulkCancel);
        document.getElementById('clearFiltersBtn')?.addEventListener('click', clearFilters);

        // Add User button handler
        document.querySelector('.btn-add-user')?.addEventListener('click', openAddUserModal);
        document.getElementById('closeUserModalBtn')?.addEventListener('click', closeUserModal);
        document.getElementById('cancelUserModalBtn')?.addEventListener('click', closeUserModal);
        document.getElementById('cancelUserModalAltBtn')?.addEventListener('click', closeUserModal);
        document.getElementById('saveUserBtn')?.addEventListener('click', saveUser);
        document.getElementById('saveUserAltBtn')?.addEventListener('click', saveUser);
        document.getElementById('closeUserModalAltBtn')?.addEventListener('click', closeUserModal);

        // View User Modal close handlers
        document.getElementById('closeViewUserModalBtn')?.addEventListener('click', closeViewUserModal);
        document.getElementById('closeViewUserModalBtn2')?.addEventListener('click', closeViewUserModal);
        document.getElementById('editUserFromViewBtn')?.addEventListener('click', editUserFromView);
        // Alternative View User Modal handlers
        document.getElementById('closeViewUserModalAltBtn')?.addEventListener('click', closeViewUserModalAlt);
        document.getElementById('closeViewUserModalAltBtn2')?.addEventListener('click', closeViewUserModalAlt);
        document.getElementById('editUserFromViewAltBtn')?.addEventListener('click', editUserFromView);

        // Change Role Modal handlers
        document.getElementById('closeChangeRoleModalBtn')?.addEventListener('click', closeChangeRoleModal);
        document.getElementById('cancelChangeRoleModalBtn')?.addEventListener('click', closeChangeRoleModal);
        document.getElementById('saveUserRoleBtn')?.addEventListener('click', saveUserRole);

        // Network Modal handlers
        document.getElementById('closeNetworkModalBtn')?.addEventListener('click', closeNetworkModal);
        document.getElementById('cancelNetworkModalBtn')?.addEventListener('click', closeNetworkModal);
        document.querySelector('.btn-new-network')?.addEventListener('click', openAddNetworkModal);
        document.getElementById('networkForm')?.addEventListener('submit', saveNetwork);
        document.getElementById('syncBundlesToFrontendBtn')?.addEventListener('click', function() {
            syncBundlesToFrontend();
            showToast('Bundles synced to frontend!', 'success');
        });

        // Bundle Modal handlers
        document.getElementById('closeBundleModalBtn')?.addEventListener('click', closeBundleModal);
        document.getElementById('closeBundleModalAddBtn')?.addEventListener('click', closeBundleModalAdd);
        document.querySelector('.btn-new-bundle')?.addEventListener('click', openAddBundleModal);
        document.getElementById('saveBundleBtn')?.addEventListener('click', saveBundle);
        document.getElementById('saveBundleModalBtn')?.addEventListener('click', saveBundleAdd);
        document.getElementById('saveBundleModalEditBtn')?.addEventListener('click', saveBundle);
        document.getElementById('cancelBundleModalBtn')?.addEventListener('click', closeBundleModalAdd);
        document.getElementById('cancelBundleModalEditBtn')?.addEventListener('click', closeBundleModal);
        document.getElementById('bundleForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            saveBundle();
        });
        
        // Bundle network filter change handler
        document.getElementById('bundleNetworkFilter')?.addEventListener('change', filterBundleTariffs);

        // Add Payment Modal handlers
        document.getElementById('closeAddPaymentModalBtn')?.addEventListener('click', closeAddPaymentModal);
        document.getElementById('cancelAddPaymentModalBtn')?.addEventListener('click', closeAddPaymentModal);
        document.querySelector('.btn-add-payment')?.addEventListener('click', openAddPaymentModal);
        document.getElementById('savePaymentBtn')?.addEventListener('click', addIncomingPayment);
        document.getElementById('addIncomingPaymentBtn')?.addEventListener('click', addIncomingPayment);

        // Settings button handler
        document.querySelector('.btn-save-settings')?.addEventListener('click', saveAllSettings);
        document.querySelector('.btn-add-momo')?.addEventListener('click', addMomoNumberField);

        // Toggle switch handlers for site settings
        document.querySelectorAll('.toggle-switch[data-site-setting]').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const setting = this.getAttribute('data-site-setting');
                if (setting) {
                    toggleSiteSetting(setting);
                }
            });
        });

        // Report tab handlers
        document.querySelectorAll('.report-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.textContent.toLowerCase().includes('sales') ? 'sales' : 'users';
                switchReportTab(tabName);
            });
        });

        // Report period buttons
        document.querySelectorAll('.report-period-filter button').forEach(btn => {
            btn.addEventListener('click', function() {
                const period = this.textContent.toLowerCase();
                if (period.includes('today')) setReportPeriod('today');
                else if (period.includes('week')) setReportPeriod('week');
                else if (period.includes('month')) setReportPeriod('month');
                else if (period.includes('year')) setReportPeriod('year');
                else setReportPeriod('all');
            });
        });

        // History filter toggle
        document.querySelector('.history-filter-header')?.addEventListener('click', toggleHistoryFilters);
        document.querySelector('.btn-clear-filters')?.addEventListener('click', clearHistoryFilters);
        document.querySelector('.btn-export-history')?.addEventListener('click', exportHistory);
        
        // Per-page selectors
        document.getElementById('historyPerPage')?.addEventListener('change', renderHistoryTable);
        document.getElementById('tablePerPage')?.addEventListener('change', renderIncomingPayments);
        document.getElementById('ordersPerPage')?.addEventListener('change', function() {
            // Re-render orders table with new per page value
            loadOrdersTable(getFilteredOrders());
        });

        // ========== STOREFRONTS MANAGEMENT ==========
        let storefrontsData = { stores: [], orders: [], profits: null };
        let currentStorefrontTab = 'stores';
        let storefrontOrdersPage = 1;

        async function loadStorefrontsSection() {
            await Promise.all([
                loadStorefronts(),
                loadStorefrontOrders(),
                loadStorefrontProfits()
            ]);
            setupStorefrontTabHandlers();
            setupStorefrontEventHandlers();
        }

        async function loadStorefronts() {
            const search = document.getElementById('storeSearchInput')?.value || '';
            const status = document.getElementById('storeStatusFilter')?.value || '';
            
            try {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (status) params.append('status', status);
                
                const res = await adminFetch(`/api/admin/storefronts?${params}`);
                const data = await res.json();
                
                if (res.ok) {
                    storefrontsData.stores = data.storefronts;
                    renderStorefrontsTable();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                console.error('Failed to load storefronts:', err);
                document.getElementById('storefrontsTableBody').innerHTML = 
                    `<tr><td colspan="7" style="padding: 40px; text-align: center; color: #ef4444;">Failed to load stores: ${err.message}</td></tr>`;
            }
        }

        function renderStorefrontsTable() {
            const tbody = document.getElementById('storefrontsTableBody');
            
            if (!storefrontsData.stores || storefrontsData.stores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #6b7280;">No storefronts found</td></tr>';
                return;
            }
            
            tbody.innerHTML = storefrontsData.stores.map(store => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600; color: #1f2937;">${store.name}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">/${store.slug}</div>
                    </td>
                    <td style="padding: 15px;">
                        <div style="font-weight: 500;">${store.owner?.name || 'Unknown'}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">${store.owner?.role || ''}</div>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span style="font-weight: 600;">${store.totalOrders}</span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span style="font-weight: 600; color: #10b981;">GH ${(store.totalRevenue || 0).toFixed(2)}</span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${store.paystackEnabled 
                            ? '<span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">Enabled</span>'
                            : '<span style="background: #e5e7eb; color: #6b7280; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;">Disabled</span>'}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        ${getStatusBadge(store.status)}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="viewStorefrontDetails('${store.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 5px;" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="toggleStorefrontStatus('${store.id}', '${store.status}')" style="background: ${store.status === 'ACTIVE' ? '#ef4444' : '#10b981'}; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer;" title="${store.status === 'ACTIVE' ? 'Suspend' : 'Activate'}">
                            <i class="fas fa-${store.status === 'ACTIVE' ? 'ban' : 'check'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const styles = {
                'ACTIVE': 'background: #d1fae5; color: #065f46;',
                'SUSPENDED': 'background: #fee2e2; color: #991b1b;',
                'INACTIVE': 'background: #e5e7eb; color: #374151;'
            };
            return `<span style="${styles[status] || styles.INACTIVE} padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${status}</span>`;
        }

        async function loadStorefrontOrders(page = 1) {
            storefrontOrdersPage = page;
            const search = document.getElementById('orderSearchInput')?.value || '';
            const paymentMethod = document.getElementById('orderPaymentMethodFilter')?.value || '';
            const profitStatus = document.getElementById('orderProfitStatusFilter')?.value || '';
            const dateFrom = document.getElementById('orderDateFrom')?.value || '';
            const dateTo = document.getElementById('orderDateTo')?.value || '';
            
            try {
                const params = new URLSearchParams({ page, limit: 50 });
                if (search) params.append('search', search);
                if (paymentMethod) params.append('paymentMethod', paymentMethod);
                if (profitStatus) params.append('profitStatus', profitStatus);
                if (dateFrom) params.append('dateFrom', dateFrom);
                if (dateTo) params.append('dateTo', dateTo);
                
                const res = await adminFetch(`/api/admin/storefront-orders?${params}`);
                const data = await res.json();
                
                if (res.ok) {
                    storefrontsData.orders = data.orders;
                    renderStorefrontOrdersTable();
                    renderOrdersPagination(data.pagination);
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                console.error('Failed to load storefront orders:', err);
                document.getElementById('storefrontOrdersTableBody').innerHTML = 
                    `<tr><td colspan="9" style="padding: 40px; text-align: center; color: #ef4444;">Failed to load orders: ${err.message}</td></tr>`;
            }
        }

        function renderStorefrontOrdersTable() {
            const tbody = document.getElementById('storefrontOrdersTableBody');
            
            if (!storefrontsData.orders || storefrontsData.orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="padding: 40px; text-align: center; color: #6b7280;">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = storefrontsData.orders.map(order => `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 12px; font-size: 0.85rem;">
                        <span style="font-family: monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${order.id.slice(0, 8)}</span>
                    </td>
                    <td style="padding: 12px; font-size: 0.85rem;">
                        ${order.storefront?.name || 'Unknown'}
                    </td>
                    <td style="padding: 12px; font-size: 0.85rem;">
                        <div>${order.customerPhone}</div>
                        ${order.customerName ? `<div style="font-size: 0.75rem; color: #6b7280;">${order.customerName}</div>` : ''}
                    </td>
                    <td style="padding: 12px; font-size: 0.85rem;">
                        ${order.bundle?.name || 'N/A'}
                    </td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">
                        GH ${(order.amount || 0).toFixed(2)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${order.paymentMethod === 'PAYSTACK' 
                            ? '<span style="background: #dbeafe; color: #1e40af; padding: 3px 8px; border-radius: 8px; font-size: 0.7rem;">PAYSTACK</span>'
                            : '<span style="background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 8px; font-size: 0.7rem;">MOMO</span>'}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${getOrderStatusBadge(order.status)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${order.profitCredited 
                            ? '<span style="background: #d1fae5; color: #065f46; padding: 3px 8px; border-radius: 8px; font-size: 0.7rem;"><i class="fas fa-check"></i> Credited</span>'
                            : '<span style="background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 8px; font-size: 0.7rem;"><i class="fas fa-clock"></i> Pending</span>'}
                    </td>
                    <td style="padding: 12px; font-size: 0.75rem; color: #6b7280;">
                        ${new Date(order.createdAt).toLocaleString()}
                    </td>
                </tr>
            `).join('');
        }

        function getOrderStatusBadge(status) {
            const styles = {
                'COMPLETED': 'background: #d1fae5; color: #065f46;',
                'PROCESSING': 'background: #dbeafe; color: #1e40af;',
                'PENDING': 'background: #fef3c7; color: #92400e;',
                'FAILED': 'background: #fee2e2; color: #991b1b;',
                'CANCELLED': 'background: #e5e7eb; color: #374151;'
            };
            return `<span style="${styles[status] || styles.PENDING} padding: 3px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 600;">${status}</span>`;
        }

        function renderOrdersPagination(pagination) {
            const container = document.getElementById('ordersPagination');
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            for (let i = 1; i <= pagination.pages; i++) {
                html += `<button onclick="loadStorefrontOrders(${i})" style="padding: 8px 14px; border: 1px solid ${i === pagination.page ? '#3b82f6' : '#e5e7eb'}; background: ${i === pagination.page ? '#3b82f6' : 'white'}; color: ${i === pagination.page ? 'white' : '#374151'}; border-radius: 6px; cursor: pointer;">${i}</button>`;
            }
            container.innerHTML = html;
        }

        async function loadStorefrontProfits() {
            try {
                const res = await adminFetch('/api/admin/storefront-profits');
                const data = await res.json();
                
                if (res.ok) {
                    storefrontsData.profits = data;
                    updateProfitDashboard();
                    renderUncreditedTable();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                console.error('Failed to load profits:', err);
            }
        }

        function updateProfitDashboard() {
            const profits = storefrontsData.profits;
            if (!profits) return;
            
            document.getElementById('todayAgentProfits').textContent = `GH ${(profits.summary.today.agentProfits || 0).toFixed(2)}`;
            document.getElementById('todayPlatformProfits').textContent = `GH ${(profits.summary.today.platformProfits || 0).toFixed(2)}`;
            document.getElementById('uncreditedProfits').textContent = `GH ${(profits.uncredited.totalAgentProfit || 0).toFixed(2)}`;
            document.getElementById('uncreditedCount').textContent = `${profits.uncredited.count} orders pending`;
            document.getElementById('totalAgentProfits').textContent = `GH ${(profits.summary.allTime.agentProfits || 0).toFixed(2)}`;
            document.getElementById('uncreditedBadge').textContent = profits.uncredited.count;
        }

        function renderUncreditedTable() {
            const tbody = document.getElementById('uncreditedTableBody');
            const orders = storefrontsData.profits?.uncredited?.orders || [];
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: #10b981;"><i class="fas fa-check-circle"></i> All profits have been credited!</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr style="border-bottom: 1px solid #fcd34d;">
                    <td style="padding: 12px;">${order.storefront || 'Unknown'}</td>
                    <td style="padding: 12px;">${order.agent || 'Unknown'}</td>
                    <td style="padding: 12px;">${order.bundle || 'N/A'}</td>
                    <td style="padding: 12px; text-align: right;">GH ${(order.amount || 0).toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">GH ${(order.agentProfit || 0).toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; color: #3b82f6;">GH ${(order.platformProfit || 0).toFixed(2)}</td>
                    <td style="padding: 12px; font-size: 0.8rem;">${order.completedAt ? new Date(order.completedAt).toLocaleString() : 'N/A'}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button onclick="creditSingleOrder('${order.id}')" style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            <i class="fas fa-wallet"></i> Credit
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function setupStorefrontTabHandlers() {
            document.querySelectorAll('.storefront-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchStorefrontTab(tabName);
                });
            });
        }

        function switchStorefrontTab(tabName) {
            currentStorefrontTab = tabName;
            
            // Update tab styles
            document.querySelectorAll('.storefront-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.style.background = '#024959';
                    tab.style.color = 'white';
                } else {
                    tab.style.background = '#e5e7eb';
                    tab.style.color = '#374151';
                }
            });
            
            // Show/hide content
            document.getElementById('storesTabContent').style.display = tabName === 'stores' ? 'block' : 'none';
            document.getElementById('ordersTabContent').style.display = tabName === 'orders' ? 'block' : 'none';
            document.getElementById('uncreditedTabContent').style.display = tabName === 'uncredited' ? 'block' : 'none';
        }

        function setupStorefrontEventHandlers() {
            // Search and filter handlers
            document.getElementById('storeSearchInput')?.addEventListener('input', debounce(loadStorefronts, 300));
            document.getElementById('storeStatusFilter')?.addEventListener('change', loadStorefronts);
            document.getElementById('orderSearchInput')?.addEventListener('input', debounce(() => loadStorefrontOrders(1), 300));
            document.getElementById('orderPaymentMethodFilter')?.addEventListener('change', () => loadStorefrontOrders(1));
            document.getElementById('orderProfitStatusFilter')?.addEventListener('change', () => loadStorefrontOrders(1));
            document.getElementById('orderDateFrom')?.addEventListener('change', () => loadStorefrontOrders(1));
            document.getElementById('orderDateTo')?.addEventListener('change', () => loadStorefrontOrders(1));
            
            // Retry button
            document.getElementById('retryUncreditedBtn')?.addEventListener('click', retryUncreditedProfits);
            document.getElementById('refreshProfitsBtn')?.addEventListener('click', loadStorefrontProfits);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function clearOrderDateFilters() {
            document.getElementById('orderDateFrom').value = '';
            document.getElementById('orderDateTo').value = '';
            loadStorefrontOrders(1);
        }

        async function retryUncreditedProfits() {
            const btn = document.getElementById('retryUncreditedBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            try {
                const res = await adminFetch('/api/admin/storefront-profits/retry', { method: 'POST' });
                const data = await res.json();
                
                if (res.ok) {
                    showToast(`Processed ${data.processed || 0} orders, ${data.succeeded || 0} succeeded`, 'success');
                    await loadStorefrontProfits();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                showToast('Failed to retry: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-redo"></i> Retry Uncredited Profits';
            }
        }

        async function creditSingleOrder(storefrontOrderId) {
            // Find the main orderId from the storefront order
            const order = storefrontsData.profits?.uncredited?.orders?.find(o => o.id === storefrontOrderId);
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }
            
            try {
                // We need to get the main order ID - let's use a different approach
                const res = await adminFetch(`/api/admin/storefront-orders/${storefrontOrderId}`);
                const orderData = await res.json();
                
                if (!res.ok || !orderData.orderId) {
                    throw new Error('Cannot find main order ID');
                }
                
                const creditRes = await adminFetch(`/api/admin/storefront-profits/credit/${orderData.orderId}`, { method: 'POST' });
                const data = await creditRes.json();
                
                if (creditRes.ok) {
                    showToast(`Profit credited: GH ${data.amount?.toFixed(2) || '0.00'}`, 'success');
                    await loadStorefrontProfits();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                showToast('Failed to credit: ' + err.message, 'error');
            }
        }

        async function viewStorefrontDetails(storeId) {
            try {
                const res = await adminFetch(`/api/admin/storefronts/${storeId}`);
                const store = await res.json();
                
                if (!res.ok) throw new Error(store.error);
                
                const modalHtml = `
                    <div class="user-modal active" id="storefrontDetailModal" style="display: flex;">
                        <div class="user-modal-content" style="max-width: 600px;">
                            <div class="user-modal-header" style="background: #024959;">
                                <h3><i class="fas fa-store"></i> ${store.name}</h3>
                                <button class="modal-close" onclick="document.getElementById('storefrontDetailModal').remove()">&times;</button>
                            </div>
                            <div class="user-modal-body" style="padding: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <strong>Slug:</strong> /${store.slug}
                                    </div>
                                    <div>
                                        <strong>Status:</strong> ${getStatusBadge(store.status)}
                                    </div>
                                    <div>
                                        <strong>Owner:</strong> ${store.owner?.name} (${store.owner?.role})
                                    </div>
                                    <div>
                                        <strong>Contact:</strong> ${store.owner?.phone || 'N/A'}
                                    </div>
                                    <div>
                                        <strong>Total Orders:</strong> ${store.customerOrders?.length || 0}
                                    </div>
                                    <div>
                                        <strong>Total Revenue:</strong> GH ${(store.totalRevenue || 0).toFixed(2)}
                                    </div>
                                    <div>
                                        <strong>Paystack:</strong> ${store.paystackEnabled ? 'Enabled' : 'Disabled'}
                                    </div>
                                    <div>
                                        <strong>Products:</strong> ${store.products?.length || 0}
                                    </div>
                                </div>
                                <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                                <h4 style="margin-bottom: 10px;">Owner Wallet</h4>
                                <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                                    <strong>Balance:</strong> GH ${(store.owner?.wallet?.balance || 0).toFixed(2)}
                                    ${store.owner?.wallet?.isFrozen ? '<span style="color: #ef4444; margin-left: 10px;"><i class="fas fa-snowflake"></i> FROZEN</span>' : ''}
                                </div>
                                <div style="text-align: right; margin-top: 20px;">
                                    <a href="/store/${store.slug}" target="_blank" style="background: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;">
                                        <i class="fas fa-external-link-alt"></i> Visit Store
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (err) {
                showToast('Failed to load store details: ' + err.message, 'error');
            }
        }

        async function toggleStorefrontStatus(storeId, currentStatus) {
            const newStatus = currentStatus === 'ACTIVE' ? 'SUSPENDED' : 'ACTIVE';
            const action = newStatus === 'SUSPENDED' ? 'suspend' : 'activate';
            
            if (!confirm(`Are you sure you want to ${action} this storefront?`)) return;
            
            let reason = '';
            if (newStatus === 'SUSPENDED') {
                reason = prompt('Enter reason for suspension (optional):') || 'Suspended by admin';
            }
            
            try {
                const res = await adminFetch(`/api/admin/storefronts/${storeId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: newStatus, reason })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(`Storefront ${action}d successfully`, 'success');
                    await loadStorefronts();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                showToast(`Failed to ${action} storefront: ` + err.message, 'error');
            }
        }

        // Initialize
        updateGreeting();
        loadStats();
        initUsersData();
        initFilterListeners();
        updateFilterCounts();
        
        // Restore section from URL hash on page load/refresh
        restoreSectionFromHash();
        
        // Show main content after initialization (prevents flash)
        document.querySelector('.main-content')?.classList.add('ready');
    </script>
    <script src="../public/js/session-timeout.js"></script>
</body>
</html>
