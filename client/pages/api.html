<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>API Documentation - KemDataplus</title>
    <link rel="stylesheet" href="../public/css/dashboard.css">
    <script src="https://kit.fontawesome.com/56c0d51fb9.js" crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; }
        
        .api-container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-4) var(--space-3);
        }
        
        /* Page Header */
        .api-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: var(--space-8);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }
        
        .api-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }
        
        .api-header h1 {
            margin: 0 0 var(--space-2) 0;
            font-size: var(--text-3xl);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .api-header p {
            margin: 0;
            opacity: 0.9;
            font-size: var(--text-base);
        }
        
        /* Sections */
        .api-section {
            background: white;
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-5);
        }
        
        .api-section h2 {
            color: var(--primary);
            margin: 0 0 var(--space-5) 0;
            padding-bottom: var(--space-3);
            border-bottom: 3px solid var(--accent);
            font-size: var(--text-xl);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .api-section h3 {
            color: var(--primary);
            margin: var(--space-6) 0 var(--space-4);
            font-size: var(--text-lg);
        }
        
        .api-section p {
            color: var(--gray-600);
            font-size: var(--text-base);
            line-height: 1.6;
        }
        
        .api-section ul {
            color: var(--gray-600);
            padding-left: var(--space-5);
        }
        
        .api-section li {
            margin-bottom: var(--space-2);
        }
        
        /* Endpoints */
        .endpoint {
            background: var(--gray-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            border-left: 4px solid var(--accent);
        }
        
        .endpoint-method {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: var(--text-xs);
            margin-right: var(--space-3);
            text-transform: uppercase;
        }
        
        .method-get { background: #61affe; color: white; }
        .method-post { background: #49cc90; color: white; }
        .method-put { background: #fca130; color: white; }
        .method-delete { background: #f93e3e; color: white; }
        
        .endpoint-url {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: var(--text-sm);
            color: var(--gray-700);
            font-weight: 500;
        }
        
        .endpoint-description {
            margin-top: var(--space-3);
            color: var(--gray-500);
            font-size: var(--text-sm);
        }
        
        /* Code Blocks */
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: var(--space-4);
            border-radius: var(--radius-md);
            overflow-x: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: var(--text-sm);
            margin: var(--space-4) 0;
            line-height: 1.5;
        }
        
        /* API Key Section */
        .api-key-section {
            background: rgba(242, 193, 46, 0.1);
            padding: var(--space-5);
            border-radius: var(--radius-md);
            border: 2px solid var(--accent);
            margin-bottom: var(--space-5);
        }
        
        .api-key-section p {
            margin: 0 0 var(--space-4) 0;
            color: var(--gray-700);
            font-size: var(--text-sm);
        }
        
        .api-key-display {
            display: flex;
            gap: var(--space-3);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .api-key-input {
            flex: 1;
            min-width: 200px;
            padding: var(--space-3);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: var(--text-sm);
            background: white;
        }
        
        .btn-copy, .btn-generate {
            padding: var(--space-3) var(--space-5);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: var(--text-sm);
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            min-height: 48px;
        }
        
        .btn-copy {
            background: var(--primary);
            color: white;
        }
        
        .btn-copy:hover, .btn-copy:active {
            background: var(--primary-light);
        }
        
        .btn-generate {
            background: var(--accent);
            color: var(--primary);
        }
        
        .btn-generate:hover, .btn-generate:active {
            background: var(--accent-dark);
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-4) 0;
        }
        
        table th, table td {
            padding: var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
            font-size: var(--text-sm);
        }
        
        table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        table tbody tr:hover {
            background: var(--gray-50);
        }
        
        table td:first-child {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            color: var(--danger);
            font-weight: 600;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .api-container { padding: var(--space-8) var(--space-5); }
            .api-section { padding: var(--space-8); }
        }
        
        @media (max-width: 600px) {
            .api-container { padding: var(--space-3) var(--space-2); }
            
            .api-header {
                padding: var(--space-5);
            }
            
            .api-header h1 {
                font-size: var(--text-xl);
            }
            
            .api-section {
                padding: var(--space-4);
            }
            
            .api-section h2 {
                font-size: var(--text-lg);
            }
            
            .api-key-display {
                flex-direction: column;
            }
            
            .api-key-input {
                width: 100%;
                min-width: auto;
            }
            
            .btn-copy, .btn-generate {
                width: 100%;
                justify-content: center;
            }
            
            .code-block {
                font-size: var(--text-xs);
                padding: var(--space-3);
            }
            
            .endpoint-url {
                display: block;
                margin-top: var(--space-2);
                word-break: break-all;
            }
            
            table {
                font-size: var(--text-xs);
            }
            
            table th, table td {
                padding: var(--space-2);
            }
        }
    </style>
</head>
<body>
    <div class="background">
        <!-- HEADER -->
        <div class="header-container">
            <header>
                <div><a href="../public/dashboard.html"><img src="../public/img/kem.png" alt="KemDataplus" class="logo"></a></div>
                <input type="checkbox" id="check-box">
                <div class="nav-links">
                    <label for="check-box" class="menu-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </label>
                    <div class="nav-menu">
                        <div class="links">
                            <a href="../public/dashboard.html">Dashboard</a>
                            <a href="../public/dashboard.html#buy-bundles">Buy Bundles</a>
                            <a href="./orders.html">Orders</a>
                            <a href="./wallet.html">Wallet</a>
                            <a href="./mystore.html">My Store</a>
                            <a href="./api.html" class="active">API</a>
                            <a href="./profile.html">Profile</a>
                            <a href="#" onclick="logout(); return false;" class="mobile-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                    <div class="profile-dropdown">
                        <img src="../public/img/kem.png" alt="Profile" class="profile-pic" id="profileBtn">
                        <div class="dropdown-menu" id="dropdownMenu">
                            <a href="./profile.html"><i class="fas fa-user"></i> My Profile</a>
                            <a href="./profile.html"><i class="fas fa-cog"></i> Settings</a>
                            <a href="./wallet.html"><i class="fas fa-wallet"></i> Wallet</a>
                            <hr>
                            <a href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                    <label for="check-box" class="close-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </label>
                </div>
            </header>
        </div>

        <!-- API CONTENT -->
        <div class="api-container">
            <div class="api-header">
                <h1><i class="fas fa-code"></i> API Documentation</h1>
                <p>Integrate KemDataplus services into your applications</p>
            </div>

            <!-- API KEY SECTION -->
            <div class="api-section">
                <h2><i class="fas fa-key"></i> Your API Key</h2>
                <div class="api-key-section">
                    <p><strong>Important:</strong> Keep your API key secure and never expose it in client-side code.</p>
                    <div class="api-key-display">
                        <input type="text" class="api-key-input" id="apiKey" placeholder="No API key generated yet" readonly>
                        <button class="btn-copy" onclick="copyApiKey()"><i class="fas fa-copy"></i> Copy</button>
                        <button class="btn-generate" onclick="generateNewKey()"><i class="fas fa-sync"></i> Regenerate</button>
                    </div>
                </div>
            </div>

            <!-- AUTHENTICATION -->
            <div class="api-section">
                <h2><i class="fas fa-lock"></i> Authentication</h2>
                <p>All API requests require authentication using your API key in the header:</p>
                <div class="code-block">
Authorization: Bearer YOUR_API_KEY
                </div>

                <h3>Base URL</h3>
                <div class="code-block" id="baseUrlDisplay">
Loading...
                </div>
            </div>

            <!-- ENDPOINTS -->
            <div class="api-section">
                <h2><i class="fas fa-route"></i> Endpoints</h2>

                <h3>Bundles</h3>
                <div class="endpoint">
                    <span class="endpoint-method method-get">GET</span>
                    <span class="endpoint-url">/bundles</span>
                    <p class="endpoint-description">Get all available data bundles</p>
                </div>
                <div class="code-block">
// Response
{
  "success": true,
  "data": [
    {
      "id": "mtn-1gb",
      "network": "MTN",
      "size": "1GB",
      "price": 4.00,
      "validity": "30 days"
    }
  ]
}
                </div>

                <h3>Place Order</h3>
                <div class="endpoint">
                    <span class="endpoint-method method-post">POST</span>
                    <span class="endpoint-url">/orders</span>
                    <p class="endpoint-description">Create a new bundle order</p>
                </div>
                <div class="code-block">
// Request Body
{
  "phone": "0241234567",
  "bundle_id": "mtn-1gb",
  "quantity": 1
}

// Response
{
  "success": true,
  "data": {
    "order_id": "ORD-ABC12345",
    "status": "processing",
    "amount": 4.00
  }
}
                </div>

                <h3>Check Order Status</h3>
                <div class="endpoint">
                    <span class="endpoint-method method-get">GET</span>
                    <span class="endpoint-url">/orders/{order_id}</span>
                    <p class="endpoint-description">Get order status and details</p>
                </div>

                <h3>Wallet Balance</h3>
                <div class="endpoint">
                    <span class="endpoint-method method-get">GET</span>
                    <span class="endpoint-url">/wallet/balance</span>
                    <p class="endpoint-description">Get your current wallet balance</p>
                </div>

                <h3>Transaction History</h3>
                <div class="endpoint">
                    <span class="endpoint-method method-get">GET</span>
                    <span class="endpoint-url">/wallet/transactions</span>
                    <p class="endpoint-description">Get transaction history</p>
                </div>
            </div>

            <!-- ERROR CODES -->
            <div class="api-section">
                <h2><i class="fas fa-exclamation-triangle"></i> Error Codes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>400</td>
                            <td>Bad Request - Invalid parameters</td>
                        </tr>
                        <tr>
                            <td>401</td>
                            <td>Unauthorized - Invalid API key</td>
                        </tr>
                        <tr>
                            <td>402</td>
                            <td>Insufficient Balance</td>
                        </tr>
                        <tr>
                            <td>404</td>
                            <td>Not Found - Resource doesn't exist</td>
                        </tr>
                        <tr>
                            <td>429</td>
                            <td>Rate Limited - Too many requests</td>
                        </tr>
                        <tr>
                            <td>500</td>
                            <td>Server Error</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- RATE LIMITS -->
            <div class="api-section">
                <h2><i class="fas fa-tachometer-alt"></i> Rate Limits</h2>
                <p>API requests are limited to:</p>
                <ul>
                    <li><strong>100 requests</strong> per minute</li>
                    <li><strong>5,000 requests</strong> per day</li>
                </ul>
                <p>Rate limit headers are included in all responses:</p>
                <div class="code-block">
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1609459200
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auth check - redirect to login if not authenticated
        async function checkAuth() {
            try {
                const res = await fetch('/api/users/me', { credentials: 'include' });
                return res.ok;
            } catch (e) {
                return false;
            }
        }
        
        // Initialize page
        (async function() {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                window.location.href = './login.html';
                return;
            }
            
            // Set dynamic base URL
            const baseUrlDisplay = document.getElementById('baseUrlDisplay');
            if (baseUrlDisplay) {
                baseUrlDisplay.textContent = window.location.origin + '/api/v1';
            }
            
            // Load API key from user profile
            try {
                const res = await fetch('/api/users/me', { credentials: 'include' });
                if (res.ok) {
                    const user = await res.json();
                    if (user.apiKey) {
                        document.getElementById('apiKey').value = user.apiKey;
                    }
                }
            } catch (e) {
                console.warn('Could not load API key from profile');
            }
        })();
        
        // Profile dropdown toggle
        document.getElementById('profileBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = document.getElementById('dropdownMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.getElementById('dropdownMenu').style.display = 'none';
        });

        function copyApiKey() {
            const apiKeyInput = document.getElementById('apiKey');
            if (!apiKeyInput.value || apiKeyInput.value.includes('No API key')) {
                showToast('No API key to copy. Generate one first.', 'error');
                return;
            }
            apiKeyInput.select();
            apiKeyInput.setSelectionRange(0, 99999); // For mobile
            navigator.clipboard.writeText(apiKeyInput.value).then(function() {
                showToast('API Key copied to clipboard!', 'success');
            }).catch(function() {
                // Fallback for older browsers
                document.execCommand('copy');
                showToast('API Key copied to clipboard!', 'success');
            });
        }

        async function generateNewKey() {
            const confirmed = await showConfirmModal({
                title: 'Regenerate API Key',
                message: 'Are you sure you want to regenerate your API key? This will invalidate your current key and any applications using it will stop working.',
                type: 'warning',
                confirmText: 'Generate New Key',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            
            const newKey = 'kdp_sk_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            document.getElementById('apiKey').value = newKey;
            // TODO: Save to user profile via API
            showToast('New API key generated! Make sure to update your applications.', 'success');
        }
        
        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i> ${message}`;
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white; padding: 14px 24px; border-radius: 10px; z-index: 10000; display: flex; align-items: center; gap: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2); animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideOut 0.3s ease'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        // Professional Confirm Modal
        let confirmModalResolve = null;
        function showConfirmModal(options = {}) {
            return new Promise((resolve) => {
                confirmModalResolve = resolve;
                let modal = document.getElementById('confirmModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'confirmModal';
                    modal.innerHTML = `
                        <div class="confirm-modal">
                            <div class="confirm-modal-header">
                                <div class="confirm-modal-icon ${options.type || 'warning'}">
                                    <i class="fas ${options.type === 'danger' ? 'fa-trash-alt' : options.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                                </div>
                                <h3 class="confirm-modal-title">${options.title || 'Confirm'}</h3>
                            </div>
                            <p class="confirm-modal-message">${options.message || 'Are you sure?'}</p>
                            <div class="confirm-modal-footer">
                                <button class="confirm-modal-btn cancel" onclick="closeConfirmModal(false)"><i class="fas fa-times"></i> ${options.cancelText || 'Cancel'}</button>
                                <button class="confirm-modal-btn confirm ${options.type || ''}" onclick="closeConfirmModal(true)"><i class="fas fa-check"></i> ${options.confirmText || 'Confirm'}</button>
                            </div>
                        </div>
                    `;
                    modal.style.cssText = `position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:9999;display:flex;justify-content:center;align-items:center;padding:20px;`;
                    const modalStyles = document.createElement('style');
                    modalStyles.textContent = `.confirm-modal{background:white;border-radius:16px;max-width:420px;width:100%;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);animation:slideUp 0.3s ease}.confirm-modal-header{padding:24px 24px 0;text-align:center}.confirm-modal-icon{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:1.75rem}.confirm-modal-icon.warning{background:#fef3c7;color:#f59e0b}.confirm-modal-icon.danger{background:#fee2e2;color:#ef4444}.confirm-modal-icon.success{background:#d1fae5;color:#10b981}.confirm-modal-title{font-size:1.25rem;font-weight:700;color:#1f2937;margin-bottom:8px}.confirm-modal-message{color:#6b7280;font-size:0.95rem;line-height:1.5;padding:0 24px;text-align:center}.confirm-modal-footer{display:flex;gap:12px;padding:20px 24px 24px}.confirm-modal-btn{flex:1;padding:14px 20px;border:none;border-radius:10px;font-size:0.95rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}.confirm-modal-btn.cancel{background:#f3f4f6;color:#4b5563}.confirm-modal-btn.confirm{background:#3b82f6;color:white}.confirm-modal-btn.confirm.danger{background:#ef4444}.confirm-modal-btn.confirm.warning{background:#f59e0b}@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}`;
                    document.head.appendChild(modalStyles);
                    document.body.appendChild(modal);
                } else {
                    modal.querySelector('.confirm-modal-title').textContent = options.title || 'Confirm';
                    modal.querySelector('.confirm-modal-message').textContent = options.message || 'Are you sure?';
                    modal.querySelector('.confirm-modal-icon').className = `confirm-modal-icon ${options.type || 'warning'}`;
                    modal.querySelector('.confirm-modal-icon i').className = `fas ${options.type === 'danger' ? 'fa-trash-alt' : options.type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}`;
                    modal.querySelector('.confirm-modal-btn.confirm').className = `confirm-modal-btn confirm ${options.type || ''}`;
                    modal.querySelector('.confirm-modal-btn.confirm').innerHTML = `<i class="fas fa-check"></i> ${options.confirmText || 'Confirm'}`;
                    modal.querySelector('.confirm-modal-btn.cancel').innerHTML = `<i class="fas fa-times"></i> ${options.cancelText || 'Cancel'}`;
                    modal.style.display = 'flex';
                }
            });
        }
        function closeConfirmModal(result) {
            const modal = document.getElementById('confirmModal');
            if (modal) modal.style.display = 'none';
            if (confirmModalResolve) { confirmModalResolve(result); confirmModalResolve = null; }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            } catch (e) {}
            localStorage.removeItem('currentUser');
            window.location.href = './login.html';
        }
    </script>
    <script src="../public/js/session-timeout.js"></script>
</body>
</html>