<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>My Store - KemDataplus</title>
    <link rel="stylesheet" href="../public/css/dashboard.css">
    <script src="https://kit.fontawesome.com/56c0d51fb9.js" crossorigin="anonymous"></script>
    <style>
        * { box-sizing: border-box; }
        
        .store-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: var(--space-4) var(--space-3); 
        }
        
        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: var(--space-6) var(--space-5);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-5);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }
        
        .page-header h1 {
            margin: 0 0 var(--space-1) 0;
            font-size: var(--text-2xl);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .page-header p {
            margin: 0;
            opacity: 0.9;
            font-size: var(--text-sm);
        }
        
        /* Store Header */
        .store-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: var(--space-5); 
            flex-wrap: wrap; 
            gap: var(--space-4); 
        }
        
        .store-header h1 { color: var(--primary); font-size: var(--text-2xl); margin: 0; display: flex; align-items: center; gap: var(--space-2); }
        
        /* Buttons */
        .btn { 
            padding: var(--space-3) var(--space-5); 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            border: none; 
            font-size: var(--text-sm); 
            font-weight: 600;
            display: inline-flex; 
            align-items: center; 
            gap: var(--space-2);
            min-height: 48px;
            transition: var(--transition);
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover, .btn-primary:active { background: var(--primary-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover, .btn-success:active { opacity: 0.9; }
        .btn-secondary { background: var(--gray-100); color: var(--gray-600); }
        .btn-secondary:hover, .btn-secondary:active { background: var(--gray-200); }
        
        /* Tabs */
        .tabs { 
            display: flex; 
            gap: var(--space-2); 
            margin-bottom: var(--space-5); 
            background: white;
            padding: var(--space-2);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow-x: auto;
        }
        
        .tab { 
            padding: var(--space-3) var(--space-5); 
            cursor: pointer; 
            border: none; 
            background: none; 
            font-size: var(--text-sm); 
            color: var(--gray-500); 
            border-radius: var(--radius-md);
            font-weight: 600;
            white-space: nowrap;
            transition: var(--transition);
            min-height: 44px;
        }
        
        .tab.active { 
            color: white; 
            background: var(--primary);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Store Card */
        .store-card { 
            background: white; 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); 
            margin-bottom: var(--space-5); 
            overflow: hidden; 
        }
        
        .store-card-header { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
            color: white; 
            padding: var(--space-5); 
            position: relative; 
        }
        
        .store-card-header h3 { margin: 0 0 var(--space-1) 0; font-size: var(--text-lg); }
        
        .store-status { 
            position: absolute; 
            top: var(--space-4); 
            right: var(--space-4); 
            padding: var(--space-1) var(--space-3); 
            border-radius: var(--radius-full); 
            font-size: var(--text-xs); 
            font-weight: 600; 
        }
        
        .store-status.active { background: var(--success); }
        
        .store-card-body { padding: var(--space-5); }
        
        /* Store Link Box */
        .store-link-box { 
            background: rgba(16, 185, 129, 0.1); 
            border: 2px dashed var(--success); 
            border-radius: var(--radius-md); 
            padding: var(--space-4); 
            margin-bottom: var(--space-4); 
        }
        
        .store-link-box label { 
            font-size: var(--text-sm); 
            color: #166534; 
            font-weight: 600; 
            display: block; 
            margin-bottom: var(--space-2); 
        }
        
        .link-row { display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap; }
        
        .link-row input { 
            flex: 1; 
            min-width: 200px;
            padding: var(--space-3); 
            border: 2px solid var(--gray-200); 
            border-radius: var(--radius-md); 
            font-size: var(--text-sm); 
        }
        
        .copy-btn { 
            background: var(--success); 
            color: white; 
            border: none; 
            padding: var(--space-3) var(--space-4); 
            border-radius: var(--radius-md); 
            cursor: pointer;
            font-weight: 600;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        /* Stats */
        .store-stats { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: var(--space-3); 
            margin-bottom: var(--space-4); 
        }
        
        .stat-box { 
            text-align: center; 
            padding: var(--space-4); 
            background: var(--gray-50); 
            border-radius: var(--radius-md); 
        }
        
        .stat-value { font-size: var(--text-2xl); font-weight: 700; color: var(--primary); display: block; }
        .stat-label { font-size: var(--text-xs); color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Products Table */
        .products-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            border-radius: var(--radius-md); 
            overflow: hidden; 
        }
        
        .products-table th, .products-table td { 
            padding: var(--space-3); 
            text-align: left; 
            border-bottom: 1px solid var(--gray-100); 
            font-size: var(--text-sm);
        }
        
        .products-table th { 
            background: var(--gray-50); 
            font-weight: 600; 
            color: var(--gray-600); 
        }
        
        /* Price Input */
        .price-input { 
            width: 90px; 
            padding: var(--space-2); 
            border: 2px solid var(--gray-200); 
            border-radius: var(--radius-sm); 
            text-align: right;
            font-size: var(--text-sm);
        }
        
        .price-input:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        /* Profit Badge */
        .profit-badge { 
            background: rgba(16, 185, 129, 0.1); 
            color: #166534; 
            padding: var(--space-1) var(--space-2); 
            border-radius: var(--radius-sm); 
            font-size: var(--text-xs); 
            font-weight: 600; 
        }
        
        /* Action Buttons */
        .action-btns button { 
            padding: var(--space-2) var(--space-3); 
            border: none; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: var(--text-xs); 
            font-weight: 600;
            min-height: 36px;
        }
        
        .btn-save { background: var(--success); color: white; }
        .btn-save:hover, .btn-save:active { opacity: 0.9; }
        .btn-remove { background: var(--danger); color: white; }
        
        /* Bundle Grid */
        .bundle-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: var(--space-3); 
            margin-top: var(--space-4); 
        }
        
        .bundle-card { 
            border: 2px solid var(--gray-200); 
            border-radius: var(--radius-md); 
            padding: var(--space-4); 
            cursor: pointer; 
            transition: var(--transition); 
            background: white; 
        }
        
        .bundle-card:hover, .bundle-card:active { 
            border-color: var(--primary); 
            background: var(--gray-50); 
        }
        
        .bundle-card.added { opacity: 0.5; cursor: not-allowed; }
        .bundle-name { font-weight: 600; color: var(--primary); }
        .bundle-details { font-size: var(--text-sm); color: var(--gray-500); margin-top: var(--space-1); }
        .bundle-cost { font-size: var(--text-sm); color: #166534; font-weight: 600; margin-top: var(--space-2); }
        
        /* Modal */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center;
            padding: var(--space-4);
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal { 
            background: white; 
            border-radius: var(--radius-lg); 
            max-width: 500px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header { 
            padding: var(--space-5); 
            border-bottom: 1px solid var(--gray-100); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-header h2 { margin: 0; color: var(--primary); font-size: var(--text-xl); }
        
        .modal-close { 
            background: var(--gray-100); 
            border: none; 
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            font-size: var(--text-xl); 
            cursor: pointer; 
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body { padding: var(--space-5); }
        
        .modal-footer { 
            padding: var(--space-5); 
            border-top: 1px solid var(--gray-100); 
            display: flex; 
            gap: var(--space-3); 
            justify-content: flex-end; 
        }
        
        /* Form Group */
        .form-group { margin-bottom: var(--space-4); }
        .form-group label { display: block; margin-bottom: var(--space-2); font-weight: 600; color: var(--gray-600); font-size: var(--text-sm); }
        
        .form-group input, .form-group textarea { 
            width: 100%; 
            padding: var(--space-3); 
            border: 2px solid var(--gray-200); 
            border-radius: var(--radius-md); 
            box-sizing: border-box;
            font-size: var(--text-base);
            transition: var(--transition);
        }
        
        .form-group input:focus, .form-group textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(242, 193, 46, 0.15);
        }
        
        .form-group small { color: var(--gray-400); font-size: var(--text-xs); display: block; margin-top: var(--space-1); }
        
        /* Empty State */
        .empty-state { 
            text-align: center; 
            padding: var(--space-12) var(--space-5); 
            color: var(--gray-500); 
        }
        
        .empty-state i { font-size: 4rem; color: var(--gray-200); margin-bottom: var(--space-4); display: block; }
        .empty-state h3 { margin: 0 0 var(--space-2) 0; color: var(--gray-600); }
        .empty-state p { margin: 0 0 var(--space-4) 0; }
        
        /* Network Filter */
        .network-filter { 
            display: flex; 
            gap: var(--space-2); 
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
        }
        
        .network-btn { 
            padding: var(--space-2) var(--space-4); 
            border: 2px solid var(--gray-200); 
            border-radius: var(--radius-md); 
            cursor: pointer; 
            background: white;
            font-weight: 600;
            font-size: var(--text-sm);
            min-height: 44px;
            transition: var(--transition);
        }
        
        .network-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary); 
        }
        
        /* Info Box */
        .info-box {
            background: rgba(16, 185, 129, 0.1);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            border-left: 4px solid var(--success);
        }
        
        .info-box p {
            color: #166534;
            margin: 0;
            font-size: var(--text-sm);
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .store-container { padding: var(--space-8) var(--space-5); }
            .page-header { padding: var(--space-8); }
            .page-header h1 { font-size: var(--text-3xl); }
        }
        
        @media (max-width: 768px) { 
            .store-stats { grid-template-columns: repeat(2, 1fr); }
            .store-header { flex-direction: column; align-items: stretch; }
            .store-header h1 { font-size: var(--text-xl); }
            .tabs { flex-wrap: nowrap; }
            .tab { padding: var(--space-2) var(--space-3); font-size: var(--text-xs); }
        }
        
        @media (max-width: 600px) {
            .store-container { padding: var(--space-3) var(--space-2); }
            .page-header { padding: var(--space-4); }
            .page-header h1 { font-size: var(--text-xl); }
            .store-card-header { padding: var(--space-4); }
            .store-card-body { padding: var(--space-4); }
            .link-row { flex-direction: column; }
            .link-row input { width: 100%; min-width: auto; }
            .copy-btn { width: 100%; justify-content: center; }
            .store-stats { gap: var(--space-2); }
            .stat-box { padding: var(--space-3); }
            .stat-value { font-size: var(--text-lg); }
            .products-table { font-size: var(--text-xs); }
            .products-table th, .products-table td { padding: var(--space-2); }
            .modal-footer { flex-direction: column; }
            .modal-footer .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="background">
        <div class="header-container">
            <header>
                <div><a href="../public/dashboard.html"><img src="../public/img/kem.png" alt="KemDataplus" class="logo"></a></div>
                <input type="checkbox" id="check-box">
                <div class="nav-links">
                    <label for="check-box" class="menu-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></label>
                    <div class="nav-menu">
                        <div class="links">
                            <a href="../public/dashboard.html">Dashboard</a>
                            <a href="../public/dashboard.html#buy-bundles">Buy Bundles</a>
                            <a href="./orders.html">Orders</a>
                            <a href="./wallet.html">Wallet</a>
                            <a href="./mystore.html" class="active">My Store</a>
                            <a href="./api.html">API</a>
                            <a href="./profile.html">Profile</a>
                        </div>
                    </div>
                    <div class="profile-dropdown">
                        <img src="../public/img/kem.png" alt="Profile" class="profile-pic" id="profileBtn">
                        <div class="dropdown-menu" id="dropdownMenu">
                            <a href="./profile.html"><i class="fas fa-user"></i> My Profile</a>
                            <a href="./profile.html"><i class="fas fa-cog"></i> Settings</a>
                            <a href="./wallet.html"><i class="fas fa-wallet"></i> Wallet</a>
                            <hr>
                            <a href="#" onclick="logout(); return false;"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                    <label for="check-box" class="close-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></label>
                </div>
            </header>
        </div>
        <div class="store-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-store"></i> My Storefront</h1>
                <p>Create and manage your data bundle store</p>
            </div>
            
            <div id="loadingState" class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>
            <div id="noStoreState" class="empty-state" style="display:none;"><i class="fas fa-store-slash"></i><h3>No Store Yet</h3><p>Create your storefront to start selling!</p><button class="btn btn-primary" onclick="openCreateModal()"><i class="fas fa-plus"></i> Create My Store</button></div>
            <div id="storeContent" style="display:none;">
                <div class="store-card">
                    <div class="store-card-header">
                        <span class="store-status active" id="storeStatus">ACTIVE</span>
                        <h3 id="storeName">My Store</h3>
                        <small id="storeDesc"></small>
                    </div>
                    <div class="store-card-body">
                        <div class="store-link-box">
                            <label><i class="fas fa-link"></i> Your Store Link (Share with customers)</label>
                            <div class="link-row">
                                <input type="text" id="storeLink" readonly>
                                <button class="copy-btn" onclick="copyLink()"><i class="fas fa-copy"></i> Copy</button>
                                <button class="btn btn-success" onclick="shareWhatsApp()"><i class="fab fa-whatsapp"></i></button>
                            </div>
                        </div>
                        <div class="store-stats">
                            <div class="stat-box"><div class="stat-value" id="statViews">0</div><div class="stat-label">Views</div></div>
                            <div class="stat-box"><div class="stat-value" id="statOrders">0</div><div class="stat-label">Orders</div></div>
                            <div class="stat-box"><div class="stat-value" id="statProducts">0</div><div class="stat-label">Products</div></div>
                            <div class="stat-box"><div class="stat-value" id="statRevenue">GHS 0</div><div class="stat-label">Revenue</div></div>
                        </div>
                        <button class="btn btn-secondary" onclick="openEditModal()"><i class="fas fa-edit"></i> Edit Store</button>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" data-tab="products">Bundle Prices</button>
                    <button class="tab" data-tab="orders">Store Orders</button>
                    <button class="tab" data-tab="settings">Payment Settings</button>
                </div>
                <div class="tab-content active" id="products-tab">
                    <div class="info-box">
                        <p><i class="fas fa-info-circle"></i> <strong>All bundles are automatically available in your store.</strong> Set custom selling prices below to make profit. If no price is set, bundles are sold at your cost price.</p>
                    </div>
                    <div class="network-filter" id="priceFilter">
                        <button class="network-btn active" data-network="all">All Networks</button>
                        <button class="network-btn" data-network="MTN">MTN</button>
                        <button class="network-btn" data-network="TELECEL">Telecel</button>
                        <button class="network-btn" data-network="AIRTELTIGO">AirtelTigo</button>
                    </div>
                    <div id="productsEmpty" class="empty-state" style="display:none;"><i class="fas fa-box-open"></i><p>No bundles available.</p></div>
                    <div id="productsContainer"></div>
                </div>
                <div class="tab-content" id="orders-tab">
                    <div id="ordersEmpty" class="empty-state"><i class="fas fa-receipt"></i><p>No orders yet. Share your store link to get customers!</p></div>
                    <table class="products-table" id="ordersTable" style="display:none;">
                        <thead><tr><th>Date</th><th>Customer</th><th>Bundle</th><th>Price</th><th>Your Profit</th><th>Payment</th><th>Status</th></tr></thead>
                        <tbody id="ordersBody"></tbody>
                    </table>
                </div>
                <div class="tab-content" id="settings-tab">
                    <div class="store-card" style="margin-bottom:20px;">
                        <div class="store-card-header" style="padding:15px;">
                            <h3 style="margin:0;"><i class="fas fa-mobile-alt"></i> MoMo Payment Setup</h3>
                        </div>
                        <div class="store-card-body">
                            <p style="color:#64748b;margin-bottom:15px;">Add your MoMo number so customers can pay directly. They'll see payment instructions when ordering.</p>
                            <div class="form-group"><label>MoMo Number *</label><input type="tel" id="momoNumber" placeholder="0241234567" maxlength="10"></div>
                            <div class="form-group"><label>Name on MoMo</label><input type="text" id="momoName" placeholder="e.g., Kofi Mensah"></div>
                            <button class="btn btn-primary" onclick="saveMomoSettings()"><i class="fas fa-save"></i> Save Payment Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="storeModal">
        <div class="modal">
            <div class="modal-header"><h2 id="modalTitle">Create Store</h2><button class="modal-close" onclick="closeModal()">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Store Name *</label><input type="text" id="inputName" placeholder="e.g., Kofi's Data Hub"></div>
                <div class="form-group"><label>Description</label><textarea id="inputDesc" rows="2" placeholder="Best data deals!"></textarea></div>
                <div class="form-group"><label>Contact Phone</label><input type="tel" id="inputPhone" placeholder="0241234567"></div>
                <div class="form-group"><label>WhatsApp</label><input type="tel" id="inputWhatsapp" placeholder="0241234567"><small>Customers can message you</small></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" id="saveStoreBtn" onclick="saveStore()">Create Store</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="priceModal">
        <div class="modal">
            <div class="modal-header"><h2>Set Selling Price</h2><button class="modal-close" onclick="closePriceModal()">&times;</button></div>
            <div class="modal-body">
                <div id="selectedBundleInfo"></div>
                <div class="form-group"><label>Your Cost Price</label><input type="text" id="priceCost" readonly style="background:#f8fafc;"></div>
                <div class="form-group"><label>Your Selling Price *</label><input type="number" id="priceSellingInput" step="0.01"><small>Must be ≥ cost. Profit = Selling - Cost</small></div>
                <div class="form-group"><label>Your Profit per Sale</label><input type="text" id="priceProfit" readonly style="background:#dcfce7;color:#166534;font-weight:600;"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closePriceModal()">Cancel</button><button class="btn btn-primary" onclick="confirmSetPrice()"><i class="fas fa-save"></i> Save Price</button></div>
        </div>
    </div>
    <script>
        const API='/api';let store=null,products=[],selectedBundle=null,storeOrders=[],currentFilter='all';
        async function checkAuth(){try{const r=await fetch(API+'/auth/me',{credentials:'include'});return r.ok}catch(e){return false}}
        function logout(){localStorage.removeItem('currentUser');window.location.href='login.html'}
        async function api(e,o={}){const r=await fetch(API+e,{...o,credentials:'include',headers:{'Content-Type':'application/json',...o.headers}});return 401===r.status&&logout(),r}
        async function loadStore(){try{const e=await api('/storefronts'),o=await e.json();document.getElementById('loadingState').style.display='none',0===o.length?(document.getElementById('noStoreState').style.display='block',document.getElementById('createStoreBtn').style.display='inline-flex'):(store=o[0],document.getElementById('noStoreState').style.display='none',document.getElementById('createStoreBtn').style.display='none',document.getElementById('storeContent').style.display='block',renderStore(),loadProducts(),loadOrders())}catch(e){document.getElementById('loadingState').innerHTML='<i class="fas fa-exclamation-triangle" style="color:#ef4444"></i><p>Failed to load</p>'}}
        function renderStore(){document.getElementById('storeName').textContent=store.name,document.getElementById('storeDesc').textContent=store.description||'',document.getElementById('storeStatus').textContent=store.status,document.getElementById('storeLink').value=window.location.origin+'/store/'+store.slug,document.getElementById('statViews').textContent=store.viewCount||0,document.getElementById('statOrders').textContent=store._count?.orders||store.totalOrders||0,document.getElementById('statProducts').textContent=products.length||'All',document.getElementById('statRevenue').textContent='GHS '+(store.totalRevenue||0).toFixed(2);
            document.getElementById('momoNumber').value=store.momoNumber||'';document.getElementById('momoName').value=store.momoName||'';
        }
        async function loadProducts(){const e=await api('/storefronts/'+store.id+'/products');products=await e.json();
            // Sort products by dataAmount (ascending)
            products.sort((a,b)=>{
                const getGB=str=>{const m=(str||'').match(/(\d+)/);return m?parseInt(m[1]):0;};
                return getGB(a.bundle.dataAmount)-getGB(b.bundle.dataAmount);
            });
            document.getElementById('statProducts').textContent=products.length;renderProducts();}
        
        function parseDataAmount(str){const m=(str||'').match(/(\d+)/);return m?parseInt(m[1]):0;}
        
        function renderProducts(filter='all'){
            currentFilter=filter;
            const container=document.getElementById('productsContainer');
            const empty=document.getElementById('productsEmpty');
            const filtered=filter==='all'?products:products.filter(p=>p.bundle.network===filter);
            
            if(filtered.length===0){empty.style.display='block';container.innerHTML='';return;}
            empty.style.display='none';
            
            // Group by network
            const networks=['MTN','TELECEL','AIRTELTIGO'];
            const grouped={};
            networks.forEach(n=>grouped[n]=[]);
            filtered.forEach(p=>{if(grouped[p.bundle.network])grouped[p.bundle.network].push(p);});
            
            // Sort each group by dataAmount ascending
            Object.keys(grouped).forEach(n=>{
                grouped[n].sort((a,b)=>parseDataAmount(a.bundle.dataAmount)-parseDataAmount(b.bundle.dataAmount));
            });
            
            let html='';
            networks.forEach(network=>{
                if(grouped[network].length===0)return;
                const networkName=network==='TELECEL'?'Telecel':network==='AIRTELTIGO'?'AirtelTigo':network;
                const color=network==='MTN'?'#ffc107':network==='TELECEL'?'#e60000':'#003366';
                html+=`<div style="margin-bottom:25px;"><h3 style="color:${color};margin-bottom:12px;padding:10px;background:#f8fafc;border-radius:8px;border-left:4px solid ${color};"><i class="fas fa-signal"></i> ${networkName} Bundles (${grouped[network].length})</h3>`;
                html+=`<table class="products-table" style="display:table;"><thead><tr><th>Bundle</th><th>Data</th><th>Validity</th><th>Your Cost</th><th>Selling Price</th><th>Profit</th><th>Actions</th></tr></thead><tbody>`;
                grouped[network].forEach(e=>{
                    const profit=(e.profit||0).toFixed(2);
                    const profitColor=parseFloat(profit)>0?'#166534':'#666';
                    html+=`<tr data-bundle="${e.bundleId}"><td><strong>${e.displayName||e.bundle.name}</strong></td><td>${e.bundle.dataAmount}</td><td>${e.bundle.validity}</td><td>GHS ${e.costPrice.toFixed(2)}</td><td style="font-weight:600;color:#166534;">GHS ${(e.sellingPrice||e.costPrice).toFixed(2)}</td><td><span class="profit-badge" style="background:${parseFloat(profit)>0?'#dcfce7':'#f3f4f6'};color:${profitColor}">GHS ${profit}</span></td><td class="action-btns"><button class="btn-save" onclick="openPriceModal('${e.bundleId}')"><i class="fas fa-edit"></i> Set Price</button></td></tr>`;
                });
                html+=`</tbody></table></div>`;
            });
            container.innerHTML=html;
        }
        
        async function loadOrders(){try{const e=await api('/storefronts/'+store.id+'/orders');storeOrders=await e.json(),renderOrders()}catch(e){console.error('Failed to load orders:',e)}}
        function renderOrders(){const e=document.getElementById('ordersBody'),o=document.getElementById('ordersTable'),t=document.getElementById('ordersEmpty');0===storeOrders.length?(o.style.display='none',t.style.display='block'):(o.style.display='table',t.style.display='none',e.innerHTML=storeOrders.map(o=>{const d=new Date(o.createdAt).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}),s=o.status==='COMPLETED'?'#22c55e':o.status==='PENDING'?'#f59e0b':'#ef4444',ps=o.paymentStatus==='PAID'?'#22c55e':'#f59e0b';return'<tr><td>'+d+'</td><td><strong>'+(o.customerName||'Customer')+'</strong><br><small>'+o.customerPhone+'</small></td><td>'+o.bundle.name+'<br><small>'+o.bundle.network+' • '+o.bundle.dataAmount+'</small></td><td>GHS '+o.amount.toFixed(2)+'</td><td><span class="profit-badge">GHS '+o.ownerProfit.toFixed(2)+'</span></td><td><span style="color:'+ps+';font-weight:500">'+(o.paymentStatus||'PENDING')+'</span><br><small>'+(o.paymentReference||'-')+'</small></td><td><span style="color:'+s+';font-weight:600">'+o.status+'</span></td></tr>'}).join(''))}
        
        function openPriceModal(bundleId){selectedBundle=products.find(p=>p.bundleId===bundleId);if(!selectedBundle)return;document.getElementById('selectedBundleInfo').innerHTML='<div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:15px"><strong>'+selectedBundle.bundle.name+'</strong><br><small>'+selectedBundle.bundle.network+' • '+selectedBundle.bundle.dataAmount+' • '+selectedBundle.bundle.validity+'</small></div>',document.getElementById('priceCost').value='GHS '+selectedBundle.costPrice.toFixed(2),document.getElementById('priceSellingInput').value=(selectedBundle.sellingPrice||selectedBundle.costPrice).toFixed(2),document.getElementById('priceSellingInput').min=selectedBundle.costPrice,document.getElementById('priceProfit').value='GHS '+(selectedBundle.profit||0).toFixed(2),document.getElementById('priceModal').classList.add('active'),document.getElementById('priceSellingInput').oninput=function(){document.getElementById('priceProfit').value='GHS '+(parseFloat(this.value)-selectedBundle.costPrice).toFixed(2)}}
        function closePriceModal(){document.getElementById('priceModal').classList.remove('active'),selectedBundle=null}
        async function confirmSetPrice(){const sellingPrice=parseFloat(document.getElementById('priceSellingInput').value);if(sellingPrice<selectedBundle.costPrice)return alert('Price cannot be less than cost (GHS '+selectedBundle.costPrice.toFixed(2)+')');const btn=document.querySelector('#priceModal .btn-primary');btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';const r=await api('/storefronts/'+store.id+'/prices/'+selectedBundle.bundleId,{method:'PUT',body:JSON.stringify({sellingPrice})});if(r.ok){closePriceModal();loadProducts();}else{alert((await r.json()).error);}btn.disabled=false;btn.innerHTML='<i class="fas fa-save"></i> Save Price';}
        
        async function saveMomoSettings(){const momoNumber=document.getElementById('momoNumber').value.trim(),momoName=document.getElementById('momoName').value.trim();if(!momoNumber)return alert('Please enter your MoMo number');const r=await api('/storefronts/'+store.id,{method:'PUT',body:JSON.stringify({momoNumber,momoName})});if(r.ok){store.momoNumber=momoNumber;store.momoName=momoName;alert('Payment settings saved!');}else{alert((await r.json()).error);}}
        
        function openCreateModal(){document.getElementById('modalTitle').textContent='Create Store',document.getElementById('saveStoreBtn').textContent='Create Store',document.getElementById('inputName').value='',document.getElementById('inputDesc').value='',document.getElementById('inputPhone').value='',document.getElementById('inputWhatsapp').value='',document.getElementById('storeModal').classList.add('active')}
        function openEditModal(){document.getElementById('modalTitle').textContent='Edit Store',document.getElementById('saveStoreBtn').textContent='Save Changes',document.getElementById('inputName').value=store.name||'',document.getElementById('inputDesc').value=store.description||'',document.getElementById('inputPhone').value=store.contactPhone||'',document.getElementById('inputWhatsapp').value=store.contactWhatsapp||'',document.getElementById('storeModal').classList.add('active')}
        function closeModal(){document.getElementById('storeModal').classList.remove('active')}
        async function saveStore(){const e={name:document.getElementById('inputName').value.trim(),description:document.getElementById('inputDesc').value.trim(),contactPhone:document.getElementById('inputPhone').value.trim(),contactWhatsapp:document.getElementById('inputWhatsapp').value.trim()};if(!e.name)return alert('Store name required');const o=document.getElementById('saveStoreBtn');o.disabled=!0,o.textContent='Saving...';const t=null!==store,r=await api(t?'/storefronts/'+store.id:'/storefronts',{method:t?'PUT':'POST',body:JSON.stringify(e)}),n=await r.json();r.ok?(closeModal(),t||alert('Store created!\\n\\nYour link:\\n'+window.location.origin+'/store/'+n.slug),loadStore()):alert(n.error),o.disabled=!1,o.textContent=t?'Save Changes':'Create Store'}
        function copyLink(){navigator.clipboard.writeText(document.getElementById('storeLink').value),alert('Link copied!')}
        function shareWhatsApp(){window.open('https://wa.me/?text='+encodeURIComponent('Check out my data store! '+document.getElementById('storeLink').value),'_blank')}
        document.querySelectorAll('.tab').forEach(e=>e.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')),document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')),e.classList.add('active'),document.getElementById(e.dataset.tab+'-tab').classList.add('active')}));
        document.getElementById('priceFilter').addEventListener('click',e=>{if(e.target.classList.contains('network-btn')){document.querySelectorAll('#priceFilter .network-btn').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');renderProducts(e.target.dataset.network);}});
        (async()=>{if(await checkAuth()){loadStore()}else{window.location.href='login.html?redirect=mystore.html'}})();
    </script>
</body>
</html>
